<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Vota Con La Chola | Explorador de Votaciones</title>
    <link rel="icon" href="data:," />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <style>
      :root {
        --ink: #0b1220;
        --ink-soft: #334155;
        --ink-faint: #5f6f82;
        --bg-a: #f3f8ff;
        --bg-b: #f9fbff;
        --panel: #ffffff;
        --panel-soft: #eef4ff;
        --line: rgba(15, 23, 42, 0.12);
        --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.12);
        --accent: #1d4ed8;
        --accent-2: #0891b2;
        --ok: #059669;
        --warn: #d97706;
      }

      :root {
        color-scheme: light;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        min-height: 100%;
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        color: var(--ink);
        background: radial-gradient(940px 420px at 12% -8%, #dbeafe 0%, transparent 65%), radial-gradient(1000px 520px at 88% 12%, #d8e1ff 0%, transparent 60%), linear-gradient(130deg, var(--bg-a), var(--bg-b));
        line-height: 1.4;
        font-size: 16.5px;
      }

      .app {
        min-height: 100vh;
        padding: 14px;
        display: grid;
        gap: 12px;
        max-width: 1480px;
        margin: 0 auto;
        width: min(100%, 1480px);
      }

      .topbar {
        border: 1px solid var(--line);
        border-radius: 18px;
        background: linear-gradient(145deg, #ffffff, #f8fbff);
        box-shadow: var(--shadow-soft);
        padding: 14px;
        position: relative;
      }

      .eyebrow {
        margin: 0;
        letter-spacing: 0.13em;
        color: #1d4ed8;
        text-transform: uppercase;
        font-weight: 700;
        font-size: 0.72rem;
      }

      h1 {
        margin: 8px 0 3px;
        font-size: 1.82rem;
      }

      p {
        margin: 0;
      }

      .subtitle {
        color: var(--ink-soft);
        max-width: 95ch;
      }

      .about {
        color: var(--ink-faint);
      }

      .layout {
        display: grid;
        gap: 12px;
        grid-template-columns: 340px 1fr;
        align-items: start;
      }

      .summary-strip {
        margin-top: 8px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      .summary-strip .chip {
        border: 1px solid rgba(15, 23, 42, 0.16);
        border-radius: 999px;
        padding: 5px 10px;
        font-size: 0.74rem;
        background: #f8fafc;
        color: var(--ink-soft);
      }

      .summary-strip .chip strong {
        color: var(--ink);
        margin-left: 3px;
      }

      .panel {
        border: 1px solid var(--line);
        border-radius: 16px;
        background: var(--panel);
        box-shadow: var(--shadow-soft);
        padding: 12px;
        display: flex;
        flex-direction: column;
        position: sticky;
        top: 10px;
      }

      .panel h3,
      .content h2 {
        margin: 0 0 8px;
      }

      .panel-intro {
        color: var(--ink-faint);
        margin: 0 0 10px;
        font-size: 0.84rem;
      }

      .filters {
        display: grid;
        gap: 8px;
      }

      .field {
        display: grid;
        gap: 5px;
      }

      .filters .field label {
        display: block;
        font-size: 0.73rem;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: #475569;
        margin-bottom: 4px;
        font-weight: 600;
      }

      .filters input,
      .filters select,
      .filters button {
        width: 100%;
        border-radius: 10px;
        border: 1px solid rgba(15, 23, 42, 0.18);
        background: #ffffff;
        color: var(--ink);
        padding: 8px 10px;
        font-size: 0.92rem;
      }

      .filters input:focus,
      .filters select:focus {
        outline: 2px solid rgba(29, 78, 216, 0.2);
        border-color: var(--accent);
      }

      .filter-help {
        margin-top: 8px;
        border-radius: 10px;
        border: 1px dashed rgba(15, 23, 42, 0.2);
        padding: 8px;
        color: #334155;
        background: #fafcff;
      }

      .filter-help strong {
        color: #0f172a;
      }

      .toggle-row {
        display: grid;
        gap: 6px;
        grid-template-columns: 1fr 1fr;
      }

      .toggle-row button {
        cursor: pointer;
        font-weight: 700;
        transition: transform 120ms ease, filter 120ms ease;
      }

      .toggle-row button.active {
        border-color: #1d4ed8;
        background: linear-gradient(130deg, #5e72ff, #7f5cff);
        color: #fff;
      }

      .toolbar {
        display: grid;
        gap: 8px;
        margin-top: 4px;
      }

      .toolbar button {
        background: linear-gradient(130deg, #f97316, #fb923c);
        border-color: transparent;
        color: #fff;
        font-weight: 700;
      }

      #clear-filters {
        background: linear-gradient(130deg, #334155, #475569);
      }

      .content {
        border-radius: 16px;
        border: 1px solid var(--line);
        background: var(--panel);
        box-shadow: var(--shadow-soft);
        min-width: 0;
      }

      .content-header {
        padding: 10px 11px;
        border-bottom: 1px solid var(--line);
        display: flex;
        justify-content: space-between;
        gap: 9px;
        align-items: baseline;
        position: sticky;
        top: 0;
        background: rgba(255, 255, 255, 0.96);
        z-index: 2;
      }

      .content-body {
        padding: 11px;
        max-height: calc(100vh - 190px);
        overflow: auto;
      }

      .stats-wrap {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(4, minmax(130px, 1fr));
        gap: 8px;
        flex: 1;
      }

      .stat {
        padding: 9px 10px;
        border: 1px solid rgba(15, 23, 42, 0.13);
        border-radius: 10px;
        background: #f8fbff;
      }

      .stat strong {
        display: block;
        color: #1d4ed8;
        font-size: 1.13rem;
        margin-top: 4px;
      }

      .active-chip-box {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
      }

      .active-chip-box label {
        font-size: 0.72rem;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: #64748b;
      }

      .active-chip {
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 0.74rem;
        border: 1px solid #cbd5e1;
        background: #ffffff;
        display: inline-flex;
        gap: 8px;
        align-items: center;
      }

      .active-chip .label {
        color: #475569;
      }

      .active-chip .value {
        color: #111827;
        font-weight: 600;
      }

      .vote-card {
        border: 1px solid rgba(15, 23, 42, 0.12);
        border-radius: 12px;
        padding: 7px;
        margin-top: 6px;
        background: linear-gradient(170deg, rgba(248, 250, 255, 0.95), rgba(235, 244, 255, 0.88));
        box-shadow: 0 6px 14px rgba(15, 23, 42, 0.06);
      }

      .vote-card h3 {
        margin: 0;
        font-size: 0.9rem;
      }

      .vote-title {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 8px;
      }

      .vote-title h3 {
        margin: 0;
      }

      .vote-title .topic-tag {
        font-size: 0.72rem;
        border-radius: 999px;
        border: 1px solid #bfdbfe;
        background: #eff6ff;
        color: #1e40af;
        padding: 2px 8px;
        white-space: nowrap;
        align-self: flex-start;
      }

      .vote-title .topic-tag a {
        color: inherit;
        text-decoration: underline;
        text-underline-offset: 2px;
      }

      .vote-about {
        margin-top: 4px;
        padding: 6px 8px;
        border-radius: 10px;
        border: 1px solid rgba(15, 23, 42, 0.1);
        background: rgba(255, 255, 255, 0.72);
      }

      .compact-mode .vote-about {
        padding: 4px 6px;
        margin-top: 3px;
      }

      .vote-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 4px;
      }

      .pill {
        border: 1px solid rgba(15, 23, 42, 0.18);
        border-radius: 999px;
        padding: 3px 8px;
        font-size: 0.7rem;
        background: rgba(255, 255, 255, 0.95);
      }

      .small {
        color: #475569;
        font-size: 0.8rem;
      }

      .vote-source {
        margin-top: 5px;
        display: flex;
        gap: 8px;
        align-items: baseline;
        flex-wrap: wrap;
      }

      .vote-source a {
        color: #1e40af;
        text-decoration: underline;
        text-underline-offset: 2px;
        font-weight: 600;
        font-size: 0.66rem;
        word-break: break-all;
      }

      .vote-groups {
        margin-top: 6px;
        display: grid;
        gap: 4px;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        align-items: start;
      }

      .group-row-wrap {
        border: 1px dashed rgba(15, 23, 42, 0.13);
        border-radius: 10px;
        padding: 4px;
        min-width: 0;
      }

      .group-row {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 8px;
        padding: 5px 7px;
        border: 1px solid rgba(15, 23, 42, 0.11);
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.82);
      }

      .group-name {
        font-weight: 600;
        color: #0f172a;
      }

      .vote-bars {
        margin-top: 8px;
        display: grid;
        gap: 6px;
      }

      .vote-bar {
        height: 11px;
        border-radius: 999px;
        background: rgba(148, 163, 184, 0.25);
        overflow: hidden;
      }

      .vote-bar-fill {
        height: 100%;
        transition: width 220ms ease;
      }

      .vote-bar-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 4px;
      }

      .vote-bar-label {
        font-size: 0.68rem;
        color: #334155;
      }

      .vote-stats-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(80px, 1fr));
        gap: 6px;
      }

      .smallstat {
        border: 1px solid rgba(15, 23, 42, 0.15);
        border-radius: 9px;
        background: rgba(255, 255, 255, 0.86);
        padding: 6px 8px;
      }

      .smallstat strong {
        display: block;
        color: #0f172a;
        margin-top: 2px;
      }

      .hint {
        margin-top: 8px;
        color: #64748b;
      }

      .loading,
      .error {
        border: 1px solid rgba(15, 23, 42, 0.14);
        border-radius: 10px;
        background: rgba(243, 246, 255, 0.9);
        padding: 8px;
      }

      .error {
        border-color: #fecaca;
        background: #fef2f2;
      }

      .muted {
        color: #64748b;
      }

      .footer {
        margin-top: 10px;
        display: flex;
        gap: 8px;
        justify-content: space-between;
        align-items: center;
      }

      .footer span {
        font-size: 0.8rem;
        color: #475569;
      }

      @media (max-width: 1080px) {
        .layout {
          grid-template-columns: 1fr;
        }

        .content-body {
          max-height: none;
        }

        .stats {
          grid-template-columns: repeat(2, minmax(140px, 1fr));
        }

        .vote-stats-grid {
          grid-template-columns: repeat(2, minmax(80px, 1fr));
        }

        .vote-groups {
          grid-template-columns: 1fr;
        }
      }

      .compact-mode .content-body {
        padding: 8px;
      }

      .compact-mode .vote-card {
        padding: 6px;
      }

      .compact-mode .vote-title .topic-tag {
        font-size: 0.64rem;
        padding: 1px 6px;
      }

      .compact-mode .vote-card h3 {
        font-size: 0.85rem;
      }

      .compact-mode .small,
      .compact-mode .vote-bar-label,
      .compact-mode .pill {
        font-size: 0.66rem;
      }

      .compact-mode .about {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
      }

      .compact-mode .vote-meta {
        gap: 3px;
      }

      .compact-mode .vote-bar {
        height: 8px;
      }

      .compact-mode .group-row-wrap {
        border-style: solid;
        padding: 4px 6px;
        background: rgba(255, 255, 255, 0.65);
      }

      .compact-mode .group-row {
        border: 0;
        background: transparent;
        padding: 0;
      }

      .compact-mode .vote-groups {
        gap: 3px;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      }

      .compact-mode .group-name {
        font-size: 0.78rem;
      }

      .compact-mode .vote-bars {
        margin-top: 3px;
        gap: 3px;
      }

      .compact-mode .vote-bar-legend {
        display: none;
      }

      .compact-mode .pill {
        padding: 2px 6px;
        font-size: 0.64rem;
        line-height: 1.15;
      }

      .compact-mode .coverage {
        display: none;
      }

      .compact-mode .vote-stats-grid {
        gap: 4px;
        grid-template-columns: repeat(4, minmax(62px, 1fr));
      }

      .compact-mode .smallstat {
        padding: 5px 6px;
      }

      .compact-mode .vote-card + .vote-card {
        margin-top: 5px;
      }

      .compact-mode .stat {
        padding: 7px 8px;
      }

      .compact-mode .stat strong {
        margin-top: 2px;
      }

      .compact-mode .vote-title {
        gap: 6px;
      }

      .compact-mode .panel,
      .compact-mode .content {
        border-width: 1px;
      }

      .compact-mode .compact-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .compact-mode .compact-toggle input[type="checkbox"] {
        margin: 0;
      }

      .superheader {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 8px;
        margin-bottom: 8px;
        flex-wrap: wrap;
      }

      .superlink {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: 1px solid #d0def8;
        background: #eff6ff;
        border-radius: 999px;
        padding: 6px 10px;
        color: #102a5c;
        text-decoration: none;
        font-size: 0.82rem;
        font-weight: 700;
      }

      .superlink svg {
        width: 16px;
        height: 16px;
        fill: currentColor;
        flex: 0 0 auto;
      }
    </style>
  </head>
  <body>
      <main class="app">
        <div class="superheader">
          <a class="superlink" href="../">← Índice</a>
          <a
            class="superlink"
            href="https://github.com/gsusI/vota-con-la-chola"
            target="_blank"
            rel="noopener noreferrer"
            aria-label="Ver el código en GitHub"
          >
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/>
            </svg>
            Ver el código
          </a>
        </div>
      <header class="topbar">
        <p class="eyebrow">Explorer 2.0</p>
        <h1>Explorador de votaciones</h1>
        <p class="subtitle">Consulta votaciones parlamentarias, filtros por fuente, búsqueda y desglose por grupos de forma clara y legible.</p>
        <div class="summary-strip" id="summary-strip" aria-live="polite">
          <span class="chip">Estado: <strong>cargando</strong></span>
          <span class="chip">Fuente: <strong>Todas</strong></span>
          <span class="chip">Texto: <strong>Sin filtro</strong></span>
          <span class="chip">Partido: <strong>Sin filtro</strong></span>
        </div>
      </header>

      <section class="layout">
        <aside class="panel">
          <h3>Filtros</h3>
          <p class="panel-intro">Ajusta el alcance de análisis. Los cambios en filtros se reflejan al pulsar “Aplicar filtros”.</p>
          <div class="filters">
            <div class="field">
              <label for="source">Fuente</label>
              <select id="source"></select>
            </div>

            <div class="field">
              <label for="search">Buscar título o expediente</label>
              <input id="search" type="search" placeholder="Ej: Real decreto, Presupuesto, etc." />
            </div>

            <div class="field">
              <label for="party">Partido / ID de grupo</label>
              <input id="party" type="text" placeholder="Ej: pp, psoe, __sin_partido__" />
            </div>

            <div class="field">
              <label for="limit">Elementos por página</label>
              <select id="limit">
                <option value="8">8</option>
                <option value="12" selected>12</option>
                <option value="16">16</option>
                <option value="24">24</option>
              </select>
            </div>
            <div class="field compact-toggle">
              <label for="compact-mode">
                <input id="compact-mode" type="checkbox" checked />
                Vista compacta
              </label>
            </div>

            <div class="toolbar">
              <button id="apply-filters">Aplicar filtros</button>
              <button id="clear-filters" class="secondary">Limpiar</button>
            </div>
          </div>

          <div class="filter-help">
            Tip: usa <strong>__sin_partido__</strong> para votos sin grupo y <strong>__otros__</strong> para bloque agregado.
          </div>
        </aside>

        <section class="content">
          <div class="content-header">
            <div>
              <h2 style="margin: 0; font-size: 1.05rem">Resultados</h2>
              <p class="small muted" id="pager-label">Página 1</p>
            </div>
            <div class="active-chip-box" id="active-chip-box" aria-live="polite"></div>
            <div class="toggle-row">
              <button id="prev-page">Anterior</button>
              <button id="next-page">Siguiente</button>
            </div>
          </div>

          <div class="content-body">
            <div class="stats-wrap">
              <div class="stats" id="stats" aria-live="polite"></div>
            </div>
            <div id="events" style="margin-top: 10px"></div>
            <div id="loading" class="loading hint" style="display: none">Cargando votaciones...</div>
            <p id="message" class="hint">Ajusta filtros y pulsa "Aplicar filtros".</p>
            <div class="footer">
              <span id="range-label" class="muted"></span>
              <span id="debug-label" class="muted"></span>
            </div>
          </div>
        </section>
      </section>
    </main>

    <script>
      const state = {
        source: "all",
        search: "",
        party: "",
        limit: 12,
        compact: true,
        offset: 0,
      };

      const APP_QUERY = new URLSearchParams(window.location.search);
      const API_BASE_OVERRIDE = (APP_QUERY.get("api") || "").trim();
      const STATIC_DATA_DIR = "data";
      const STATIC_VOTES_PATH = `${STATIC_DATA_DIR}/votes-preview.json`;

      const isLocalApiHost = (() => {
        const host = window.location.hostname;
        return host === "localhost" || host === "127.0.0.1" || host === "::1" || host === "0.0.0.0";
      })();

      const resolveApiPath = (path) => {
        const endpoint = String(path || "").trim();
        if (!endpoint) return "";
        const normalized = endpoint.startsWith("/") ? endpoint : `/${endpoint}`;
        if (API_BASE_OVERRIDE) {
          const base = API_BASE_OVERRIDE.endsWith("/") ? API_BASE_OVERRIDE.slice(0, -1) : API_BASE_OVERRIDE;
          return `${base}${normalized}`;
        }
        if (isLocalApiHost) return normalized;
        return "";
      };

      const readJson = async (url) => {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
      };

      let staticSnapshot = null;
      const ensureStaticSnapshot = async () => {
        if (staticSnapshot) return staticSnapshot;
        staticSnapshot = await readJson(STATIC_VOTES_PATH);
        return staticSnapshot;
      };

      const partyColors = {
        psoe: "#e30613",
        pp: "#0058a6",
        vox: "#3a8f5f",
        "unidas podemos": "#752f7c",
        "sumar": "#5f2d83",
        ciudadanos: "#ffcb05",
        pnc: "#ff6f00",
        pnv: "#009a44",
        bng: "#ffd230",
        bildu: "#5db14a",
        otros: "#64748b",
      };

      // Congreso group codes -> widely known labels + habitual colors (best-effort).
      const GROUP_META = {
        GS: { label: "Grupo Socialista (PSOE)", color: "#e30613" },
        GP: { label: "Grupo Popular (PP)", color: "#0058a6" },
        GVOX: { label: "Grupo VOX", color: "#3a8f5f" },
        GSUMAR: { label: "Grupo Plurinacional SUMAR", color: "#e6007e" },
        GUP: { label: "Grupo Confederal (Unidas Podemos)", color: "#752f7c" },
        GMIXTO: { label: "Grupo Mixto", color: "#64748b" },
        GM: { label: "Grupo Mixto", color: "#64748b" },
        GEAJPNV: { label: "Grupo Vasco (EAJ-PNV)", color: "#009a44" },
        GPNV: { label: "Grupo Vasco (EAJ-PNV)", color: "#009a44" },
        GERC: { label: "Grupo Republicano (ERC)", color: "#f6c000" },
        GREP: { label: "Grupo Republicano (ERC)", color: "#f6c000" },
        GEHBILDU: { label: "EH Bildu", color: "#5db14a" },
        GBILDU: { label: "EH Bildu", color: "#5db14a" },
        GBNG: { label: "BNG", color: "#ffd230" },
        GBNG: { label: "BNG", color: "#ffd230" },
        GJUNTS: { label: "Junts", color: "#00a3c7" },
        GJXCAT: { label: "Junts", color: "#00a3c7" },
        GCC: { label: "Coalicion Canaria", color: "#ffd200" },
        GUPN: { label: "UPN", color: "#2f6db3" },
      };

      const refs = {
        source: document.getElementById("source"),
        search: document.getElementById("search"),
        party: document.getElementById("party"),
        limit: document.getElementById("limit"),
        compact: document.getElementById("compact-mode"),
        prev: document.getElementById("prev-page"),
        next: document.getElementById("next-page"),
        apply: document.getElementById("apply-filters"),
        clear: document.getElementById("clear-filters"),
        events: document.getElementById("events"),
        loading: document.getElementById("loading"),
        message: document.getElementById("message"),
        stats: document.getElementById("stats"),
        summaryStrip: document.getElementById("summary-strip"),
        activeChips: document.getElementById("active-chip-box"),
        pagerLabel: document.getElementById("pager-label"),
        rangeLabel: document.getElementById("range-label"),
        debugLabel: document.getElementById("debug-label"),
      };

      const safeText = (value) => (value == null ? "" : String(value));
      const safeNumber = (value, fallback = 0) => {
        const n = Number(value);
        return Number.isFinite(n) ? n : fallback;
      };

      const normalize = (value) => safeText(value).toLowerCase().normalize("NFKD").replace(/[\\u0300-\\u036f]/g, "").trim();

      const escapeHtml = (value) => {
        return safeText(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#039;");
      };

      const formatDate = (value) => {
        if (!value) return "Sin fecha";
        const parsed = new Date(value);
        if (Number.isNaN(parsed.getTime())) return safeText(value);
        return parsed.toLocaleDateString("es-ES", {
          day: "2-digit",
          month: "long",
          year: "numeric",
        });
      };

      const formatNumber = (value) => {
        const n = safeNumber(value);
        return new Intl.NumberFormat("es-ES").format(n);
      };

      const updateSummaryStrip = (meta = {}, activeParty = "") => {
        const source = sourceDisplayName(state.source);
        const sourceText = safeText(state.source) === "all" ? "Todas" : source;
        const searchText = state.search || "Sin filtro";
        const partyText = activeParty || "Sin filtro";
        const total = safeNumber(meta.total, 0);
        const returned = safeNumber(meta.returned, 0);
        refs.summaryStrip.innerHTML = `
          <span class="chip">Fuente: <strong>${escapeHtml(sourceText)}</strong></span>
          <span class="chip">Texto: <strong>${escapeHtml(searchText)}</strong></span>
          <span class="chip">Partido: <strong>${escapeHtml(partyText)}</strong></span>
          <span class="chip">Total: <strong>${formatNumber(total)}</strong></span>
          <span class="chip">Mostradas: <strong>${formatNumber(returned)}</strong></span>
        `;
      };

      const updateActiveChips = () => {
        const hasSearch = state.search.trim().length > 0;
        const hasParty = state.party.trim().length > 0;
        const activeSource = state.source === "all" ? null : sourceDisplayName(state.source);
        const chipRows = [];
        if (activeSource) {
          chipRows.push(`<span class="active-chip"><span class="label">Fuente</span><span class="value">${escapeHtml(activeSource)}</span></span>`);
        }
        if (hasSearch) {
          chipRows.push(`<span class="active-chip"><span class="label">Texto</span><span class="value">${escapeHtml(state.search)}</span></span>`);
        }
        if (hasParty) {
          chipRows.push(`<span class="active-chip"><span class="label">Partido</span><span class="value">${escapeHtml(state.party)}</span></span>`);
        }
        if (!chipRows.length) {
          chipRows.push(`<span class="active-chip"><span class="label">Estado</span><span class="value">Sin filtros activos</span></span>`);
        }
        refs.activeChips.innerHTML = `<label>Filtros aplicados:</label>${chipRows.join("")}`;
      };

      const choiceLabel = (choice = "") => {
        const v = normalize(choice);
        if (v === "yes") return "Sí";
        if (v === "no") return "No";
        if (v === "abstain") return "Abstención";
        if (v === "no_vote") return "No vota";
        if (!v) return "Sin voto";
        return safeText(choice);
      };

      const partyColor = (name = "") => {
        const key = normalize(name);
        if (!key) return partyColors.otros;
        // Exact group-code match first (e.g. "GS", "GP", "GVOX").
        const groupKey = safeText(name).toUpperCase().replace(/[^A-Z0-9]/g, "");
        if (GROUP_META[groupKey]?.color) return GROUP_META[groupKey].color;
        for (const [prefix, color] of Object.entries(partyColors)) {
          if (key.includes(prefix)) {
            return color;
          }
        }
        return "#4f46e5";
      };

      const normalizeGroupCode = (value) => safeText(value).toUpperCase().replace(/[^A-Z0-9]/g, "");

      const resolveGroup = (groupCode) => {
        const codeRaw = safeText(groupCode) || "";
        const code = normalizeGroupCode(codeRaw);
        const meta = GROUP_META[code];
        if (meta) {
          return { code: codeRaw || code, label: meta.label, color: meta.color };
        }
        // Fallback: show raw code as label.
        return { code: codeRaw || code || "Sin grupo", label: codeRaw || code || "Sin grupo", color: partyColor(codeRaw || code) };
      };

      const fetchJson = async (url) => {
        const response = await fetch(url);
        const payload = await response.json();
        if (!response.ok) {
          throw new Error(payload?.error || `HTTP ${response.status}`);
        }
        return payload;
      };

      const syncStateUrl = () => {
        const p = new URLSearchParams();
        if (API_BASE_OVERRIDE) {
          p.set("api", API_BASE_OVERRIDE);
        }
        if (state.source && state.source !== "all") {
          p.set("source", state.source);
        }
        if (state.search) {
          p.set("q", state.search);
        }
        if (state.party) {
          p.set("party", state.party);
        }
        if (state.limit) {
          p.set("limit", String(state.limit));
        }
        if (!state.compact) {
          p.set("compact", "0");
        }
        if (state.offset) {
          p.set("offset", String(state.offset));
        }
        const query = p.toString();
        const next = `${window.location.pathname}${query ? `?${query}` : ""}`;
        window.history.replaceState({}, "", next);
      };

      const applyUrlState = () => {
        const p = new URLSearchParams(window.location.search);
        state.source = p.get("source") || "all";
        state.search = p.get("q") || "";
        state.party = p.get("party") || "";
        state.limit = safeNumber(p.get("limit"), 12) || 12;
        state.compact = p.get("compact") !== "0";
        state.offset = safeNumber(p.get("offset"), 0) || 0;
      };

      const applyCompactMode = () => {
        const isCompact = Boolean(state.compact);
        document.body.classList.toggle("compact-mode", isCompact);
        if (refs.compact) {
          refs.compact.checked = isCompact;
        }
      };

      const setSourcesOptions = (sources = []) => {
        const selected = safeText(state.source) || "all";
        const rows = (Array.isArray(sources) ? sources : [])
          .map((source) => {
            const key = safeText(source?.source_id).trim();
            if (!key) return null;
            const name = safeText(source?.name || key).trim() || key;
            return { source_id: key, label: `${key} · ${name}` };
          })
          .filter(Boolean)
          .sort((a, b) => a.label.localeCompare(b.label, "es", { sensitivity: "base" }));

        refs.source.innerHTML = `<option value="all">Todas las fuentes</option>` + rows
          .map((row) => `<option value="${escapeHtml(row.source_id)}">${escapeHtml(row.label)}</option>`)
          .join("");

        if (selected && selected !== "all") {
          refs.source.value = selected;
        }
      };

      const renderSources = async () => {
        try {
          const apiEndpoint = resolveApiPath("/api/graph?limit=1&include_inactive=1");
          if (!apiEndpoint) throw new Error("API no disponible");
          const payload = await fetchJson(apiEndpoint);
          const sources = Array.isArray(payload?.meta?.sources) ? payload.meta.sources : [];
          setSourcesOptions(sources);
        } catch (_error) {
          refs.source.innerHTML = `<option value="all">Todas las fuentes</option>`;
        }
      };

      const sourceLabel = (event) => {
        const id = safeText(event.source_id);
        const fallback = safeText(event.source_name || id || "Sin fuente");
        const urlCandidate = safeText(event.source_url || event.url || event.source_link || "");
        const extracted = fallback.match(/\burl:\s*(https?:\/\/\S+)/i);
        const url = safeText(urlCandidate || (extracted ? extracted[1] : "")).replace(/^url:\s*/i, "").trim();
        const color = partyColor(event.source_name || id || "sin");
        const displayText = fallback;
        const displayHtml = escapeHtml(displayText);
        const labelHtml = url
          ? `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer" title="${escapeHtml(url)}">${displayHtml}</a>`
          : `<span>${displayHtml}</span>`;
        return `
          <div class="vote-source">
            <span class="pill" style="border-color:${color};color:${color};">${id || "Sin fuente"}</span>
            ${labelHtml}
          </div>
        `;
      };

      const sourceDisplayName = (sourceId) => {
        if (!sourceId || sourceId === "all") return "Todas";
        const option = refs.source.querySelector(`option[value="${sourceId}"]`);
        if (!option) return sourceId;
        return option.textContent?.split(" · ")[0] || sourceId;
      };

      const renderPagerInfo = (payload) => {
        const total = safeNumber(payload?.meta?.total || 0);
        const returned = safeNumber(payload?.meta?.returned || 0);
        const limit = safeNumber(payload?.meta?.limit || state.limit, 1);
        const offset = safeNumber(payload?.meta?.offset || 0);
        const page = Math.floor(offset / Math.max(limit, 1)) + 1;
        refs.pagerLabel.textContent = `Página ${page}`;
        refs.rangeLabel.textContent = `Mostrando ${Math.min(offset + 1, total)}-${Math.min(offset + returned, total)} de ${total}`;
        refs.prev.disabled = offset <= 0;
        refs.next.disabled = offset + returned >= total;
      };

      const renderStats = (payload) => {
        const meta = payload?.meta || {};
        refs.stats.innerHTML = `
          <div class="stat"><span>Fuente</span><strong>${sourceDisplayName(state.source)}</strong></div>
          <div class="stat"><span>Total votaciones</span><strong>${formatNumber(meta.total || 0)}</strong></div>
          <div class="stat"><span>Mostradas</span><strong>${formatNumber(meta.returned || 0)}</strong></div>
          <div class="stat"><span>Límite</span><strong>${safeNumber(meta.limit, state.limit)}</strong></div>
        `;
      };

      const renderGroups = (groups = []) => {
        return groups
          .sort((a, b) => safeNumber(b.total, 0) - safeNumber(a.total, 0))
          .slice(0, 3)
          .map((group) => {
            const g = resolveGroup(group.group_code);
            const total = safeNumber(group.total);
            const yes = safeNumber(group.yes);
            const no = safeNumber(group.no);
            const abstain = safeNumber(group.abstain);
            const noVote = safeNumber(group.no_vote);
            const totalKnown = yes + no + abstain + noVote;
            const yesPct = total > 0 ? Math.round((yes / totalKnown) * 100) : 0;
            const noPct = total > 0 ? Math.round((no / totalKnown) * 100) : 0;
            const abstainPct = total > 0 ? Math.round((abstain / totalKnown) * 100) : 0;
            const noVotePct = total > 0 ? Math.max(0, 100 - yesPct - noPct - abstainPct) : 0;
            const pct = total > 0 ? Math.round((totalKnown / total) * 100) : 0;
            const color = g.color;
            return `
              <div class="group-row-wrap" style="border-color:${color};">
                <div class="group-row">
                  <span class="group-name" title="${escapeHtml(g.code)}">${escapeHtml(g.label)}</span>
                  <span class="small">${formatNumber(total)} votos</span>
                </div>
                <div class="vote-meta" style="margin-top: 0">
                  <span class="pill pill-yes" style="border-color:${color};">${choiceLabel("yes")}: ${formatNumber(yes)}</span>
                  <span class="pill pill-no">${choiceLabel("no")}: ${formatNumber(no)}</span>
                  <span class="pill pill-abstain">${choiceLabel("abstain")}: ${formatNumber(abstain)}</span>
                  <span class="pill pill-novote">${choiceLabel("no_vote")}: ${formatNumber(noVote)}</span>
                  <span class="pill coverage">Cobertura ${pct}%</span>
                </div>
                <div class="vote-bars">
                  <div class="vote-bar">
                    <div class="vote-bar-fill" style="width:${yesPct}%;background:#16a34a"></div>
                  </div>
                  <div class="vote-bar-legend">
                    <span class="vote-bar-label" style="color:#16a34a">Sí ${yesPct}%</span>
                    <span class="vote-bar-label" style="color:#dc2626">No ${noPct}%</span>
                    <span class="vote-bar-label" style="color:#d97706">Abstención ${abstainPct}%</span>
                    <span class="vote-bar-label" style="color:#64748b">No vota ${noVotePct}%</span>
                  </div>
                </div>
              </div>
            `;
          })
          .join("");
      };

      const renderTotalsBlock = (totals = {}) => {
        const yes = safeNumber(totals.yes, 0);
        const no = safeNumber(totals.no, 0);
        const abstain = safeNumber(totals.abstain, 0);
        const noVote = safeNumber(totals.no_vote, 0);
        const total = yes + no + abstain + noVote;
        const barBase = Math.max(total, 1);
        const yesPct = Math.round((yes / barBase) * 100);
        const noPct = Math.round((no / barBase) * 100);
        const abstainPct = Math.round((abstain / barBase) * 100);
        const noVotePct = Math.max(0, 100 - yesPct - noPct - abstainPct);
        return `
          <div class="vote-stats-grid">
            <div class="smallstat"><span>Sí</span><strong>${formatNumber(yes)} (${yesPct}%)</strong></div>
            <div class="smallstat"><span>No</span><strong>${formatNumber(no)} (${noPct}%)</strong></div>
            <div class="smallstat"><span>Abstención</span><strong>${formatNumber(abstain)} (${abstainPct}%)</strong></div>
            <div class="smallstat"><span>No vota</span><strong>${formatNumber(noVote)} (${noVotePct}%)</strong></div>
          </div>
          <div class="vote-bars">
            <div class="vote-bar">
              <div class="vote-bar-fill" style="width:${yesPct}%;background:#16a34a"></div>
              <div class="vote-bar-fill" style="width:${noPct}%;background:#dc2626;margin-left:${yesPct}%;margin-top:-11px"></div>
              <div class="vote-bar-fill" style="width:${abstainPct}%;background:#d97706;margin-left:${yesPct + noPct}%;margin-top:-11px"></div>
              <div class="vote-bar-fill" style="width:${noVotePct}%;background:#64748b;margin-left:${yesPct + noPct + abstainPct}%;margin-top:-11px"></div>
            </div>
            <div class="vote-meta" style="margin-top: 6px">
              <span class="pill" style="border-color:#16a34a">Sí ${formatNumber(yes)}</span>
              <span class="pill" style="border-color:#dc2626">No ${formatNumber(no)}</span>
              <span class="pill" style="border-color:#d97706">Abstención ${formatNumber(abstain)}</span>
              <span class="pill" style="border-color:#64748b">No vota ${formatNumber(noVote)}</span>
              <span class="pill">Total ${formatNumber(total)}</span>
            </div>
          </div>
        `;
      };

      const renderEvents = (rows) => {
        if (!rows.length) {
          refs.events.innerHTML = "<p class='hint'>No hay votaciones con esa combinación.</p>";
          return;
        }

        refs.events.innerHTML = rows
          .map((eventRow) => {
            const date = formatDate(eventRow.vote_date || eventRow.created_at || "");
            const initiative = eventRow.initiative || null;
            const initiativeTitle = safeText(initiative?.title);
            const initiativeExp = safeText(initiative?.expediente);
            const topicRaw = initiativeTitle || safeText(eventRow.title) || safeText(eventRow.expediente_text) || "Sin asunto";
            const topic = escapeHtml(topicRaw);
            const subject = escapeHtml(safeText(eventRow.subgroup_title || eventRow.subgroup_text));
            const totals = eventRow.totals || {};
            const partyParticipation = eventRow.party_participation || {};
            const groupItems = renderGroups(eventRow.group_breakdown || []);
            const partyName = safeText(state.party);
            const partyHighlighted = safeNumber(partyParticipation.total, 0) > 0;
            const sourceBadge = sourceLabel(eventRow);
            const totalsBlock = renderTotalsBlock(totals);

            const tagRaw = safeText(eventRow.vote_event_id) || "Sin ID";
            const tagMatch = tagRaw.match(/\burl:\s*(https?:\/\/\S+)/i) || tagRaw.match(/^(https?:\/\/\S+)/i);
            const tagUrl = tagMatch ? safeText(tagMatch[1]) : "";
            const tagInner = tagUrl
              ? `<a href="${escapeHtml(tagUrl)}" target="_blank" rel="noopener noreferrer" title="${escapeHtml(tagUrl)}">${escapeHtml(tagRaw)}</a>`
              : escapeHtml(tagRaw);

            const aboutParts = [];
            if (initiativeTitle) {
              const kind = [safeText(initiative?.supertype), safeText(initiative?.grouping), safeText(initiative?.type)].filter(Boolean).join(" · ");
              if (kind) aboutParts.push(kind);
              const proc = safeText(initiative?.procedure_type);
              if (proc) aboutParts.push(proc);
              const author = safeText(initiative?.author_text);
              if (author) aboutParts.push(`Autor: ${author}`);
              const status = safeText(initiative?.current_status);
              if (status) aboutParts.push(`Estado: ${status}`);
            }

            const aboutText = aboutParts.join(" · ");
            const aboutLine = aboutText ? `<p class="small about">${escapeHtml(aboutText)}</p>` : "";

            const expValue = initiativeExp || safeText(eventRow.expediente_text);
            const expLine = expValue ? `<p class="small about">Expediente: <strong>${escapeHtml(expValue)}</strong></p>` : "";
            const initUrl = safeText(initiative?.url);
            const initLink = initUrl
              ? `<p class="small"><a href="${escapeHtml(initUrl)}" target="_blank" rel="noopener noreferrer">Abrir expediente</a></p>`
              : "";

            const aboutBlock = aboutLine || expLine || initLink
              ? `<div class="vote-about">${aboutLine}${expLine}${initLink}</div>`
              : "";

            return `
              <article class="vote-card">
                <div class="vote-title">
                  <div>
                    <h3>${topic}</h3>
                    <p class="small">${subject || "Sin subtítulo"}</p>
                  </div>
                  <span class="topic-tag">${tagInner}</span>
                </div>
                ${aboutBlock}
                <p class="small">Fecha: ${escapeHtml(date)}</p>
                ${sourceBadge}
                ${totalsBlock}
                <p class="small" style="margin: 8px 0 4px">Desglose por grupos</p>
                <div class="vote-groups">
                  ${groupItems}
                </div>
                ${partyHighlighted && partyName
                  ? `<p class="small" style="margin-top: 6px"><strong>${escapeHtml(partyName)}</strong>: Sí=${formatNumber(partyParticipation.yes)} · No=${formatNumber(partyParticipation.no)} · Abstención=${formatNumber(partyParticipation.abstain)} · No vota=${formatNumber(partyParticipation.no_vote)} · Total=${formatNumber(partyParticipation.total)}</p>`
                  : ""}
              </article>
            `;
          })
          .join("");
      };

      const loadEvents = async () => {
        refs.loading.style.display = "block";
        refs.message.textContent = "";
        refs.loading.textContent = "Cargando votaciones...";
        refs.loading.className = "loading";
        const apiBase = resolveApiPath("/api/votes/summary");

        if (apiBase) {
          const q = new URL(apiBase, window.location.origin);
          q.searchParams.set("limit", String(state.limit));
          q.searchParams.set("offset", String(state.offset));
          if (state.source !== "all") q.searchParams.set("source_id", state.source);
          if (state.search) q.searchParams.set("q", state.search);
          if (state.party) q.searchParams.set("party_id", state.party);

          try {
            const payload = await fetchJson(q.toString());
            const rows = Array.isArray(payload.events) ? payload.events : [];
            updateSummaryStrip(payload.meta || {}, state.party);
            updateActiveChips();
            renderStats(payload);
            renderPagerInfo(payload);
            renderEvents(rows);
            refs.debugLabel.textContent = `requested=${state.source !== "all" ? state.source : "all"}, limit=${state.limit}, offset=${state.offset}, q=${state.search || "-"}, party=${state.party || "-"}`;
            refs.loading.style.display = "none";
          } catch (error) {
            refs.events.innerHTML = "";
            refs.loading.className = "error";
            refs.loading.innerHTML = `Error cargando votaciones (API): ${escapeHtml(error?.message || String(error))}`;
            refs.stats.innerHTML = "";
            refs.debugLabel.textContent = "";
            refs.rangeLabel.textContent = "";
          }
          return;
        }

        refs.loading.textContent = "Cargando snapshot estático...";
        try {
          const snapshot = await ensureStaticSnapshot();
          const allEvents = Array.isArray(snapshot?.events) ? snapshot.events : [];

          if (allEvents.length) {
            const sourceMap = new Map();
            for (const ev of allEvents) {
              const id = safeText(ev?.source_id).trim();
              if (!id || sourceMap.has(id)) continue;
              sourceMap.set(id, { source_id: id, name: safeText(ev?.source_name || id).trim() || id });
            }
            if (sourceMap.size) {
              setSourcesOptions(Array.from(sourceMap.values()));
            }
          }

          const qNorm = normalize(state.search);
          const sourceFilter = safeText(state.source).trim() || "all";

          const filtered = allEvents.filter((ev) => {
            if (sourceFilter !== "all" && safeText(ev?.source_id).trim() !== sourceFilter) {
              return false;
            }
            if (qNorm) {
              const blob = [
                ev?.title,
                ev?.expediente_text,
                ev?.subgroup_title,
                ev?.subgroup_text,
                ev?.initiative?.title,
                ev?.initiative?.expediente,
              ].filter(Boolean).join(" | ");
              if (!normalize(blob).includes(qNorm)) return false;
            }
            return true;
          });

          const offsetBefore = safeNumber(state.offset, 0);
          if (offsetBefore >= filtered.length && filtered.length > 0) {
            state.offset = Math.max(0, filtered.length - state.limit);
            syncStateUrl();
          }

          const offset = Math.max(0, safeNumber(state.offset, 0));
          const limit = Math.max(1, safeNumber(state.limit, 12));
          const pageEvents = filtered.slice(offset, offset + limit);
          const payload = {
            meta: {
              total: filtered.length,
              limit,
              offset,
              returned: pageEvents.length,
              source_filter: sourceFilter === "all" ? "" : sourceFilter,
              party_filter: "",
              search: state.search || "",
              static_snapshot: true,
            },
            events: pageEvents,
          };

          updateSummaryStrip(payload.meta || {}, state.party);
          updateActiveChips();
          renderStats(payload);
          renderPagerInfo(payload);
          renderEvents(pageEvents);
          refs.debugLabel.textContent = `static snapshot · total=${filtered.length} · limit=${limit} · offset=${offset}`;
          refs.loading.style.display = "none";
          if (safeText(state.party).trim()) {
            refs.message.textContent = "Nota: el filtro de partido solo funciona en modo API (?api=...).";
          }
        } catch (error) {
          refs.events.innerHTML = "";
          refs.loading.className = "error";
          const help = API_BASE_OVERRIDE ? "" : " Añade ?api=http://127.0.0.1:9010 y recarga (o ejecuta el server local).";
          refs.loading.innerHTML = `No se pudo cargar ni API ni snapshot estático.${help}<br><br>${escapeHtml(error?.message || String(error))}`;
          refs.stats.innerHTML = "";
          refs.debugLabel.textContent = "";
          refs.rangeLabel.textContent = "";
        }
      };

      const applyFilters = (keepOffset = false) => {
        const nextSource = refs.source.value || "all";
        const nextSearch = refs.search.value.trim();
        const nextParty = refs.party.value.trim();
        const nextLimit = safeNumber(refs.limit.value, 12);
        const nextCompact = refs.compact?.checked ?? true;

        state.source = nextSource || "all";
        state.search = nextSearch;
        state.party = nextParty;
        state.limit = nextLimit;
        state.compact = nextCompact;
        if (!keepOffset) {
          state.offset = 0;
        }
        syncStateUrl();
        applyCompactMode();
        loadEvents();
      };

      const setupState = () => {
        applyUrlState();
        refs.source.value = state.source;
        refs.search.value = state.search;
        refs.party.value = state.party;
        refs.limit.value = String(state.limit);

        refs.search.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            applyFilters();
          }
        });

        refs.apply.onclick = () => applyFilters();
        refs.clear.onclick = () => {
          state.source = "all";
          state.search = "";
          state.party = "";
          state.offset = 0;
          state.limit = 12;
          state.compact = true;
          refs.source.value = "all";
          refs.search.value = "";
          refs.party.value = "";
          refs.compact.checked = true;
          refs.limit.value = "12";
          syncStateUrl();
          applyCompactMode();
          loadEvents();
        };
        if (refs.compact) {
          refs.compact.addEventListener("change", () => {
            state.compact = Boolean(refs.compact.checked);
            syncStateUrl();
            applyCompactMode();
          });
        }
        refs.prev.onclick = () => {
          if (state.offset <= 0) return;
          state.offset = Math.max(0, state.offset - state.limit);
          syncStateUrl();
          loadEvents();
        };
        refs.next.onclick = () => {
          state.offset += state.limit;
          syncStateUrl();
          loadEvents();
        };
      };

      const init = async () => {
        setupState();
        await renderSources();
        if (state.source) {
          refs.source.value = state.source;
        }
        refs.compact.checked = state.compact;
        applyCompactMode();
        await loadEvents();
      };

      init();
    </script>
  </body>
</html>
