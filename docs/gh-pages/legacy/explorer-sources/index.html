<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vota Con La Chola | Fuentes de Datos</title>
    <link rel="icon" href="data:," />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <style>
      :root {
        color-scheme: light;
        --bg-a: #edf2ff;
        --bg-b: #f8fbff;
        --panel: #ffffff;
        --line: #dce4fb;
        --ink: #0f172a;
        --muted: #5b6578;
        --accent: #3b82f6;
        --accent-2: #0ea5e9;
        --ok: #16a34a;
        --warn: #d97706;
        --err: #dc2626;
        --soft: #f8fafc;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        min-height: 100%;
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
        color: var(--ink);
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        background:
          radial-gradient(940px 420px at 10% 4%, #dbeafe 0%, transparent 65%),
          radial-gradient(900px 500px at 90% 14%, #c7d2fe 0%, transparent 65%),
          linear-gradient(130deg, var(--bg-a), var(--bg-b));
        line-height: 1.4;
        font-size: 16px;
      }

      .app {
        width: min(1320px, calc(100% - 16px));
        margin: 0 auto;
        padding: 14px 0 20px;
        display: grid;
        gap: 12px;
        min-width: 0;
      }

      .top {
        border: 1px solid var(--line);
        border-radius: 16px;
        background: var(--panel);
        padding: 12px;
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.12);
      }

      .eyebrow {
        margin: 0;
        font-size: 0.73rem;
        color: #1d4ed8;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        font-weight: 700;
      }

      h1 {
        margin: 6px 0 6px;
        font-size: 1.5rem;
      }

      .subtitle {
        margin: 0;
        color: var(--muted);
      }

      .global-progress {
        margin-top: 10px;
        border: 1px solid var(--line);
        border-radius: 14px;
        background: linear-gradient(180deg, #ffffff, #f8fbff);
        padding: 10px;
        display: grid;
        gap: 8px;
        min-width: 0;
      }

      .global-progress-head {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
      }

      .global-progress-title {
        font-weight: 800;
        letter-spacing: -0.01em;
      }

      .meter {
        height: 14px;
        border-radius: 999px;
        background: #e5e7eb;
        overflow: hidden;
        border: 1px solid #dbeafe;
      }

      .meter > span {
        display: block;
        height: 100%;
        width: 0;
        background: linear-gradient(90deg, #22c55e, #38bdf8, #2563eb);
      }

      .kpis {
        display: grid;
        gap: 8px;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        min-width: 0;
      }

      .kpi {
        border: 1px solid #dbeafe;
        border-radius: 12px;
        background: #ffffff;
        padding: 8px 10px;
        min-width: 0;
      }

      .kpi .label {
        font-size: 0.72rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #1e3a8a;
        font-weight: 800;
        margin: 0 0 4px;
      }

      .kpi .value {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 10px;
      }

      .kpi .value strong {
        font-size: 1.05rem;
      }

      .toolbar {
        margin-top: 10px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 8px;
      }

      .toolbar button,
      .toolbar input,
      .toolbar select {
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 8px 10px;
        background: #fff;
        width: 100%;
        min-width: 0;
        font: inherit;
      }

      .toolbar button {
        border: 0;
        background: linear-gradient(130deg, var(--accent), var(--accent-2));
        color: #fff;
        font-weight: 700;
        cursor: pointer;
      }

      .toolbar button.secondary {
        border: 1px solid var(--line);
        background: #f1f5f9;
        color: #1e293b;
        font-weight: 600;
      }

      .summary {
        display: grid;
        gap: 8px;
        grid-template-columns: repeat(4, minmax(150px, 1fr));
        min-width: 0;
      }

      .card {
        border: 1px solid var(--line);
        border-radius: 14px;
        background: var(--panel);
        padding: 10px;
      }

      .card h2 {
        margin: 0 0 6px;
        font-size: 0.75rem;
        color: #1e3a8a;
        text-transform: uppercase;
        letter-spacing: 0.07em;
      }

      .big {
        font-size: 1.5rem;
        font-weight: 700;
      }

      .small {
        color: var(--muted);
        font-size: 0.8rem;
      }

      /* Lists inside cards/details should not overflow. */
      .details-body ul {
        margin: 0;
        padding-left: 18px;
        max-width: 100%;
      }

      .details-body li {
        overflow-wrap: anywhere;
        word-break: break-word;
      }

      .row {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 10px;
      }

      .progress-wrap {
        margin-top: 6px;
        border: 1px solid #dbeafe;
        border-radius: 999px;
        height: 12px;
        overflow: hidden;
        background: #eef2ff;
      }

      .progress-inner {
        height: 100%;
        width: 0;
        background: linear-gradient(90deg, #2563eb, #38bdf8);
      }

      .content {
        border: 1px solid var(--line);
        border-radius: 14px;
        background: var(--panel);
        padding: 10px;
        min-width: 0;
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.08);
      }

      .content h2 {
        margin: 2px 0 8px;
      }

      .sub {
        margin: 0 0 8px;
        color: var(--muted);
        font-size: 0.83rem;
      }

      .grid2 {
        display: grid;
        gap: 8px;
        grid-template-columns: 1fr 1.2fr;
      }

      .scope-grid {
        display: grid;
        gap: 10px;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        min-width: 0;
      }

      .scope-card {
        border: 1px solid var(--line);
        border-radius: 14px;
        background: #fff;
        padding: 10px;
        min-width: 0;
      }

      .scope-head {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
      }

      .scope-title {
        font-weight: 800;
        letter-spacing: -0.01em;
      }

      .scope-meta {
        color: var(--muted);
        font-size: 0.9rem;
      }

      .scope-card details {
        margin-top: 8px;
      }

      #panel-filters {
        margin-top: 10px;
        padding: 10px;
        background: #ffffff;
      }

      #panel-filters .details-body {
        padding-top: 8px;
      }

      .actions-grid {
        display: grid;
        gap: 8px;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      }

      .next-actions {
        margin: 0 0 8px;
        display: grid;
        gap: 8px;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        min-width: 0;
      }

      .superheader {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 8px;
        margin-bottom: 8px;
        flex-wrap: wrap;
      }

      .superlink {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: 1px solid #d0def8;
        background: #eff6ff;
        border-radius: 999px;
        padding: 6px 10px;
        color: #102a5c;
        text-decoration: none;
        font-size: 0.82rem;
        font-weight: 700;
      }

      .action {
        border: 1px solid rgba(148, 163, 184, 0.55);
        border-radius: 12px;
        background: #ffffff;
        padding: 10px;
      }

      .action-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 6px;
      }

      .action-title {
        font-weight: 800;
        letter-spacing: -0.01em;
        font-size: 0.92rem;
      }

      .action-meta {
        margin: 0;
        color: var(--muted);
        font-size: 0.8rem;
      }

      .cmd {
        margin: 8px 0 0;
        background: #0b1220;
        color: #e2e8f0;
        border-radius: 10px;
        padding: 8px 9px;
        font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        font-size: 0.78rem;
        overflow: auto;
        white-space: pre;
      }

      .list {
        border: 1px solid #dce4fb;
        border-radius: 12px;
        background: #f8fbff;
        padding: 8px;
      }

      .list ul {
        margin: 0;
        padding-left: 18px;
      }

      .list li {
        margin: 5px 0;
        font-size: 0.86rem;
      }

      .table-wrap {
        border: 1px solid var(--line);
        border-radius: 10px;
        width: 100%;
        max-width: 100%;
        overflow: auto;
      }

      table {
        width: 100%;
        min-width: 640px;
        border-collapse: collapse;
        table-layout: fixed;
        font-size: 0.85rem;
      }

      th,
      td {
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
        padding: 8px 10px;
        vertical-align: top;
        min-width: 0;
        word-break: break-word;
        overflow-wrap: anywhere;
      }

      th {
        background: #f8fbff;
        position: sticky;
        top: 0;
        z-index: 2;
      }

      tbody tr:nth-child(even) {
        background: #fcfdff;
      }

      tbody tr:hover {
        background: #ecf2ff;
      }

      .pill {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 999px;
        color: #0f172a;
        background: #e2e8f0;
        font-size: 0.72rem;
        font-weight: 700;
      }

      .pill.ok {
        background: #dcfce7;
        color: #166534;
      }

      .pill.warn {
        background: #fef3c7;
        color: #92400e;
      }

      .pill.err {
        background: #fee2e2;
        color: #b91c1c;
      }

      .pill.muted {
        background: #e5e7eb;
        color: #334155;
      }

      .meta {
        color: #334155;
        font-size: 0.77rem;
        white-space: normal;
        word-break: break-word;
        overflow-wrap: anywhere;
      }

      .mono {
        font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        word-break: break-word;
        overflow-wrap: anywhere;
      }

      .muted {
        color: var(--muted);
      }

      .small-progress {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .mini {
        width: 130px;
        height: 8px;
        border-radius: 999px;
        background: #e2e8f0;
        overflow: hidden;
      }

      .mini > span {
        display: block;
        height: 100%;
        background: linear-gradient(90deg, #2563eb, #0ea5e9);
      }

      .danger {
        color: var(--err);
      }

      .details-block {
        padding: 0;
      }

      .details-block > summary {
        cursor: pointer;
        list-style: none;
        margin: 0;
        padding: 10px 12px;
        border: 0;
      }

      .details-block > summary::-webkit-details-marker {
        display: none;
      }

      .details-block > summary::marker {
        content: "";
      }

      .details-block summary:focus-visible {
        outline: 2px solid var(--accent);
        outline-offset: 3px;
      }

      .details-title {
        display: inline-flex;
        align-items: baseline;
        gap: 8px;
      }

      .details-body {
        padding: 0 12px 12px;
      }

      .details-title strong {
        color: var(--ink);
        font-size: 1.05rem;
        font-weight: 700;
        letter-spacing: -0.01em;
      }

      .details-title small {
        color: var(--muted);
        font-size: 0.76rem;
      }

      .campaign-shell {
        border: 1px solid #d8e0f6;
        border-radius: 16px;
        background:
          radial-gradient(900px 360px at 8% 0%, #dbeafe 0%, transparent 68%),
          radial-gradient(800px 420px at 92% 10%, #d1fae5 0%, transparent 65%),
          linear-gradient(160deg, #f8fbff, #f2f7ff);
        padding: 12px;
      }

      .campaign-hud {
        border: 1px solid #d3def7;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px;
      }

      .campaign-hud-head {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
      }

      .campaign-hud-title {
        font-weight: 800;
        letter-spacing: -0.01em;
      }

      .campaign-hud-kpis {
        margin-top: 8px;
        display: grid;
        gap: 8px;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }

      .campaign-hud-kpi {
        border: 1px solid #dbe7ff;
        border-radius: 10px;
        background: #ffffff;
        padding: 8px;
      }

      .campaign-hud-kpi .label {
        margin: 0 0 4px;
        font-size: 0.68rem;
        font-weight: 800;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #1e3a8a;
      }

      .campaign-hud-kpi strong {
        font-size: 1rem;
      }

      .campaign-board {
        margin-top: 10px;
        display: grid;
        gap: 10px;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      }

      .campaign-territory {
        position: relative;
        overflow: hidden;
        border: 1px solid #d3def7;
        border-radius: 14px;
        background: linear-gradient(180deg, #ffffff, #f8fbff);
        padding: 10px;
        min-height: 220px;
      }

      .campaign-territory::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        opacity: 0.22;
        background:
          radial-gradient(460px 170px at 8% 0%, #dbeafe 0%, transparent 68%),
          repeating-linear-gradient(
            24deg,
            transparent 0px,
            transparent 11px,
            rgba(59, 130, 246, 0.08) 11px,
            rgba(59, 130, 246, 0.08) 14px
          );
      }

      .campaign-territory[data-tier="captured"] {
        border-color: #86efac;
      }

      .campaign-territory[data-tier="captured"]::before {
        background:
          radial-gradient(500px 180px at 8% 0%, #bbf7d0 0%, transparent 70%),
          repeating-linear-gradient(
            24deg,
            transparent 0px,
            transparent 10px,
            rgba(34, 197, 94, 0.1) 10px,
            rgba(34, 197, 94, 0.1) 13px
          );
      }

      .campaign-territory[data-tier="contested"] {
        border-color: #fdba74;
      }

      .campaign-territory[data-tier="contested"]::before {
        background:
          radial-gradient(500px 180px at 8% 0%, #fde68a 0%, transparent 70%),
          repeating-linear-gradient(
            24deg,
            transparent 0px,
            transparent 10px,
            rgba(245, 158, 11, 0.11) 10px,
            rgba(245, 158, 11, 0.11) 13px
          );
      }

      .campaign-territory[data-tier="frontier"] {
        border-color: #fca5a5;
      }

      .campaign-territory[data-tier="frontier"]::before {
        background:
          radial-gradient(500px 180px at 8% 0%, #fecaca 0%, transparent 70%),
          repeating-linear-gradient(
            24deg,
            transparent 0px,
            transparent 10px,
            rgba(220, 38, 38, 0.1) 10px,
            rgba(220, 38, 38, 0.1) 13px
          );
      }

      .campaign-territory > * {
        position: relative;
        z-index: 1;
      }

      .campaign-head {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 10px;
      }

      .campaign-name {
        font-weight: 800;
        letter-spacing: -0.01em;
      }

      .campaign-percent {
        font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        font-size: 1.02rem;
        font-weight: 700;
      }

      .campaign-meter {
        margin-top: 8px;
        height: 12px;
        border-radius: 999px;
        background: #e2e8f0;
        border: 1px solid #d7e1f6;
        overflow: hidden;
      }

      .campaign-meter > span {
        display: block;
        height: 100%;
        width: 0;
        background: linear-gradient(90deg, #16a34a, #0ea5e9, #2563eb);
      }

      .campaign-meter.secondary > span {
        background: linear-gradient(90deg, #f59e0b, #0ea5e9);
      }

      .campaign-statline {
        margin-top: 6px;
        font-size: 0.8rem;
        color: #334155;
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 8px;
      }

      .campaign-legend {
        margin-top: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
      }

      .campaign-chip {
        display: inline-flex;
        align-items: center;
        border-radius: 999px;
        padding: 3px 7px;
        font-size: 0.72rem;
        font-weight: 700;
        background: #e2e8f0;
        color: #0f172a;
      }

      .campaign-chip.ok {
        background: #dcfce7;
        color: #166534;
      }

      .campaign-chip.warn {
        background: #fef3c7;
        color: #92400e;
      }

      .campaign-chip.err {
        background: #fee2e2;
        color: #b91c1c;
      }

      .campaign-tags {
        margin-top: 8px;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .campaign-tag {
        display: inline-flex;
        align-items: center;
        border: 1px solid #dbe7ff;
        border-radius: 999px;
        background: #ffffff;
        color: #1e293b;
        padding: 2px 7px;
        font-size: 0.72rem;
        font-weight: 700;
      }

      .campaign-list {
        margin-top: 8px;
        border: 1px solid #dbe7ff;
        border-radius: 10px;
        background: #ffffff;
        padding: 7px 8px;
      }

      .campaign-list summary {
        cursor: pointer;
        font-size: 0.78rem;
        font-weight: 800;
        color: #0f172a;
      }

      .campaign-list ul {
        margin: 6px 0 0;
        padding-left: 16px;
      }

      .campaign-list li {
        margin: 4px 0;
        font-size: 0.78rem;
      }

      @media (max-width: 1120px) {
        .toolbar {
          grid-template-columns: 1fr 1fr;
        }

        .summary {
          grid-template-columns: repeat(2, minmax(150px, 1fr));
        }

        .grid2 {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 760px) {
        .toolbar {
          grid-template-columns: 1fr;
        }

        .summary {
          grid-template-columns: 1fr;
        }

        .actions-grid {
          grid-template-columns: 1fr;
        }

        .campaign-board {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
      <main class="app">
        <div class="superheader">
        <a class="superlink" href="../">← Índice</a>
      </div>
      <section class="top">
        <p class="eyebrow">Panel operativo</p>
		        <h1>
	          Estado de fuentes y conectores de datos
	          <span style="font-size: 0.65em; opacity: 0.8; vertical-align: middle">v1.1.0</span>
	        </h1>
        <p class="subtitle">
          Dashboard integral de progreso: cruza <span class="mono">SOURCE_CONFIG</span>, tracker operativo, roadmap macro y roadmap técnico con KPIs cuantificables.
        </p>
        <div id="global-progress" class="global-progress" aria-live="polite">
          <div class="muted">Cargando progreso...</div>
        </div>
        <details class="content details-block" id="panel-roadmap" open>
          <summary>
            <span class="details-title">
              <strong>Roadmap (fases)</strong>
              <small>Visibilidad de “dónde estamos” vs “qué falta” para llegar al north-star.</small>
            </span>
          </summary>
          <div class="details-body">
            <div id="roadmap-summary" class="sub" style="margin:0 0 8px"></div>
            <div id="roadmap-dashboard" class="scope-grid"></div>
	            <p class="sub" style="margin:10px 0 0">
	              Fuente de verdad: <span class="mono">docs/roadmap.md</span> + <span class="mono">docs/roadmap-tecnico.md</span> + <span class="mono">docs/etl/e2e-scrape-load-tracker.md</span>.
	            </p>
	          </div>
	        </details>
        <details class="content details-block" id="panel-roadmap-tech" open>
          <summary>
            <span class="details-title">
              <strong>Roadmap técnico (fases + KPIs)</strong>
              <small>Entrega técnica medible: gates, cobertura política, productividad ETL y trazabilidad.</small>
            </span>
          </summary>
          <div class="details-body">
            <div id="roadmap-tech-summary" class="sub" style="margin:0 0 8px"></div>
            <div id="roadmap-tech-dashboard" class="scope-grid"></div>
            <div id="roadmap-tech-kpis" class="kpis" style="margin-top:10px"></div>
            <p class="sub" style="margin:10px 0 0">
              Fuente de verdad: <span class="mono">docs/roadmap-tecnico.md</span> y métricas reales de <span class="mono">/api/sources/status</span>.
            </p>
          </div>
        </details>
        <div class="toolbar">
          <select id="view-mode">
            <option value="ops">Vista: Operación (hoy)</option>
            <option value="all">Vista: Inventario completo</option>
          </select>
          <input id="search" type="search" placeholder="Buscar por nombre de fuente, source_id o ámbito..." />
          <button id="refresh">Actualizar vista</button>
        </div>
        <details class="content details-block" id="panel-filters">
          <summary>
            <span class="details-title">
              <strong>Filtros avanzados</strong>
              <small>Úsalos para inspección puntual; la vista principal está agrupada por ámbito.</small>
            </span>
          </summary>
          <div class="details-body">
            <div class="toolbar" style="margin-top:0">
              <select id="filter-state">
                <option value="">Estado operativo: Todos</option>
              </select>
              <select id="filter-scope">
                <option value="">Ámbito: Todos</option>
              </select>
              <select id="filter-desired">
                <option value="">Tipo de fuente: Todos</option>
                <option value="desired">Fuentes objetivo (obligatorias)</option>
                <option value="extra">Fuentes adicionales</option>
              </select>
              <select id="filter-tracker-domain">
                <option value="">Dominio (roadmap): Todos</option>
              </select>
              <select id="filter-roadmap">
                <option value="">Ruta de trabajo: Todos</option>
                <option value="TODO">Pendientes</option>
                <option value="PARTIAL">Parcial</option>
                <option value="DONE">Completadas</option>
                <option value="N/A">N/A</option>
              </select>
            </div>
          </div>
        </details>
        <p class="sub">La pantalla se organiza por <span class="mono">ámbito</span>. En “Operación (hoy)” se prioriza lo pendiente o degradado.</p>
	      </section>

	      <section class="content">
	        <div class="row" style="align-items:center; margin-bottom:6px">
	          <h2 style="margin:0; font-size:1rem; letter-spacing:-0.01em">Mapa de Conquista</h2>
	          <p id="campaign-at" class="sub" style="margin:0"></p>
	        </div>
	        <p class="sub">
	          Territorios por tipo de dato. La conquista se calcula en vivo usando <span class="mono">status.json</span> (estado real de conectores) + <span class="mono">ideal.json</span> (backlog de territorio por cubrir).
	        </p>
	        <div id="campaign-map" class="campaign-shell" aria-live="polite">
	          <div class="muted">Cargando mapa de conquista...</div>
	        </div>
	      </section>

	      <section class="content">
	        <div class="row" style="align-items:center; margin-bottom:6px">
	          <h2 style="margin:0; font-size:1rem; letter-spacing:-0.01em">Ámbitos</h2>
          <p id="refresh-at" class="sub" style="margin:0"></p>
        </div>
        <p class="sub">
          Cada tarjeta representa un ámbito y agrupa: progreso mínimo, estado operativo, fuentes en configuración, elementos de roadmap sin conector y pendientes accionables.
        </p>
        <div id="scope-dashboard" class="scope-grid"></div>
      </section>

      <details class="content details-block" id="panel-ideal">
        <summary>
          <span class="details-title">
            <strong>Inventario ideal (Says vs Does)</strong>
            <small>Lista ambiciosa de fuentes programáticas (oficiales y no oficiales) para comparar “lo que dicen” vs “lo que hacen”.</small>
          </span>
        </summary>
        <div class="details-body">
          <div class="toolbar" style="margin-top:0">
            <select id="ideal-evidence">
              <option value="">Evidencia: Todas</option>
              <option value="does">does (hecho)</option>
              <option value="says">says (dicho)</option>
              <option value="both">both</option>
            </select>
            <select id="ideal-min-confidence">
              <option value="0">Fiabilidad mínima: 0</option>
              <option value="1">Fiabilidad mínima: 1</option>
              <option value="2">Fiabilidad mínima: 2</option>
              <option value="3" selected>Fiabilidad mínima: 3</option>
              <option value="4">Fiabilidad mínima: 4</option>
              <option value="5">Fiabilidad mínima: 5</option>
            </select>
          </div>
          <div id="ideal-sources" class="list" style="margin-top:10px"></div>
          <p class="sub" style="margin:10px 0 0">
            Fuente de verdad: <span class="mono">docs/ideal_sources_say_do.json</span>.
          </p>
        </div>
      </details>

      <details class="content details-block" id="panel-howto">
        <summary>
          <span class="details-title">
            <strong>Notas</strong>
            <small>Definiciones rápidas.</small>
          </span>
        </summary>
        <div class="details-body">
          <ul class="list">
            <li><strong>Progreso (metas mínimas):</strong> suma de <span class="mono">min_records_loaded_strict</span> por fuente objetivo (si aplica).</li>
            <li><strong>Estado operativo:</strong> deriva de ejecuciones registradas y umbral mínimo (ok, partial, error, not_run...).</li>
            <li><strong>Roadmap (sin conector):</strong> items del tracker sin <span class="mono">source_id</span> todavía, con ámbito inferido cuando es posible.</li>
            <li><strong>Analítica (temas/posiciones):</strong> contadores y % de calidad para <span class="mono">topics</span>, <span class="mono">topic_evidence</span>, <span class="mono">topic_evidence_reviews</span> y <span class="mono">topic_positions</span> (si existen en la BD).</li>
            <li><strong>Regla de “doble entrada” (calidad):</strong> cuando exista, cruzar “comunicado oficial” con “registro con efectos”. Ejemplos: Consejo de Ministros → BOE; anuncio de adjudicación → PLACSP; anuncio de subvención → BDNS.</li>
            <li><strong>Fiabilidad de fuente (0-5):</strong> 5=registro/boletín con efectos, 4=open data oficial estructurado, 3=comunicación oficial (RSS/agenda), 2=reutilizador, 1=señal, 0=sin trazabilidad.</li>
          </ul>
        </div>
      </details>
    </main>

    <script>
      const state = {
        data: null,
        ideal: null,
      };

      const nodes = {
        viewMode: document.getElementById("view-mode"),
        search: document.getElementById("search"),
        filterState: document.getElementById("filter-state"),
        filterScope: document.getElementById("filter-scope"),
        filterDesired: document.getElementById("filter-desired"),
        filterTrackerDomain: document.getElementById("filter-tracker-domain"),
        filterRoadmap: document.getElementById("filter-roadmap"),
        refresh: document.getElementById("refresh"),
        globalProgress: document.getElementById("global-progress"),
        roadmapSummary: document.getElementById("roadmap-summary"),
        roadmapDashboard: document.getElementById("roadmap-dashboard"),
        roadmapTechSummary: document.getElementById("roadmap-tech-summary"),
        roadmapTechDashboard: document.getElementById("roadmap-tech-dashboard"),
        roadmapTechKpis: document.getElementById("roadmap-tech-kpis"),
        campaignMap: document.getElementById("campaign-map"),
        campaignAt: document.getElementById("campaign-at"),
        scopeDashboard: document.getElementById("scope-dashboard"),
        refreshAt: document.getElementById("refresh-at"),
        idealEvidence: document.getElementById("ideal-evidence"),
        idealMinConfidence: document.getElementById("ideal-min-confidence"),
        idealSources: document.getElementById("ideal-sources"),
      };

      const APP_QUERY = new URLSearchParams(window.location.search);
      const API_BASE_OVERRIDE = (APP_QUERY.get("api") || "").trim();
      const STATIC_DATA_DIR = "data";
      const STATIC_STATUS_PATH = `${STATIC_DATA_DIR}/status.json`;
      const STATIC_IDEAL_PATH = `${STATIC_DATA_DIR}/ideal.json`;
      const CAMPAIGN_STATE_WEIGHT = {
        ok: 1.0,
        partial: 0.55,
        running: 0.4,
        not_run: 0.08,
        degraded: 0.25,
        error: 0.0,
        missing: 0.0,
        unknown: 0.0,
        not_in_catalog: 0.2,
      };

      const CAMPAIGN_TERRITORIES = [
        {
          id: "representation",
          name: "Representacion institucional",
          flavor: "Quien ocupa cada asiento: camaras, parlamentos y cargos.",
          status_tokens: ["diputad", "senador", "parlamentari", "procurador", "concejal", "meps", "ocupaciones", "miembros", "activos"],
          ideal_tokens: ["actores", "mandatos", "declaraciones", "ids", "quien_es_quien", "wikidata", "profiles"],
          domain_hints: ["actores", "mandatos", "declaraciones", "ids"],
        },
        {
          id: "parliament",
          name: "Actividad parlamentaria",
          flavor: "Votaciones, iniciativas, intervenciones y documentos oficiales.",
          status_tokens: ["votacion", "iniciativa", "intervencion", "initiative_docs", "senado", "congreso", "diario"],
          ideal_tokens: ["votos", "votaciones", "roll_call", "iniciativas", "expedientes", "intervenciones", "diario_sesiones", "dossiers", "procedimiento", "documentos", "texto_oficial"],
          domain_hints: ["votos", "iniciativas", "intervenciones", "diario_sesiones"],
        },
        {
          id: "public_money",
          name: "Dinero publico",
          flavor: "Contratacion, subvenciones y ejecucion de gasto.",
          status_tokens: ["placsp", "bdns", "contrat", "subvencion", "ayuda", "sindicacion", "dinero"],
          ideal_tokens: ["contratacion", "licitaciones", "adjudicaciones", "subvenciones", "ayudas", "dinero_publico", "presupuesto", "ejecucion", "convenios", "encomiendas", "finanzas_publicas", "auditoria", "ted"],
          domain_hints: ["contratacion", "subvenciones", "presupuesto", "dinero_publico"],
        },
        {
          id: "executive",
          name: "Ejecutivo y comunicacion",
          flavor: "Consejo de ministros, agendas, comparecencias y comunicados.",
          status_tokens: ["moncloa", "rss", "referencias", "ejecutivo", "agenda"],
          ideal_tokens: ["consejo_ministros", "acuerdos", "agenda", "actividad_publica", "comunicacion", "comparecencias", "alertas", "transparencia", "integridad", "conflictos_interes", "patrimonio", "lobby", "influencia"],
          domain_hints: ["agenda", "comunicacion", "acuerdos", "integridad"],
        },
        {
          id: "electoral",
          name: "Ciclo electoral",
          flavor: "Convocatorias, resultados y promesas de partido.",
          status_tokens: ["infoelectoral", "electoral", "programas", "partidos"],
          ideal_tokens: ["programas", "promesas", "posiciones_declaradas", "narrativa", "cobertura_mediatica", "convocatorias"],
          domain_hints: ["programas", "promesas", "posiciones_declaradas", "convocatorias"],
        },
        {
          id: "legal",
          name: "Marco legal",
          flavor: "Normativa, boletines y textos con efectos juridicos.",
          status_tokens: ["boe", "legal", "norma", "sancion", "borme", "boletin"],
          ideal_tokens: ["normativa", "nombramientos", "resoluciones", "sumario", "publicacion", "legislacion", "texto_vigente", "pre_normativa", "planificacion_normativa", "boe", "eurlex"],
          domain_hints: ["normativa", "sumario", "legislacion", "texto_vigente"],
        },
        {
          id: "context",
          name: "Contexto e impacto",
          flavor: "Series para outcomes, comparacion territorial y contexto.",
          status_tokens: ["eurostat", "aemet", "bde", "series", "outcomes", "indicadores"],
          ideal_tokens: ["estadistica", "contexto", "geografia", "territorio", "codigos", "catalogo", "descubrimiento", "opendata", "tempus", "ign"],
          domain_hints: ["estadistica", "contexto", "territorio", "geografia"],
        },
      ];

      const isLocalApiHost = (() => {
        const host = window.location.hostname;
        return host === "localhost" || host === "127.0.0.1" || host === "::1" || host === "0.0.0.0";
      })();

      const resolveApiPath = (path) => {
        const endpoint = String(path || "").trim();
        if (!endpoint) return "";
        const normalized = endpoint.startsWith("/") ? endpoint : `/${endpoint}`;
        if (API_BASE_OVERRIDE) return `${API_BASE_OVERRIDE.replace(/\/$/, "")}${normalized}`;
        if (isLocalApiHost) return normalized;
        return "";
      };

      async function readJson(url) {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        return await resp.json();
      }

      async function fetchPayload({ apiPath, staticPath, allowMissing = false }) {
        const resolved = resolveApiPath(apiPath);
        if (resolved) {
          try {
            return await readJson(resolved);
          } catch (err) {
            if (!staticPath) throw err;
          }
        }
        if (!staticPath) {
          if (allowMissing) return null;
          throw new Error(`Sin API disponible para ${apiPath}`);
        }
        try {
          return await readJson(staticPath);
        } catch (err) {
          if (allowMissing) return null;
          throw err;
        }
      }

      function getParam(key) {
        try {
          return new URL(window.location.href).searchParams.get(key);
        } catch (_err) {
          return null;
        }
      }

      function setParam(key, value) {
        try {
          const url = new URL(window.location.href);
          if (!value) {
            url.searchParams.delete(key);
          } else {
            url.searchParams.set(key, value);
          }
          window.history.replaceState({}, "", url.toString());
        } catch (_err) {
          // ignore
        }
      }

      function formatDate(val) {
        if (!val) {
          return "";
        }
      try {
          const date = new Date(val.replace(" ", "T"));
          if (Number.isNaN(date.getTime())) {
            return val;
          }
          return date.toLocaleString("es-ES", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });
        } catch (_err) {
          return val;
        }
      }

      function stateClass(stateName) {
        const map = {
          ok: "ok",
          partial: "warn",
          running: "warn",
          degraded: "warn",
          error: "err",
          not_run: "muted",
          not_in_catalog: "muted",
          missing: "err",
          unknown: "muted",
        };
        return map[stateName] || "muted";
      }

      function labelState(stateName) {
        const map = {
          ok: "Completada",
          partial: "Parcialmente cargada",
          running: "En ejecución",
          degraded: "Con errores",
          error: "Error",
          not_run: "Sin correr",
          not_in_catalog: "Extra",
          missing: "Sin fila en BD",
          unknown: "Estado desconocido",
        };
        return map[stateName] || "Sin estado";
      }

      function roadmapLabel(value) {
        const map = {
          DONE: "Completado",
          PARTIAL: "Parcial",
          TODO: "Pendiente",
          NA: "Sin roadmap",
          "N/A": "Sin roadmap",
          "": "Sin roadmap",
        };
        return map[value] || value;
      }

      function roadmapPill(value) {
        const val = (value || "").toUpperCase().trim();
        if (!val) {
          return "<span class='pill muted'>Sin roadmap</span>";
        }
        if (val === "DONE") {
          return "<span class='pill ok'>Completado</span>";
        }
        if (val === "PARTIAL") {
          return "<span class='pill warn'>Parcial</span>";
        }
        if (val === "TODO") {
          return "<span class='pill muted'>Pendiente</span>";
        }
        return "<span class='pill muted'>" + roadmapLabel(val) + "</span>";
      }

      function statusPill(value) {
        const val = (value || "").toUpperCase().trim();
        if (!val) return "<span class='pill muted'>N/A</span>";
        if (val === "DONE") return "<span class='pill ok'>DONE</span>";
        if (val === "PARTIAL") return "<span class='pill warn'>PARTIAL</span>";
        if (val === "TODO") return "<span class='pill muted'>TODO</span>";
        if (val === "MISSING") return "<span class='pill err'>MISSING</span>";
        if (val === "UNTRACKED") return "<span class='pill muted'>UNTRACKED</span>";
        return "<span class='pill muted'>" + val + "</span>";
      }

      function sqlPill(value) {
        const val = (value || "").toUpperCase().trim();
        if (!val) {
          return "<span class='pill muted'>Sin check SQL</span>";
        }
        if (val === "DONE") {
          return "<span class='pill ok'>OK</span>";
        }
        if (val === "PARTIAL") {
          return "<span class='pill warn'>Parcial</span>";
        }
        if (val === "TODO") {
          return "<span class='pill muted'>Pendiente</span>";
        }
        return "<span class='pill muted'>" + val + "</span>";
      }

      function actionKindLabel(value) {
        const map = {
          done_zero_real: "En BD sin ejecución real verificable (strict-network)",
          ingest_error: "Error en la ingesta",
          tracker_item: "Requiere trabajo del roadmap",
        };
        return map[value] || value;
      }

      function progressBadge(progress) {
        const percent = Number.isInteger(progress.percent) ? progress.percent : null;
        if (!percent && percent !== 0) {
          return "<span class='muted'>—</span>";
        }
        const width = Math.max(0, Math.min(100, percent));
        return "<span class='small-progress'><span class='mini'><span style='width: " + width + "%'></span></span>" +
          width + "% (" + progress.loaded + "/" + progress.target + ")</span>";
      }

      function renderGlobalProgress(data) {
        const summary = data.summary || {};
        const desiredProgress = (summary.desired_progress && summary.desired_progress.percent) || 0;
        const tracker = summary.tracker || {};
        const sql = summary.sql || {};
        const analytics = data.analytics || {};
	        const aTopics = analytics.topics || {};
	        const aEvidence = analytics.evidence || {};
	        const aPositions = analytics.positions || {};
	        const aCoherence = analytics.coherence || {};
	        const aAction = analytics.action || {};
	        const aImpact = analytics.impact || {};
	        const parlQuality = data.parl_quality || {};
	        const voteQ = (parlQuality.votes && parlQuality.votes.kpis) ? parlQuality.votes.kpis : {};
        const initdocTail = data.initdoc_actionable_tail || {};
        const initdocDigest = initdocTail && typeof initdocTail === "object" && initdocTail.digest
          ? initdocTail.digest
          : {};
        const initdocTotals = initdocDigest && typeof initdocDigest === "object" && initdocDigest.totals
          ? initdocDigest.totals
          : {};
        const initdocTrend = initdocTail && typeof initdocTail === "object" && initdocTail.heartbeat_window
          ? initdocTail.heartbeat_window
          : {};
        const initdocCompactTrend = initdocTail && typeof initdocTail === "object" && initdocTail.heartbeat_compaction_window
          ? initdocTail.heartbeat_compaction_window
          : {};
        const initdocCompactTrendDigest = initdocTail && typeof initdocTail === "object" && initdocTail.heartbeat_compaction_window_digest
          ? initdocTail.heartbeat_compaction_window_digest
          : {};
        const initdocCompactTrendDigestHeartbeatWindow = initdocTail && typeof initdocTail === "object" && initdocTail.heartbeat_compaction_window_digest_heartbeat_window
          ? initdocTail.heartbeat_compaction_window_digest_heartbeat_window
          : {};
        const initdocCompactTrendDigestHeartbeatCompactionWindow = initdocTail && typeof initdocTail === "object" && initdocTail.heartbeat_compaction_window_digest_heartbeat_compaction_window
          ? initdocTail.heartbeat_compaction_window_digest_heartbeat_compaction_window
          : {};
        const initdocCompactTrendDigestHeartbeatCompactionWindowDigest = initdocTail && typeof initdocTail === "object" && initdocTail.heartbeat_compaction_window_digest_heartbeat_compaction_window_digest
          ? initdocTail.heartbeat_compaction_window_digest_heartbeat_compaction_window_digest
          : {};
        const initdocCompactTrendStatus = String(initdocCompactTrend.status || "").toLowerCase();
        const initdocCompactTrendStatusClass = initdocCompactTrendStatus === "ok" ? "ok" : initdocCompactTrendStatus === "degraded" ? "warn" : initdocCompactTrendStatus === "failed" ? "err" : "muted";
        const initdocCompactTrendStatusLabel = initdocCompactTrendStatus ? initdocCompactTrendStatus.toUpperCase() : "N/A";
        const initdocCompactTrendDigestStatus = String(initdocCompactTrendDigest.status || "").toLowerCase();
        const initdocCompactTrendDigestStatusClass = initdocCompactTrendDigestStatus === "ok" ? "ok" : initdocCompactTrendDigestStatus === "degraded" ? "warn" : initdocCompactTrendDigestStatus === "failed" ? "err" : "muted";
        const initdocCompactTrendDigestStatusLabel = initdocCompactTrendDigestStatus ? initdocCompactTrendDigestStatus.toUpperCase() : "N/A";
        const initdocCompactTrendDigestRisk = String(initdocCompactTrendDigest.risk_level || "").toLowerCase();
        const initdocCompactTrendDigestRiskLabel = initdocCompactTrendDigestRisk ? initdocCompactTrendDigestRisk.toUpperCase() : "N/A";
        const initdocCompactTrendDigestRiskReasons = Array.isArray(initdocCompactTrendDigest.risk_reasons)
          ? initdocCompactTrendDigest.risk_reasons.map((x) => String(x || "")).filter(Boolean)
          : [];
        const initdocCompactTrendDigestHeartbeatWindowStatus = String(initdocCompactTrendDigestHeartbeatWindow.status || "").toLowerCase();
        const initdocCompactTrendDigestHeartbeatWindowStatusClass = initdocCompactTrendDigestHeartbeatWindowStatus === "ok" ? "ok" : initdocCompactTrendDigestHeartbeatWindowStatus === "degraded" ? "warn" : initdocCompactTrendDigestHeartbeatWindowStatus === "failed" ? "err" : "muted";
        const initdocCompactTrendDigestHeartbeatWindowStatusLabel = initdocCompactTrendDigestHeartbeatWindowStatus ? initdocCompactTrendDigestHeartbeatWindowStatus.toUpperCase() : "N/A";
        const initdocCompactTrendDigestHeartbeatCompactionWindowStatus = String(initdocCompactTrendDigestHeartbeatCompactionWindow.status || "").toLowerCase();
        const initdocCompactTrendDigestHeartbeatCompactionWindowStatusClass = initdocCompactTrendDigestHeartbeatCompactionWindowStatus === "ok" ? "ok" : initdocCompactTrendDigestHeartbeatCompactionWindowStatus === "degraded" ? "warn" : initdocCompactTrendDigestHeartbeatCompactionWindowStatus === "failed" ? "err" : "muted";
        const initdocCompactTrendDigestHeartbeatCompactionWindowStatusLabel = initdocCompactTrendDigestHeartbeatCompactionWindowStatus ? initdocCompactTrendDigestHeartbeatCompactionWindowStatus.toUpperCase() : "N/A";
        const initdocCompactTrendDigestHeartbeatCompactionWindowDigestStatus = String(initdocCompactTrendDigestHeartbeatCompactionWindowDigest.status || "").toLowerCase();
        const initdocCompactTrendDigestHeartbeatCompactionWindowDigestStatusClass = initdocCompactTrendDigestHeartbeatCompactionWindowDigestStatus === "ok" ? "ok" : initdocCompactTrendDigestHeartbeatCompactionWindowDigestStatus === "degraded" ? "warn" : initdocCompactTrendDigestHeartbeatCompactionWindowDigestStatus === "failed" ? "err" : "muted";
        const initdocCompactTrendDigestHeartbeatCompactionWindowDigestStatusLabel = initdocCompactTrendDigestHeartbeatCompactionWindowDigestStatus ? initdocCompactTrendDigestHeartbeatCompactionWindowDigestStatus.toUpperCase() : "N/A";
        const initdocCompactTrendDigestHeartbeatCompactionWindowDigestRisk = String(initdocCompactTrendDigestHeartbeatCompactionWindowDigest.risk_level || "").toLowerCase();
        const initdocCompactTrendDigestHeartbeatCompactionWindowDigestRiskLabel = initdocCompactTrendDigestHeartbeatCompactionWindowDigestRisk ? initdocCompactTrendDigestHeartbeatCompactionWindowDigestRisk.toUpperCase() : "N/A";
        const initdocTrendCounts = initdocTrend && typeof initdocTrend === "object" && initdocTrend.status_counts
          ? initdocTrend.status_counts
          : {};
        const initdocTrendEntries = Number(initdocTrend.entries_in_window || 0);
        const initdocTrendFailed = Number(initdocTrendCounts.failed || 0);
        const initdocTrendDegraded = Number(initdocTrendCounts.degraded || 0);
        const initdocTrendFailedRatePct = Number(initdocTrend.failed_rate_pct || 0);
        const initdocTrendFailedRatePctDisplay = Number.isFinite(initdocTrendFailedRatePct)
          ? (Math.round(initdocTrendFailedRatePct * 10) / 10).toFixed(1)
          : "0.0";
        const initdocTrendLatest = initdocTrend && typeof initdocTrend === "object" && initdocTrend.latest
          ? initdocTrend.latest
          : {};
        const initdocTrendLatestStatus = String(initdocTrendLatest.status || "").toLowerCase();
        const initdocTrendLatestLabel = initdocTrendLatestStatus ? initdocTrendLatestStatus.toUpperCase() : "N/A";
        const initdocTrendStatus = String(initdocTrend.status || "").toLowerCase();
        const initdocTrendStatusClass = initdocTrendStatus === "ok" ? "ok" : initdocTrendStatus === "degraded" ? "warn" : initdocTrendStatus === "failed" ? "err" : "muted";
        const initdocTrendStatusLabel = initdocTrendStatus ? initdocTrendStatus.toUpperCase() : "N/A";
        const initdocTrendSummary = initdocTrendEntries > 0
          ? "trend last " + initdocTrendEntries + ": failed " + initdocTrendFailed + " (" + initdocTrendFailedRatePctDisplay + "%) · degraded " + initdocTrendDegraded + " · latest " + initdocTrendLatestLabel
          : "trend: no heartbeat rows";
        const initdocCompactTrendSummary = "compact parity: " + initdocCompactTrendStatusLabel;
        const initdocCompactTrendDigestSummary = "compact digest: " + initdocCompactTrendDigestStatusLabel + " · risk " + initdocCompactTrendDigestRiskLabel + (initdocCompactTrendDigestRiskReasons.length > 0 ? " · " + initdocCompactTrendDigestRiskReasons.slice(0, 2).join(", ") : "");
        const initdocCompactTrendDigestHeartbeatWindowEntries = Number(initdocCompactTrendDigestHeartbeatWindow.entries_in_window || 0);
        const initdocCompactTrendDigestHeartbeatWindowCounts = initdocCompactTrendDigestHeartbeatWindow && typeof initdocCompactTrendDigestHeartbeatWindow === "object" && initdocCompactTrendDigestHeartbeatWindow.status_counts
          ? initdocCompactTrendDigestHeartbeatWindow.status_counts
          : {};
        const initdocCompactTrendDigestHeartbeatWindowFailed = Number(initdocCompactTrendDigestHeartbeatWindowCounts.failed || 0);
        const initdocCompactTrendDigestHeartbeatWindowDegraded = Number(initdocCompactTrendDigestHeartbeatWindowCounts.degraded || 0);
        const initdocCompactTrendDigestHeartbeatWindowSummary = initdocCompactTrendDigestHeartbeatWindowEntries > 0
          ? "compact digest trend last " + initdocCompactTrendDigestHeartbeatWindowEntries + ": failed " + initdocCompactTrendDigestHeartbeatWindowFailed + " · degraded " + initdocCompactTrendDigestHeartbeatWindowDegraded
          : "compact digest trend: no heartbeat rows";
        const initdocCompactTrendDigestHeartbeatCompactionWindowSummary = "cd compact parity: " + initdocCompactTrendDigestHeartbeatCompactionWindowStatusLabel;
        const initdocCompactTrendDigestHeartbeatCompactionWindowDigestSummary = "cd compact digest: " + initdocCompactTrendDigestHeartbeatCompactionWindowDigestStatusLabel + " · risk " + initdocCompactTrendDigestHeartbeatCompactionWindowDigestRiskLabel;
        const initdocStatus = String(initdocDigest.status || "").toLowerCase();
        const initdocStatusClass = initdocStatus === "ok" ? "ok" : initdocStatus === "degraded" ? "warn" : initdocStatus === "failed" ? "err" : "muted";
        const initdocStatusLabel = initdocStatus === "ok" ? "OK" : initdocStatus === "degraded" ? "DEGRADED" : initdocStatus === "failed" ? "FAILED" : "N/A";
        const initdocActionableMissing = Number(initdocTotals.actionable_missing || 0);
        const initdocRedundantMissing = Number(initdocTotals.redundant_missing || 0);
        const initdocTotalMissing = Number(initdocTotals.total_missing || 0);
        const actionCount = Array.isArray(data.actions) ? data.actions.length : 0;
        const cards = [
          {title: "Fuentes esperadas (config)", value: summary.desired || 0},
          {title: "Presentes en BD", value: summary.present || 0},
          {title: "Faltan por cargar", value: summary.missing || 0},
          {title: "Fuentes extras", value: summary.extra || 0},
          {title: "Tracker pendientes", value: tracker.todo || 0},
          {title: "Tracker parciales", value: tracker.partial || 0},
          {title: "Tracker completados", value: tracker.done || 0},
          {title: "Acciones sugeridas", value: actionCount},
        ];

        const target = summary.desired_progress && summary.desired_progress.target ? summary.desired_progress.target : 0;
        const loaded = summary.desired_progress && summary.desired_progress.loaded ? summary.desired_progress.loaded : 0;
        const percent = Math.max(0, Math.min(100, Number.isFinite(desiredProgress) ? desiredProgress : 0));
        const present = summary.present || 0;
        const desired = summary.desired || 0;
        const missing = summary.missing || 0;
        const extra = summary.extra || 0;
        const todo = tracker.todo || 0;
        const partial = tracker.partial || 0;
        const done = tracker.done || 0;
        const sqlDone = sql.done || 0;
        const sqlPartial = sql.partial || 0;
        const fkViolations = (sql.foreign_key_violations === 0 || sql.foreign_key_violations)
          ? Number(sql.foreign_key_violations)
          : null;

        const topicsTotal = Number(aTopics.topics_total || 0);
        const topicSetsTotal = Number(aTopics.topic_sets_total || 0);
        const highStakesTotal = Number(aTopics.high_stakes_total || 0);
        const evidenceTotal = Number(aEvidence.topic_evidence_total || 0);
        const evidenceTopicPct = Number(aEvidence.topic_evidence_with_topic_pct || 0);
        const evidenceDatePct = Number(aEvidence.topic_evidence_with_date_pct || 0);
        const evidenceDeclaredTotal = Number(aEvidence.topic_evidence_declared_total || 0);
        const evidenceRevealedTotal = Number(aEvidence.topic_evidence_revealed_total || 0);
        const evidenceDeclaredDatePct = Number(aEvidence.topic_evidence_declared_with_date_pct || 0);
        const evidenceDeclaredSignalPct = Number(aEvidence.topic_evidence_declared_with_signal_pct || 0);
        const evidenceDeclaredTextPct = Number(aEvidence.declared_evidence_with_text_excerpt_pct || 0);
        const reviewTotal = Number(aEvidence.topic_evidence_reviews_total || 0);
        const reviewPending = Number(aEvidence.topic_evidence_reviews_pending || 0);
        const reviewResolved = Number(aEvidence.topic_evidence_reviews_resolved || 0);
        const reviewIgnored = Number(aEvidence.topic_evidence_reviews_ignored || 0);
        const reviewPendingPct = Number(aEvidence.topic_evidence_reviews_pending_pct || 0);
        const reviewByReason = (aEvidence && aEvidence.topic_evidence_reviews_pending_by_reason) ? aEvidence.topic_evidence_reviews_pending_by_reason : {};
        const textDocsTotal = Number(aEvidence.text_documents_total || 0);
        const topicMethodTop = (aEvidence && Array.isArray(aEvidence.topic_method_top) && aEvidence.topic_method_top.length)
          ? aEvidence.topic_method_top[0]
          : null;
        const stanceMethodTop = (aEvidence && Array.isArray(aEvidence.stance_method_top) && aEvidence.stance_method_top.length)
          ? aEvidence.stance_method_top[0]
          : null;
        const topicMethodKey = topicMethodTop && topicMethodTop.key ? String(topicMethodTop.key) : "—";
        const stanceMethodKey = stanceMethodTop && stanceMethodTop.key ? String(stanceMethodTop.key) : "—";
        const positionsTotal = Number(aPositions.topic_positions_total || 0);
        const positionsWithEvidencePct = Number(aPositions.topic_positions_with_evidence_pct || 0);
        const positionsByMethod = (aPositions && aPositions.topic_positions_by_method) ? aPositions.topic_positions_by_method : {};
        const positionsVotes = Number((positionsByMethod && positionsByMethod.votes) ? positionsByMethod.votes : 0);
        const positionsDeclared = Number((positionsByMethod && positionsByMethod.declared) ? positionsByMethod.declared : 0);
        const positionsCombined = Number((positionsByMethod && positionsByMethod.combined) ? positionsByMethod.combined : 0);
        const coherenceAsOf = aCoherence.as_of_date ? String(aCoherence.as_of_date) : "";
        const coherenceExplicit = Number(aCoherence.explicit_total || 0);
        const coherenceOverlap = Number(aCoherence.overlap_total || 0);
        const coherenceIncoherent = Number(aCoherence.incoherent_total || 0);
        const coherencePct = Number(aCoherence.coherence_pct || 0);

        const policyEventsTotal = Number(aAction.policy_events_total || 0);
        const policyAxisScoresTotal = Number(aAction.policy_event_axis_scores_total || 0);
        const interventionsTotal = Number(aAction.interventions_total || 0);
        const indicatorSeriesTotal = Number(aImpact.indicator_series_total || 0);
        const indicatorPointsTotal = Number(aImpact.indicator_points_total || 0);
	        const causalEstimatesTotal = Number(aImpact.causal_estimates_total || 0);
	        const voteLinkPct = voteQ.events_with_initiative_link_pct;
	        const voteOfficialLinkPct = voteQ.events_with_official_initiative_link_pct;
	        const votePersonIdPct = voteQ.member_votes_with_person_id_pct;
	        const voteTopicPctLatest = voteQ.latest_events_with_topic_evidence_pct;

        function fmtPct(x) {
          if (!Number.isFinite(x)) return "—";
          return Math.round(x * 100) + "%";
        }
        const reviewTop = Object.keys(reviewByReason || {})
          .sort((a, b) => Number(reviewByReason[b] || 0) - Number(reviewByReason[a] || 0))
          .slice(0, 3)
          .map((k) => String(k) + ":" + String(reviewByReason[k]))
          .join(" · ");

	        nodes.globalProgress.innerHTML =
          "<div class='global-progress-head'>" +
          "<div class='global-progress-title'>Progreso global de cobertura (metas mínimas)</div>" +
          "<div class='mono muted'>" + percent + "%</div>" +
          "</div>" +
          "<div class='meter'><span style='width:" + percent + "%'></span></div>" +
          "<div class='row'><span class='muted'>Registros mínimos cubiertos</span><span class='mono'>" + loaded + " / " + target + "</span></div>" +
	          "<div class='kpis'>" +
	          "<div class='kpi'><p class='label'>Inventario</p><div class='value'><strong>" + present + "</strong><span class='muted'>en BD</span></div><div class='small'>Esperadas: " + desired + " · Extras: " + extra + " · Faltan: " + missing + "</div></div>" +
	          "<div class='kpi'><p class='label'>Tracker</p><div class='value'><strong>" + (todo + partial) + "</strong><span class='muted'>por resolver</span></div><div class='small'>Pendientes: " + todo + " · Parciales: " + partial + " · Completadas: " + done + "</div></div>" +
	          "<div class='kpi'><p class='label'>Checks SQL</p><div class='value'><strong>" + sqlDone + "</strong><span class='muted'>OK</span></div><div class='small'>Parciales: " + sqlPartial + " · FK violations: " + (fkViolations === null ? "—" : fkViolations) + "</div></div>" +
	          "<div class='kpi'><p class='label'>Votaciones (quality)</p><div class='value'><strong>" + fmtPct(Number(voteLinkPct)) + "</strong><span class='muted'>link</span></div><div class='small'>Oficial: " + fmtPct(Number(voteOfficialLinkPct)) + " · person_id: " + fmtPct(Number(votePersonIdPct)) + " · topic (latest): " + fmtPct(Number(voteTopicPctLatest)) + "</div></div>" +
	          "<div class='kpi'><p class='label'>Iniciativas Senado (tail)</p><div class='value'><strong>" + initdocActionableMissing + "</strong><span class='pill " + initdocStatusClass + "'>" + initdocStatusLabel + "</span></div><div class='small'>actionable: " + initdocActionableMissing + " · redundant: " + initdocRedundantMissing + " · total_missing: " + initdocTotalMissing + " · <span class='pill " + initdocTrendStatusClass + "'>trend " + initdocTrendStatusLabel + "</span> · <span class='pill " + initdocCompactTrendStatusClass + "'>compact " + initdocCompactTrendStatusLabel + "</span> · <span class='pill " + initdocCompactTrendDigestStatusClass + "'>compact-digest " + initdocCompactTrendDigestStatusLabel + "</span> · <span class='pill " + initdocCompactTrendDigestHeartbeatWindowStatusClass + "'>cd-trend " + initdocCompactTrendDigestHeartbeatWindowStatusLabel + "</span> · <span class='pill " + initdocCompactTrendDigestHeartbeatCompactionWindowStatusClass + "'>cd-compact " + initdocCompactTrendDigestHeartbeatCompactionWindowStatusLabel + "</span> · <span class='pill " + initdocCompactTrendDigestHeartbeatCompactionWindowDigestStatusClass + "'>cd-digest " + initdocCompactTrendDigestHeartbeatCompactionWindowDigestStatusLabel + "</span></div><div class='small'>" + initdocTrendSummary + " · " + initdocCompactTrendSummary + " · " + initdocCompactTrendDigestSummary + " · " + initdocCompactTrendDigestHeartbeatWindowSummary + " · " + initdocCompactTrendDigestHeartbeatCompactionWindowSummary + " · " + initdocCompactTrendDigestHeartbeatCompactionWindowDigestSummary + "</div></div>" +
	          "<div class='kpi'><p class='label'>Analítica (temas)</p><div class='value'><strong>" + positionsTotal + "</strong><span class='muted'>posiciones</span></div><div class='small'>Temas: " + topicsTotal + " · Sets: " + topicSetsTotal + " · High-stakes: " + highStakesTotal + " · pos(votes): " + positionsVotes + " · pos(declared): " + positionsDeclared + " · pos(combined): " + positionsCombined + "</div></div>" +
	          "<div class='kpi'><p class='label'>Coherencia (says/does)</p><div class='value'><strong>" + fmtPct(coherencePct) + "</strong><span class='muted'>explicit</span></div><div class='small'>as_of: " + (coherenceAsOf || "—") + " · overlap: " + coherenceOverlap + " · explicit: " + coherenceExplicit + " · incoherent: " + coherenceIncoherent + "</div></div>" +
	          "<div class='kpi'><p class='label'>Analítica (evidencia)</p><div class='value'><strong>" + evidenceTotal + "</strong><span class='muted'>evidencias</span></div><div class='small'>does: " + evidenceRevealedTotal + " · says: " + evidenceDeclaredTotal + " · says(text): " + fmtPct(evidenceDeclaredTextPct) + " · says(fecha): " + fmtPct(evidenceDeclaredDatePct) + " · says(stance): " + fmtPct(evidenceDeclaredSignalPct) + " · pos(evid): " + fmtPct(positionsWithEvidencePct) + " · docs: " + textDocsTotal + " · tm: " + topicMethodKey + " · sm: " + stanceMethodKey + "</div></div>" +
	          "<div class='kpi'><p class='label'>Review queue (says)</p><div class='value'><strong>" + reviewPending + "</strong><span class='muted'>pending</span></div><div class='small'>pending/declared: " + fmtPct(reviewPendingPct) + " · total: " + reviewTotal + " · resolved: " + reviewResolved + " · ignored: " + reviewIgnored + (reviewTop ? " · " + reviewTop : "") + "</div></div>" +
	          "<div class='kpi'><p class='label'>Acción/Impacto</p><div class='value'><strong>" + policyEventsTotal + "</strong><span class='muted'>events</span></div><div class='small'>Axis: " + policyAxisScoresTotal + " · Interv: " + interventionsTotal + " · Series: " + indicatorSeriesTotal + " (" + indicatorPointsTotal + " pts) · Estimates: " + causalEstimatesTotal + "</div></div>" +
	          "</div>";
	      }

      function renderRoadmapDashboard(data) {
        if (!nodes.roadmapDashboard) return;
        const rd = data.roadmap || {};
        const phases = Array.isArray(rd.phases) ? rd.phases : [];
        const summary = rd.summary || {};

        if (!phases.length) {
          nodes.roadmapDashboard.innerHTML = "<div class='muted'>Roadmap no disponible en /api/sources/status.</div>";
          if (nodes.roadmapSummary) nodes.roadmapSummary.textContent = "";
          return;
        }

        const trackedPct = (summary.tracked_percent === 0 || summary.tracked_percent) ? summary.tracked_percent : null;
        const overallPct = (summary.overall_percent === 0 || summary.overall_percent) ? summary.overall_percent : null;
        const trackedTotal = Number(summary.tracked_total || 0);
        const overallTotal = Number(summary.overall_total || 0);

        if (nodes.roadmapSummary) {
          const t = (trackedPct === null) ? "—" : (String(trackedPct) + "%");
          const o = (overallPct === null) ? "—" : (String(overallPct) + "%");
          nodes.roadmapSummary.innerHTML =
            "<span class='muted'>Progreso (items):</span> " +
            "<strong>" + t + "</strong> <span class='muted'>(tracked)</span>" +
            " · <strong>" + o + "</strong> <span class='muted'>(incluye manual/untracked)</span>" +
            " · <span class='mono muted'>" + trackedTotal + "/" + overallTotal + "</span>";
        }

        nodes.roadmapDashboard.innerHTML = phases.map((p) => {
          const pr = p.progress || {};
          const title = String(p.title || p.id || "Fase");
          const eng = String(p.points_eng || "");
          const hum = String(p.points_hum || "");
          const tracked = (pr.tracked_percent === 0 || pr.tracked_percent) ? pr.tracked_percent : null;
          const overall = (pr.overall_percent === 0 || pr.overall_percent) ? pr.overall_percent : null;
          const meter = (tracked === null) ? 0 : Math.max(0, Math.min(100, Number(tracked)));
          const next = Array.isArray(p.next) ? p.next : [];
          const nextList = next.length
            ? "<div class='list' style='margin-top:8px'><ul>" +
              next.slice(0, 5).map((it) => {
                const label = String(it.label || it.id || "—");
                const path = it.path ? (" <span class='mono muted'>" + String(it.path) + "</span>") : "";
                return "<li>" + statusPill(it.status) + " <strong>" + label + "</strong>" + path + "</li>";
              }).join("") +
              "</ul></div>"
            : "<div class='muted' style='margin-top:8px'>Sin siguientes acciones (fase completa o sin items).</div>";

          const meta = "<div class='scope-meta'><span class='mono'>ENG " + eng + "</span> · <span class='mono'>HUM " + hum + "</span></div>";
          const counts = "<div class='small muted'>DONE: " + Number(pr.done || 0) +
            " · PARTIAL: " + Number(pr.partial || 0) +
            " · TODO: " + Number(pr.todo || 0) +
            " · UNTRACKED: " + Number(pr.untracked || 0) +
            "</div>";
          const pctLine = "<div class='row'><span class='muted'>Progreso</span><span class='mono'>" +
            ((tracked === null) ? "—" : (String(tracked) + "%")) +
            " · <span class='muted'>overall:</span> " +
            ((overall === null) ? "—" : (String(overall) + "%")) +
            "</span></div>";

          return (
            "<article class='scope-card'>" +
            "<div class='scope-head'>" +
            "<div class='scope-title'>" + title + "</div>" +
            meta +
            "</div>" +
            pctLine +
            "<div class='meter'><span style='width:" + meter + "%'></span></div>" +
            counts +
            nextList +
            "</article>"
          );
        }).join("");
      }

      function renderRoadmapTechnicalDashboard(data) {
        if (!nodes.roadmapTechDashboard || !nodes.roadmapTechSummary || !nodes.roadmapTechKpis) return;
        const rd = data.roadmap_technical || {};
        const phases = Array.isArray(rd.phases) ? rd.phases : [];
        const summary = rd.summary || {};
        const programKpis = Array.isArray(rd.program_kpis) ? rd.program_kpis : [];

        if (!phases.length) {
          nodes.roadmapTechDashboard.innerHTML = "<div class='muted'>Roadmap técnico no disponible en /api/sources/status.</div>";
          nodes.roadmapTechSummary.textContent = "";
          nodes.roadmapTechKpis.innerHTML = "";
          return;
        }

        const trackedPct = (summary.tracked_percent === 0 || summary.tracked_percent) ? summary.tracked_percent : null;
        const overallPct = (summary.overall_percent === 0 || summary.overall_percent) ? summary.overall_percent : null;
        const trackedTotal = Number(summary.tracked_total || 0);
        const overallTotal = Number(summary.overall_total || 0);
        const notes = Array.isArray(rd.notes) ? rd.notes : [];

        nodes.roadmapTechSummary.innerHTML =
          "<span class='muted'>Progreso técnico:</span> " +
          "<strong>" + (trackedPct === null ? "—" : (String(trackedPct) + "%")) + "</strong> <span class='muted'>(tracked)</span>" +
          " · <strong>" + (overallPct === null ? "—" : (String(overallPct) + "%")) + "</strong> <span class='muted'>(overall)</span>" +
          " · <span class='mono muted'>" + trackedTotal + "/" + overallTotal + "</span>" +
          (notes.length ? " · <span class='muted'>" + notes.join(" · ") + "</span>" : "");

        nodes.roadmapTechDashboard.innerHTML = phases.map((p) => {
          const pr = p.progress || {};
          const title = String(p.title || p.id || "Fase");
          const eng = String(p.points_eng_raw || p.points_eng || "");
          const tracked = (pr.tracked_percent === 0 || pr.tracked_percent) ? pr.tracked_percent : null;
          const overall = (pr.overall_percent === 0 || pr.overall_percent) ? pr.overall_percent : null;
          const meter = (tracked === null) ? 0 : Math.max(0, Math.min(100, Number(tracked)));
          const next = Array.isArray(p.next) ? p.next : [];
          const checks = Array.isArray(p.checks) ? p.checks : [];

          const nextList = next.length
            ? "<div class='list' style='margin-top:8px'><ul>" +
              next.slice(0, 6).map((it) => {
                const label = String(it.label || it.id || "—");
                const actual = it.actual_display ? (" · <span class='mono muted'>" + String(it.actual_display) + "</span>") : "";
                const target = it.target_display && String(it.target_display) !== "—"
                  ? (" <span class='muted'>/ " + String(it.target_display) + "</span>")
                  : "";
                return "<li>" + statusPill(it.status) + " <strong>" + label + "</strong>" + actual + target + "</li>";
              }).join("") +
              "</ul></div>"
            : "<div class='muted' style='margin-top:8px'>Sin pendientes en esta fase.</div>";

          const checksBlock = checks.length
            ? "<details style='margin-top:8px'><summary class='scope-meta' style='cursor:pointer; font-weight:800'>Checks (" + checks.length + ")</summary>" +
              "<div class='list' style='margin-top:8px'><ul>" +
              checks.slice(0, 16).map((it) => {
                const label = String(it.label || it.id || "—");
                const actual = it.actual_display ? (" · <span class='mono'>" + String(it.actual_display) + "</span>") : "";
                const target = it.target_display && String(it.target_display) !== "—"
                  ? (" <span class='muted'>/ " + String(it.target_display) + "</span>")
                  : "";
                return "<li>" + statusPill(it.status) + " <strong>" + label + "</strong>" + actual + target + "</li>";
              }).join("") +
              (checks.length > 16 ? "<li class='muted'>+" + (checks.length - 16) + " checks más...</li>" : "") +
              "</ul></div></details>"
            : "";

          return (
            "<article class='scope-card'>" +
            "<div class='scope-head'>" +
            "<div class='scope-title'>" + title + "</div>" +
            "<div class='scope-meta'><span class='mono'>ENG " + eng + "</span></div>" +
            "</div>" +
            "<div class='row'><span class='muted'>Progreso</span><span class='mono'>" +
              (tracked === null ? "—" : (String(tracked) + "%")) +
              " · <span class='muted'>overall:</span> " +
              (overall === null ? "—" : (String(overall) + "%")) +
            "</span></div>" +
            "<div class='meter'><span style='width:" + meter + "%'></span></div>" +
            "<div class='small muted'>DONE: " + Number(pr.done || 0) +
              " · PARTIAL: " + Number(pr.partial || 0) +
              " · TODO: " + Number(pr.todo || 0) +
              " · UNTRACKED: " + Number(pr.untracked || 0) +
            "</div>" +
            nextList +
            checksBlock +
            "</article>"
          );
        }).join("");

        nodes.roadmapTechKpis.innerHTML = programKpis.length
          ? programKpis.map((kpi) => {
            const label = String(kpi.label || kpi.id || "KPI");
            const actual = String(kpi.actual_display || "—");
            const target = (kpi.target_display && String(kpi.target_display) !== "—") ? String(kpi.target_display) : "";
            return (
              "<div class='kpi'>" +
              "<p class='label'>KPI programa</p>" +
              "<div class='value'><strong>" + actual + "</strong>" + statusPill(kpi.status) + "</div>" +
              "<div class='small'>" + label + (target ? (" · target: " + target) : "") + "</div>" +
              "</div>"
            );
          }).join("")
          : "<div class='muted'>Sin KPIs de programa para mostrar.</div>";
      }

      function safeNum(x, fallback = 0) {
        const n = Number(x);
        return Number.isFinite(n) ? n : fallback;
      }

      function renderIdealRequirements(data) {
        const req = data && data.ideal_data_requirements ? data.ideal_data_requirements : null;
        if (!req) return "";

        const section = (title, items) => {
          if (!Array.isArray(items) || items.length === 0) return "";
          const rows = items
            .map((it) => {
              if (typeof it === "string") {
                return "<li>" + String(it) + "</li>";
              }
              const label = String(it.label || it.id || "item");
              const fields = Array.isArray(it.fields) ? it.fields : [];
              const body = fields.length ? "<ul class='small muted'>" + fields.map((f) => "<li>" + String(f) + "</li>").join("") + "</ul>" : "";
              return "<li><strong>" + label + "</strong>" + body + "</li>";
            })
            .join("");
          return (
            "<div class='card' style='margin-top:10px'>" +
            "<div class='row'><strong>" + title + "</strong><span class='pill muted'>north-star</span></div>" +
            "<ul style='margin:8px 0 0; padding-left:18px'>" +
            rows +
            "</ul></div>"
          );
        };

        return (
          "<div class='row' style='align-items:baseline; margin-top:14px'>" +
          "<div><strong>Datos ideales a capturar</strong></div>" +
          "<div class='mono muted'>docs/ideal_sources_say_do.json</div>" +
          "</div>" +
          section("Por político (por scope)", req.per_politician_per_scope) +
          section("Por topic_set", req.per_topic_set) +
          section("Por evidencia (atomic)", req.per_evidence_item) +
          section("Por fuente", req.per_source)
        );
      }

      function renderIdealSources() {
        if (!nodes.idealSources) return;
        const data = state.ideal || {};
        const sources = Array.isArray(data.sources) ? data.sources : [];
        if (!sources.length) {
          nodes.idealSources.innerHTML = "<div class='muted'>Sin inventario ideal (o endpoint no disponible).</div>";
          return;
        }

        const search = nodes.search ? nodes.search.value : "";
        const ev = nodes.idealEvidence ? String(nodes.idealEvidence.value || "") : "";
        const minConf = nodes.idealMinConfidence ? safeNum(nodes.idealMinConfidence.value, 0) : 0;

        const filtered = sources
          .filter((s) => {
            const c = safeNum(s.confidence, 0);
            if (c < minConf) return false;
            if (ev) {
              const sev = String(s.evidence || "").toLowerCase();
              if (sev !== String(ev).toLowerCase()) return false;
            }
            if (!matchSearch(search, s.name, s.id, s.jurisdiction, s.scope, (s.domains || []).join(" "), s.url, s.notes)) {
              return false;
            }
            return true;
          })
          .sort((a, b) => {
            const da = safeNum(b.confidence, 0) - safeNum(a.confidence, 0);
            if (da !== 0) return da;
            return String(a.name || a.id || "").localeCompare(String(b.name || b.id || ""));
          });

        const countBy = (pred) => filtered.filter(pred).length;
        const nDoes = countBy((s) => String(s.evidence || "").toLowerCase() === "does");
        const nSays = countBy((s) => String(s.evidence || "").toLowerCase() === "says");
        const nBoth = countBy((s) => String(s.evidence || "").toLowerCase() === "both");

        const head =
          "<div class='row' style='align-items:baseline; margin-bottom:8px'>" +
          "<div><strong>" +
          filtered.length +
          "</strong> fuentes · <span class='muted'>does:</span> <span class='mono'>" +
          nDoes +
          "</span> · <span class='muted'>says:</span> <span class='mono'>" +
          nSays +
          "</span> · <span class='muted'>both:</span> <span class='mono'>" +
          nBoth +
          "</span></div>" +
          "<div class='mono muted'>/api/sources/ideal</div>" +
          "</div>";

        const rows = filtered
          .slice(0, 120)
          .map((s) => {
            const conf = safeNum(s.confidence, 0);
            const ev2 = String(s.evidence || "").toLowerCase();
            const evBadge = ev2 === "does" ? "ok" : ev2 === "says" ? "warn" : "";
            const badge = "<span class='pill " + (evBadge || "muted") + "'>" + (ev2 || "—") + "</span>";
            const url = s.url ? "<a class='mono' href='" + String(s.url) + "' target='_blank' rel='noopener'>url</a>" : "<span class='muted'>url: —</span>";
            const dom = Array.isArray(s.domains) ? s.domains.slice(0, 6).join(", ") : "";
            const access = Array.isArray(s.access) ? s.access.join(", ") : "";
            const fmt = Array.isArray(s.formats) ? s.formats.join(", ") : "";
            const meta = [
              "id=" + String(s.id || ""),
              "conf=" + String(conf),
              s.jurisdiction ? "jur=" + String(s.jurisdiction) : "",
              s.scope ? "scope=" + String(s.scope) : "",
              access ? "access=" + access : "",
              fmt ? "fmt=" + fmt : "",
            ].filter(Boolean).join(" · ");
            const notes = s.notes ? "<div class='small muted'>" + String(s.notes) + "</div>" : "";
            const domLine = dom ? "<div class='small muted'>dominios: " + String(dom) + "</div>" : "";
            return (
              "<div class='card' style='margin-top:8px'>" +
              "<div class='row'><strong>" + String(s.name || s.id || "—") + "</strong>" + badge + "</div>" +
              "<div class='mono'>" + meta + "</div>" +
              "<div class='row' style='margin-top:6px; align-items:baseline'>" + url + "</div>" +
              domLine +
              notes +
              "</div>"
            );
          })
          .join("");

        const more = filtered.length > 120 ? "<div class='muted' style='margin-top:10px'>+" + (filtered.length - 120) + " más… (usa filtros/búsqueda)</div>" : "";
        nodes.idealSources.innerHTML = head + rows + more + renderIdealRequirements(data);
      }

      function fillAdvancedFilters(data) {
        const sources = Array.isArray(data.sources) ? data.sources : [];
        const scopes = [...new Set(sources.map((s) => normalizeScope(s.scope)).filter((s) => s && s !== "unknown"))]
          .sort((a, b) => {
            const d = scopeSortKey(a) - scopeSortKey(b);
            if (d !== 0) return d;
            return String(a).localeCompare(String(b));
          });
        const statesSource = data && data.summary && Array.isArray(data.summary.states) ? data.summary.states : [];
        const states = [...new Set(statesSource)].filter(Boolean).sort();
        const trackerItems = data && data.tracker && Array.isArray(data.tracker.items) ? data.tracker.items : [];
        const trackerDomains = [...new Set(trackerItems.map((it) => String(it.dominio || "").trim()).filter(Boolean))]
          .sort((a, b) => String(a).localeCompare(String(b)));

        if (nodes.filterScope) {
          const keep = nodes.filterScope.options[0] ? nodes.filterScope.options[0].outerHTML : "<option value=''>Ámbito: Todos</option>";
          nodes.filterScope.innerHTML = keep;
          scopes.forEach((scope) => {
            const option = document.createElement("option");
            option.value = scope;
            option.textContent = "Ámbito: " + scopeLabel(scope);
            nodes.filterScope.appendChild(option);
          });
        }
        if (nodes.filterState) {
          const keep = nodes.filterState.options[0] ? nodes.filterState.options[0].outerHTML : "<option value=''>Estado operativo: Todos</option>";
          nodes.filterState.innerHTML = keep;
          states.forEach((st) => {
            const option = document.createElement("option");
            option.value = st;
            option.textContent = "Estado operativo: " + labelState(st);
            nodes.filterState.appendChild(option);
          });
        }

        if (nodes.filterTrackerDomain) {
          const keep = nodes.filterTrackerDomain.options[0]
            ? nodes.filterTrackerDomain.options[0].outerHTML
            : "<option value=''>Dominio (roadmap): Todos</option>";
          nodes.filterTrackerDomain.innerHTML = keep;
          trackerDomains.forEach((d) => {
            const option = document.createElement("option");
            option.value = d.toUpperCase();
            option.textContent = "Dominio: " + d;
            nodes.filterTrackerDomain.appendChild(option);
          });
        }
      }

      function scopeLabel(scope) {
        const s = String(scope || "").toLowerCase();
        const map = {
          nacional: "Nacional",
          autonomico: "Autonómico",
          municipal: "Municipal",
          europeo: "Europeo",
          territorial: "Territorial (catálogo/población)",
          multi: "Multi-ámbito",
          "": "Sin ámbito",
          unknown: "Sin ámbito",
        };
        return map[s] || (s ? s : "Sin ámbito");
      }

      function scopeSortKey(scope) {
        const s = String(scope || "").toLowerCase();
        const order = {
          nacional: 0,
          autonomico: 1,
          municipal: 2,
          europeo: 3,
          territorial: 4,
          multi: 8,
          "": 9,
          unknown: 9,
        };
        return order[s] !== undefined ? order[s] : 7;
      }

      function actionPriorityWeight(action) {
        const prio = String(action && action.priority ? action.priority : "P2").toUpperCase();
        if (prio === "P0") return 0;
        if (prio === "P1") return 1;
        if (prio === "P2") return 2;
        return 9;
      }

      function normalizeScope(scope) {
        const s = String(scope || "").toLowerCase().trim();
        return s || "unknown";
      }

      function matchSearch(search, ...parts) {
        const s = (search || "").toLowerCase().trim();
        if (!s) return true;
        const blob = parts.filter(Boolean).join(" ").toLowerCase();
        return blob.includes(s);
      }

      function campaignTokenScore(text, tokens) {
        if (!text || !Array.isArray(tokens) || !tokens.length) return 0;
        return tokens.reduce((acc, token) => acc + (text.includes(String(token || "").toLowerCase()) ? 1 : 0), 0);
      }

      function selectCampaignTerritory(text, tokenField) {
        let bestId = "";
        let bestScore = 0;
        CAMPAIGN_TERRITORIES.forEach((territory) => {
          const score = campaignTokenScore(text, territory[tokenField]);
          if (score > bestScore) {
            bestScore = score;
            bestId = territory.id;
          }
        });
        return bestScore > 0 ? bestId : "";
      }

      function classifyCampaignStatusSource(row) {
        const text = [row && row.source_id, row && row.source_name, row && row.scope, row && row.domain, row && row.format]
          .filter(Boolean)
          .join(" ")
          .toLowerCase();
        const selected = selectCampaignTerritory(text, "status_tokens");
        if (selected) return selected;

        const scope = normalizeScope(row && row.scope ? row.scope : "");
        if (scope === "dinero") return "public_money";
        if (scope === "electoral") return "electoral";
        if (scope === "legal") return "legal";
        if (scope === "outcomes" || scope === "territorial") return "context";

        const domain = String(row && row.domain ? row.domain : "").toLowerCase();
        if (domain === "parlamentario") return "parliament";
        if (domain === "infoelectoral") return "electoral";
        return "unknown";
      }

      function classifyCampaignIdealSource(row) {
        const text = [row && row.id, row && row.name, row && row.evidence, row && row.scope, Array.isArray(row && row.domains) ? row.domains.join(" ") : ""]
          .filter(Boolean)
          .join(" ")
          .toLowerCase();
        const selected = selectCampaignTerritory(text, "ideal_tokens");
        if (selected) return selected;
        return "unknown";
      }

      function createCampaignBucket(definition) {
        return {
          id: definition.id,
          name: definition.name,
          flavor: definition.flavor,
          domain_hints: Array.isArray(definition.domain_hints) ? definition.domain_hints.slice() : [],
          source_rows: [],
          ideal_rows: [],
          desired_count: 0,
          extra_count: 0,
          capture_points: 0,
          bonus_points: 0,
          ok: 0,
          partial: 0,
          running: 0,
          pending: 0,
          failed: 0,
          blocked: 0,
          progress_loaded: 0,
          progress_target: 0,
        };
      }

      function campaignTierFromPercent(percent) {
        if (percent >= 80) return "captured";
        if (percent >= 45) return "contested";
        return "frontier";
      }

      function formatOneDecimal(value) {
        const rounded = Math.round(safeNum(value, 0) * 10) / 10;
        if (Number.isInteger(rounded)) return String(rounded);
        return rounded.toFixed(1);
      }

      function buildCampaignModel(data, idealData) {
        const buckets = new Map();
        CAMPAIGN_TERRITORIES.forEach((def) => buckets.set(def.id, createCampaignBucket(def)));
        buckets.set("unknown", createCampaignBucket({
          id: "unknown",
          name: "Frontera no clasificada",
          flavor: "Conectores o fuentes ideales que aun no encajan en una clase.",
          domain_hints: ["pendiente", "clasificacion"],
        }));

        const sources = Array.isArray(data && data.sources) ? data.sources : [];
        sources.forEach((row) => {
          const territoryId = classifyCampaignStatusSource(row);
          const bucket = buckets.get(territoryId) || buckets.get("unknown");
          if (!bucket) return;
          bucket.source_rows.push(row);

          const stateName = String(row && row.state ? row.state : "unknown").toLowerCase();
          if (stateName === "ok") bucket.ok += 1;
          else if (stateName === "partial") bucket.partial += 1;
          else if (stateName === "running") bucket.running += 1;
          else if (stateName === "not_run") bucket.pending += 1;
          else bucket.failed += 1;

          if (row && row.tracker && row.tracker.blocked_note) {
            bucket.blocked += 1;
          }

          const weight = CAMPAIGN_STATE_WEIGHT[stateName] !== undefined ? CAMPAIGN_STATE_WEIGHT[stateName] : CAMPAIGN_STATE_WEIGHT.unknown;
          const isDesired = row && row.desired !== false;
          if (isDesired) {
            bucket.desired_count += 1;
            bucket.capture_points += weight;
          } else {
            bucket.extra_count += 1;
            bucket.bonus_points += weight;
          }

          const progress = row && row.progress ? row.progress : {};
          const target = safeNum(progress.target, 0);
          const loaded = safeNum(progress.loaded, 0);
          if (isDesired && target > 0) {
            bucket.progress_target += target;
            bucket.progress_loaded += Math.min(Math.max(loaded, 0), target);
          }
        });

        const idealSources = Array.isArray(idealData && idealData.sources) ? idealData.sources : [];
        idealSources.forEach((row) => {
          const territoryId = classifyCampaignIdealSource(row);
          const bucket = buckets.get(territoryId) || buckets.get("unknown");
          if (!bucket) return;
          bucket.ideal_rows.push(row);
        });

        const territories = Array.from(buckets.values())
          .map((bucket) => {
            const domainCounts = {};
            bucket.ideal_rows.forEach((item) => {
              const domains = Array.isArray(item && item.domains) ? item.domains : [];
              domains.forEach((domain) => {
                const key = String(domain || "").trim();
                if (!key) return;
                domainCounts[key] = safeNum(domainCounts[key], 0) + 1;
              });
            });

            let domainTags = Object.keys(domainCounts)
              .sort((a, b) => safeNum(domainCounts[b], 0) - safeNum(domainCounts[a], 0) || String(a).localeCompare(String(b)))
              .slice(0, 5);
            if (!domainTags.length) {
              domainTags = bucket.domain_hints.slice(0, 5);
            }

            const targetSlots = Math.max(bucket.ideal_rows.length, bucket.desired_count);
            const conquestPercent = targetSlots > 0
              ? Math.max(0, Math.min(100, Math.round((bucket.capture_points * 100) / targetSlots)))
              : 0;
            const progressPercent = bucket.progress_target > 0
              ? Math.max(0, Math.min(100, Math.round((bucket.progress_loaded * 100) / bucket.progress_target)))
              : null;
            const unmappedBacklog = Math.max(0, bucket.ideal_rows.length - bucket.desired_count);

            const sourceRowsSorted = bucket.source_rows
              .slice()
              .sort((a, b) => {
                const stateWeight = (row) => {
                  const st = String(row && row.state ? row.state : "unknown").toLowerCase();
                  const w = CAMPAIGN_STATE_WEIGHT[st];
                  return w === undefined ? 0 : w;
                };
                const dw = stateWeight(b) - stateWeight(a);
                if (dw !== 0) return dw;
                return String(a.source_name || a.source_id || "").localeCompare(String(b.source_name || b.source_id || ""));
              });

            return {
              id: bucket.id,
              name: bucket.name,
              flavor: bucket.flavor,
              source_rows: sourceRowsSorted,
              ideal_rows: bucket.ideal_rows.slice(),
              desired_count: bucket.desired_count,
              extra_count: bucket.extra_count,
              capture_points: bucket.capture_points,
              bonus_points: bucket.bonus_points,
              target_slots: targetSlots,
              conquest_percent: conquestPercent,
              progress_loaded: bucket.progress_loaded,
              progress_target: bucket.progress_target,
              progress_percent: progressPercent,
              blocked: bucket.blocked,
              ok: bucket.ok,
              partial: bucket.partial,
              running: bucket.running,
              pending: bucket.pending,
              failed: bucket.failed,
              unmapped_backlog: unmappedBacklog,
              domain_tags: domainTags,
              tier: campaignTierFromPercent(conquestPercent),
            };
          })
          .filter((bucket) => bucket.source_rows.length > 0 || bucket.ideal_rows.length > 0);

        const campaignTerritories = territories.filter((item) => item.id !== "unknown");
        const targetTotal = campaignTerritories.reduce((acc, item) => acc + item.target_slots, 0);
        const captureTotal = campaignTerritories.reduce((acc, item) => acc + item.capture_points, 0);
        const sourceTotal = campaignTerritories.reduce((acc, item) => acc + item.source_rows.length, 0);
        const idealTotal = campaignTerritories.reduce((acc, item) => acc + item.ideal_rows.length, 0);
        const blockedTotal = campaignTerritories.reduce((acc, item) => acc + item.blocked, 0);
        const unresolvedTotal = campaignTerritories.reduce((acc, item) => acc + item.partial + item.running + item.pending + item.failed, 0);
        const unmappedTotal = campaignTerritories.reduce((acc, item) => acc + item.unmapped_backlog, 0);
        const percent = targetTotal > 0 ? Math.max(0, Math.min(100, Math.round((captureTotal * 100) / targetTotal))) : 0;

        return {
          territories,
          summary: {
            percent,
            target_total: targetTotal,
            capture_total: captureTotal,
            source_total: sourceTotal,
            ideal_total: idealTotal,
            blocked_total: blockedTotal,
            unresolved_total: unresolvedTotal,
            unmapped_total: unmappedTotal,
          },
        };
      }

      function renderCampaignMap(data, idealData) {
        if (!nodes.campaignMap) return;
        const model = buildCampaignModel(data || {}, idealData || {});
        const territories = model.territories || [];
        if (!territories.length) {
          nodes.campaignMap.innerHTML = "<div class='muted'>Sin datos para construir el mapa de conquista.</div>";
          if (nodes.campaignAt) nodes.campaignAt.textContent = "";
          return;
        }

        const summary = model.summary || {};
        const globalPercent = safeNum(summary.percent, 0);
        const hud =
          "<div class='campaign-hud'>" +
            "<div class='campaign-hud-head'>" +
              "<div class='campaign-hud-title'>Conquista global del territorio de datos</div>" +
              "<div class='mono muted'>" + globalPercent + "%</div>" +
            "</div>" +
            "<div class='campaign-meter'><span style='width:" + globalPercent + "%'></span></div>" +
            "<div class='campaign-statline'><span>Nodos conquistados</span><span class='mono'>" + formatOneDecimal(summary.capture_total || 0) + " / " + safeNum(summary.target_total, 0) + "</span></div>" +
            "<div class='campaign-hud-kpis'>" +
              "<div class='campaign-hud-kpi'><p class='label'>Territorios activos</p><strong>" + territories.length + "</strong></div>" +
              "<div class='campaign-hud-kpi'><p class='label'>Fuentes conectadas</p><strong>" + safeNum(summary.source_total, 0) + "</strong></div>" +
              "<div class='campaign-hud-kpi'><p class='label'>Inventario ideal</p><strong>" + safeNum(summary.ideal_total, 0) + "</strong></div>" +
              "<div class='campaign-hud-kpi'><p class='label'>Pendiente/Degradado</p><strong>" + safeNum(summary.unresolved_total, 0) + "</strong></div>" +
              "<div class='campaign-hud-kpi'><p class='label'>Sin conector</p><strong>" + safeNum(summary.unmapped_total, 0) + "</strong></div>" +
              "<div class='campaign-hud-kpi'><p class='label'>Bloqueadas</p><strong>" + safeNum(summary.blocked_total, 0) + "</strong></div>" +
            "</div>" +
          "</div>";

        const cards = territories
          .map((territory) => {
            const sourceRows = Array.isArray(territory.source_rows) ? territory.source_rows : [];
            const domains = Array.isArray(territory.domain_tags) ? territory.domain_tags : [];
            const tagsHtml = domains.length
              ? domains.map((domain) => "<span class='campaign-tag'>" + String(domain) + "</span>").join("")
              : "<span class='campaign-tag'>sin etiquetas</span>";

            const chips = [
              "<span class='campaign-chip ok'>OK " + safeNum(territory.ok, 0) + "</span>",
              "<span class='campaign-chip warn'>PARCIAL/RUN " + (safeNum(territory.partial, 0) + safeNum(territory.running, 0)) + "</span>",
              "<span class='campaign-chip'>PENDIENTE " + safeNum(territory.pending, 0) + "</span>",
              "<span class='campaign-chip err'>ERROR " + safeNum(territory.failed, 0) + "</span>",
            ];
            if (territory.blocked > 0) {
              chips.push("<span class='campaign-chip err'>BLOCKED " + territory.blocked + "</span>");
            }
            if (territory.unmapped_backlog > 0) {
              chips.push("<span class='campaign-chip warn'>SIN CONECTOR " + territory.unmapped_backlog + "</span>");
            }

            const sourceRowsHtml = sourceRows.length
              ? "<details class='campaign-list'><summary>Ver fuentes (" + sourceRows.length + ")</summary><ul>" +
                sourceRows.slice(0, 8).map((row) => {
                  const stateName = String(row && row.state ? row.state : "unknown");
                  const stateBadge = "<span class='pill " + stateClass(String(stateName).toLowerCase()) + "'>" + labelState(String(stateName).toLowerCase()) + "</span>";
                  const sourceName = row.source_name || row.source_id || "source";
                  const sourceId = row.source_id ? (" <span class='mono muted'>(" + String(row.source_id) + ")</span>") : "";
                  return "<li>" + stateBadge + " <strong>" + String(sourceName) + "</strong>" + sourceId + "</li>";
                }).join("") +
                (sourceRows.length > 8 ? "<li class='muted'>+" + (sourceRows.length - 8) + " mas...</li>" : "") +
                "</ul></details>"
              : "<div class='small muted' style='margin-top:8px'>Sin conectores en este territorio todavia.</div>";

            const progressLine = territory.progress_percent === null
              ? "<div class='campaign-statline'><span>Metas minimas</span><span class='mono'>sin objetivo cuantificable</span></div>"
              : "<div class='campaign-statline'><span>Metas minimas</span><span class='mono'>" +
                safeNum(territory.progress_loaded, 0) + " / " + safeNum(territory.progress_target, 0) + " (" + territory.progress_percent + "%)</span></div>" +
                "<div class='campaign-meter secondary'><span style='width:" + territory.progress_percent + "%'></span></div>";

            return (
              "<article class='campaign-territory' data-tier='" + territory.tier + "'>" +
                "<div class='campaign-head'>" +
                  "<div><div class='campaign-name'>" + territory.name + "</div><div class='small'>" + territory.flavor + "</div></div>" +
                  "<div class='campaign-percent'>" + territory.conquest_percent + "%</div>" +
                "</div>" +
                "<div class='campaign-meter'><span style='width:" + territory.conquest_percent + "%'></span></div>" +
                "<div class='campaign-statline'><span>Conquista</span><span class='mono'>" +
                  formatOneDecimal(territory.capture_points) + " / " + safeNum(territory.target_slots, 0) + " nodos</span></div>" +
                progressLine +
                "<div class='campaign-legend'>" + chips.join("") + "</div>" +
                "<div class='campaign-tags'>" + tagsHtml + "</div>" +
                sourceRowsHtml +
              "</article>"
            );
          })
          .join("");

        nodes.campaignMap.innerHTML = hud + "<div class='campaign-board'>" + cards + "</div>";
        if (nodes.campaignAt) {
          nodes.campaignAt.textContent = "Actualizado: " + formatDate((data && data.generated_at) || "");
        }
      }

      function scopeFromAction(action, byId) {
        const explicit = normalizeScope(action && action.scope ? action.scope : "");
        if (explicit && explicit !== "unknown") {
          return explicit;
        }
        const ids = Array.isArray(action && action.source_ids) ? action.source_ids : [];
        if (!ids.length) {
          return "unknown";
        }
        const scopes = new Set();
        ids.forEach((sid) => {
          const row = byId.get(String(sid));
          if (row) {
            scopes.add(normalizeScope(row.scope));
          }
        });
        if (scopes.size === 1) return Array.from(scopes)[0];
        if (scopes.size > 1) return "multi";
        return "unknown";
      }

      function scopeCoverageProgress(rows) {
        let loaded = 0;
        let target = 0;
        rows.forEach((r) => {
          const p = r && r.progress ? r.progress : null;
          const t = p && Number.isFinite(p.target) ? Number(p.target) : 0;
          const l = p && Number.isFinite(p.loaded) ? Number(p.loaded) : 0;
          if (t > 0) {
            target += t;
            loaded += Math.min(l, t);
          }
        });
        if (!target) {
          return { percent: null, loaded: 0, target: 0 };
        }
        const percent = Math.max(0, Math.min(100, Math.round((loaded * 100) / target)));
        return { percent, loaded, target };
      }

      function renderScopeDashboard(data) {
        if (!nodes.scopeDashboard) {
          return;
        }
        const mode = (nodes.viewMode && nodes.viewMode.value) ? nodes.viewMode.value : "ops";
        const search = nodes.search ? nodes.search.value : "";
        const filterState = nodes.filterState ? nodes.filterState.value : "";
        const filterScope = nodes.filterScope ? nodes.filterScope.value : "";
        const filterDesired = nodes.filterDesired ? nodes.filterDesired.value : "";
        const filterTrackerDomain = nodes.filterTrackerDomain ? nodes.filterTrackerDomain.value : "";
        const filterRoadmap = nodes.filterRoadmap ? nodes.filterRoadmap.value : "";
        const actionsAll = Array.isArray(data.actions) ? data.actions : [];
        const sourcesAll = Array.isArray(data.sources) ? data.sources : [];
        const sourcesWanted = sourcesAll.filter((r) => {
          if (!matchSearch(search, r.source_id, r.source_name, r.scope, r.domain, r.format, r.default_url)) {
            return false;
          }
          if (filterScope && normalizeScope(r.scope) !== normalizeScope(filterScope)) {
            return false;
          }
          if (filterState && String(r.state || "") !== String(filterState)) {
            return false;
          }
          if (filterDesired === "desired" && !r.desired) {
            return false;
          }
          if (filterDesired === "extra" && r.desired) {
            return false;
          }
          if (filterTrackerDomain) {
            const td = (r.tracker && r.tracker.dominio) ? String(r.tracker.dominio).toUpperCase() : "";
            if (String(filterTrackerDomain).toUpperCase() !== td) {
              return false;
            }
          }
          if (filterRoadmap) {
            const trackerStatus = (r.tracker && r.tracker.status) ? String(r.tracker.status).toUpperCase() : "N/A";
            if (String(filterRoadmap).toUpperCase() !== trackerStatus) {
              return false;
            }
          }
          return true;
        });
        const tracker = data.tracker || {};
        const roadmapAll = Array.isArray(tracker.unmapped) ? tracker.unmapped : [];

        const byId = new Map();
        sourcesAll.forEach((r) => {
          if (r && r.source_id) byId.set(String(r.source_id), r);
        });

        const roadmap = roadmapAll
          .filter((it) => ["TODO", "PARTIAL"].includes(String(it.estado || "").toUpperCase()))
          .filter((it) => matchSearch(search, it.fuentes_objetivo, it.tipo_dato, it.dominio, it.bloque, it.scope))
          .filter((it) => {
            if (filterScope && normalizeScope(it.scope) !== normalizeScope(filterScope)) {
              return false;
            }
            if (filterTrackerDomain && String(filterTrackerDomain).toUpperCase() !== String(it.dominio || "").toUpperCase()) {
              return false;
            }
            if (filterRoadmap && String(filterRoadmap).toUpperCase() !== String(it.estado || "").toUpperCase()) {
              return false;
            }
            return true;
          });

        const byScope = new Map();
        function ensure(scope) {
          const key = normalizeScope(scope);
          if (!byScope.has(key)) {
            byScope.set(key, { scope: key, sources: [], roadmap: [], actions: [] });
          }
          return byScope.get(key);
        }

        sourcesWanted.forEach((r) => ensure(r.scope).sources.push(r));
        roadmap.forEach((it) => ensure(it.scope).roadmap.push(it));

        const actionFiltered = mode === "ops"
          ? actionsAll.filter((a) => ["P0", "P1"].includes(String(a.priority || "").toUpperCase()))
          : actionsAll.slice();

        actionFiltered.forEach((a) => {
          const s = scopeFromAction(a, byId);
          ensure(s).actions.push(a);
        });

        const scopes = Array.from(byScope.keys()).sort((a, b) => {
          const da = scopeSortKey(a) - scopeSortKey(b);
          if (da !== 0) return da;
          return String(a).localeCompare(String(b));
        });

        if (!scopes.length) {
          nodes.scopeDashboard.innerHTML = "<div class='muted'>Sin datos.</div>";
          return;
        }

        nodes.scopeDashboard.innerHTML = scopes
          .map((scopeKey) => {
            const group = byScope.get(scopeKey);
            const rows = (group.sources || []).slice();
            const rowsSorted = rows.sort((a, b) => String(a.source_name || a.source_id || "").localeCompare(String(b.source_name || b.source_id || "")));

            const issues = rowsSorted.filter((r) => String(r.state || "").toLowerCase() !== "ok");
            const ok = rowsSorted.length - issues.length;
            const coverage = scopeCoverageProgress(rowsSorted);
            const roadmapItems = (group.roadmap || []).slice();
            const actions = (group.actions || []).slice().sort((a, b) => actionPriorityWeight(a) - actionPriorityWeight(b));

            const pendingCount = issues.length + roadmapItems.length + actions.length;
            if (mode === "ops" && pendingCount === 0) {
              return "";
            }

            const opPercent = rowsSorted.length ? Math.round((ok * 100) / rowsSorted.length) : null;
            const coveragePercent = coverage.percent;

            const issuesBlock = issues.length
              ? "<details open><summary class='scope-meta' style='cursor:pointer; font-weight:800'>Pendiente / degradado (" + pendingCount + ")</summary>" +
                "<div class='list' style='margin-top:8px'>" +
                "<ul>" +
                issues.slice(0, 24).map((r) => {
                  const st = String(r.state || "unknown");
                  const badge = "<span class='pill " + stateClass(st) + "'>" + labelState(st) + "</span>";
                  const desiredTag = r.desired ? "<span class='meta'>Objetivo</span>" : "<span class='meta'>Extra</span>";
                  const url = r.default_url ? "<a class='mono' href='" + r.default_url + "' target='_blank' rel='noopener'>fuente</a>" : "<span class='muted'>fuente: —</span>";
                  const prog = progressBadge(r.progress || {});
                  return "<li>" + badge + " " + desiredTag + " <strong>" + (r.source_name || r.source_id) + "</strong> <span class='muted'>(" + (r.source_id || "") + ")</span> · " + prog + " · " + url + "</li>";
                }).join("") +
                (issues.length > 24 ? "<li class='muted'>+" + (issues.length - 24) + " más… (usa búsqueda)</li>" : "") +
                "</ul>" +
                "</div>" +
                (actions.length ? "<details style='margin-top:10px'><summary class='scope-meta' style='cursor:pointer; font-weight:800'>Acciones (" + actions.length + ")</summary><div class='actions-grid' style='margin-top:8px'>" +
                  actions.slice(0, 12).map((a) => {
                    const prio = (a.priority || "P2").toUpperCase();
                    const prioClass = prio === "P0" ? "err" : prio === "P1" ? "warn" : "muted";
                    const details = a.details || "";
                    const cmds = (a.commands || []).filter(Boolean);
                    const cmdBlock = cmds.length
                      ? "<details style='margin-top:8px'><summary class='muted' style='cursor:pointer; font-weight:700'>Ver comandos</summary><pre class='cmd'>" + cmds.join("\n") + "</pre></details>"
                      : "";
                    return "<div class='action'><div class='action-head'><span class='pill " + prioClass + "'>" + prio + "</span><span class='mono muted'>" + actionKindLabel(a.kind || "") + "</span></div><div class='action-title'>" + (a.title || "") + "</div>" + (details ? "<p class='action-meta'>" + details + "</p>" : "") + cmdBlock + "</div>";
                  }).join("") +
                  (actions.length > 12 ? "<div class='muted'>+" + (actions.length - 12) + " más…</div>" : "") +
                  "</div></details>" : "") +
                (roadmapItems.length ? "<details style='margin-top:10px'><summary class='scope-meta' style='cursor:pointer; font-weight:800'>Roadmap sin conector (" + roadmapItems.length + ")</summary><div class='list' style='margin-top:8px'><ul>" +
                  roadmapItems.slice(0, 24).map((it) => {
                    const e = String(it.estado || "").toUpperCase();
                    const pill = roadmapPill(e);
                    const label = (it.fuentes_objetivo || it.tipo_dato || "—").trim();
                    const inf = it.scope_inferred ? " · <span class='muted'>ámbito inferido</span>" : "";
                    const bloque = it.bloque ? " · <span class='muted'>" + String(it.bloque).trim() + "</span>" : "";
                    return "<li>" + pill + " <strong>" + label + "</strong>" + inf + bloque + "</li>";
                  }).join("") +
                  (roadmapItems.length > 24 ? "<li class='muted'>+" + (roadmapItems.length - 24) + " más…</li>" : "") +
                  "</ul></div></details>" : "") +
                "</details>"
              : "<div class='scope-meta'>Sin pendientes.</div>";

            const sourcesBlock = rowsSorted.length
              ? "<details" + (mode === "all" ? " open" : "") + " style='margin-top:10px'><summary class='scope-meta' style='cursor:pointer; font-weight:800'>Fuentes (config) (" + rowsSorted.length + ")</summary><div class='list' style='margin-top:8px'><ul>" +
                rowsSorted.slice(0, 80).map((r) => {
                  const st = String(r.state || "unknown");
                  const badge = "<span class='pill " + stateClass(st) + "'>" + labelState(st) + "</span>";
                  const prog = progressBadge(r.progress || {});
                  const url = r.default_url ? "<a class='mono' href='" + r.default_url + "' target='_blank' rel='noopener'>fuente</a>" : "<span class='muted'>fuente: —</span>";
                  const last = r.last_seen_at || r.last_started_at || "";
                  const lastTxt = last ? (" · <span class='muted'>última: " + formatDate(last) + "</span>") : "";
                  const roadmapP = roadmapPill(r.tracker && r.tracker.status ? r.tracker.status : "");
                  const sqlP = sqlPill(r.sql_status || "");
                  const desiredTag = r.desired ? "<span class='meta'>Objetivo</span>" : "<span class='meta'>Extra</span>";
                  return "<li>" + badge + " " + desiredTag + " " + roadmapP + " " + sqlP + " <strong>" + (r.source_name || r.source_id) + "</strong> <span class='muted'>(" + (r.source_id || "") + ")</span> · " + prog + " · " + url + lastTxt + "</li>";
                }).join("") +
                (rowsSorted.length > 80 ? "<li class='muted'>+" + (rowsSorted.length - 80) + " más… (usa búsqueda)</li>" : "") +
                "</ul></div></details>"
              : "<div class='scope-meta'>Fuentes (config): 0</div>";

            const meters =
              "<div style='display:grid; gap:8px; margin-top:8px'>" +
              "<div><div class='row'><span class='muted'>Operativo</span><span class='mono'>" + (opPercent === null ? "—" : (ok + "/" + rowsSorted.length + " (" + opPercent + "%)")) + "</span></div>" +
              "<div class='meter'><span style='width:" + (opPercent === null ? 0 : opPercent) + "%'></span></div></div>" +
              "<div><div class='row'><span class='muted'>Cobertura (metas mínimas)</span><span class='mono'>" + (coveragePercent === null ? "—" : (coverage.loaded + "/" + coverage.target + " (" + coveragePercent + "%)")) + "</span></div>" +
              "<div class='meter'><span style='width:" + (coveragePercent === null ? 0 : coveragePercent) + "%'></span></div></div>" +
              "</div>";

            return (
              "<article class='scope-card'>" +
              "<div class='scope-head'>" +
              "<div class='scope-title'>" + scopeLabel(scopeKey) + "</div>" +
              "<div class='scope-meta'><span class='mono'>" + rowsSorted.length + "</span> fuentes · <span class='mono'>" + roadmapItems.length + "</span> roadmap</div>" +
              "</div>" +
              meters +
              "<div style='margin-top:10px'>" + issuesBlock + "</div>" +
              sourcesBlock +
              "</article>"
            );
          })
          .join("") || "<div class='muted'>No hay pendientes para mostrar en Operación (hoy). Cambia a inventario completo.</div>";
      }

      async function loadData() {
        if (nodes.scopeDashboard) {
          nodes.scopeDashboard.innerHTML = "<div class='muted'>Actualizando...</div>";
        }
        if (nodes.campaignMap) {
          nodes.campaignMap.innerHTML = "<div class='muted'>Actualizando mapa de conquista...</div>";
        }
        try {
          const [payload, idealPayload] = await Promise.all([
            fetchPayload({ apiPath: "/api/sources/status", staticPath: STATIC_STATUS_PATH }),
            fetchPayload({ apiPath: "/api/sources/ideal", staticPath: STATIC_IDEAL_PATH, allowMissing: true }),
          ]);
          if (payload.error) {
            if (nodes.scopeDashboard) {
              nodes.scopeDashboard.innerHTML = "<div class='muted'>" + payload.error + "</div>";
            }
            if (nodes.campaignMap) {
              nodes.campaignMap.innerHTML = "<div class='muted'>" + payload.error + "</div>";
            }
            return;
          }
          state.data = payload;
          state.ideal = idealPayload;
          renderGlobalProgress(payload);
          renderRoadmapDashboard(payload);
          renderRoadmapTechnicalDashboard(payload);
          renderCampaignMap(payload, idealPayload);
          fillAdvancedFilters(payload);
          nodes.refreshAt.textContent = "Actualizado: " + formatDate(payload.generated_at || "");
          renderScopeDashboard(payload);
          renderIdealSources();
        } catch (error) {
          if (nodes.scopeDashboard) {
            nodes.scopeDashboard.innerHTML = "<div class='muted'>No se pudo cargar /api/sources/status: " + String(error) + "</div>";
          }
          if (nodes.campaignMap) {
            nodes.campaignMap.innerHTML = "<div class='muted'>No se pudo construir el mapa de conquista: " + String(error) + "</div>";
          }
        }
      }

      function refresh() {
        if (state.data) {
          renderCampaignMap(state.data, state.ideal);
          renderScopeDashboard(state.data);
          renderIdealSources();
        }
      }

      nodes.refresh.addEventListener("click", loadData);
      nodes.search.addEventListener("input", refresh);
      nodes.filterState.addEventListener("change", refresh);
      nodes.filterScope.addEventListener("change", refresh);
      nodes.filterDesired.addEventListener("change", refresh);
      nodes.filterTrackerDomain.addEventListener("change", refresh);
      nodes.filterRoadmap.addEventListener("change", refresh);
      nodes.viewMode.addEventListener("change", () => {
        setParam("view", nodes.viewMode.value === "all" ? "all" : "ops");
        refresh();
      });
      if (nodes.idealEvidence) nodes.idealEvidence.addEventListener("change", refresh);
      if (nodes.idealMinConfidence) nodes.idealMinConfidence.addEventListener("change", refresh);

      // Initialize view mode from URL.
      {
        const view = (getParam("view") || "").toLowerCase();
        nodes.viewMode.value = view === "all" ? "all" : "ops";
      }

      loadData();
    </script>
  </body>
</html>
