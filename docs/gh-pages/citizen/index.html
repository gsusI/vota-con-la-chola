<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Vota Con La Chola | Ciudadania</title>
    <link rel="icon" href="data:," />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: light;

        --ink: #0b1020;
        --ink-2: #24324a;
        --muted: #5b6b85;
        --muted-2: #7b8ba8;
        --panel: rgba(255, 255, 255, 0.92);
        --panel-2: rgba(255, 255, 255, 0.78);
        --line: rgba(15, 23, 42, 0.12);
        --shadow: 0 18px 52px rgba(15, 23, 42, 0.12);

        --accent: #1d4ed8;
        --accent-2: #0891b2;

        --ok: #059669;
        --warn: #d97706;
        --bad: #dc2626;

        --chip: rgba(248, 250, 252, 0.86);

        --sans: "Space Grotesk", system-ui, -apple-system, "Segoe UI", sans-serif;
        --mono: "IBM Plex Mono", ui-monospace, "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", monospace;

        --radius: 18px;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        font-family: var(--sans);
        color: var(--ink);
        background:
          radial-gradient(980px 520px at 10% -10%, #dbeafe 0%, transparent 62%),
          radial-gradient(980px 520px at 92% 12%, #cffafe 0%, transparent 58%),
          radial-gradient(980px 520px at 80% 110%, #fef3c7 0%, transparent 62%),
          linear-gradient(130deg, #f6f8ff, #ffffff);
        line-height: 1.35;
        font-size: 16px;
      }

      a {
        color: inherit;
      }

      .app {
        min-height: 100%;
        padding: 14px;
        display: grid;
        grid-template-rows: auto minmax(0, 1fr) auto;
        gap: 12px;
        width: min(1560px, calc(100% - 28px));
        margin: 0 auto;
      }

      .card {
        border: 1px solid var(--line);
        border-radius: var(--radius);
        background: var(--panel);
        box-shadow: var(--shadow);
        backdrop-filter: blur(8px);
        min-width: 0;
      }

      .top {
        padding: 14px;
        position: relative;
        overflow: hidden;
      }

      .top::before {
        content: "";
        position: absolute;
        inset: -120px -200px auto auto;
        width: 520px;
        height: 520px;
        background:
          radial-gradient(circle at 30% 30%, rgba(29, 78, 216, 0.22), transparent 56%),
          radial-gradient(circle at 55% 55%, rgba(8, 145, 178, 0.18), transparent 62%),
          radial-gradient(circle at 75% 25%, rgba(217, 119, 6, 0.16), transparent 62%);
        transform: rotate(12deg);
        pointer-events: none;
      }

      .nav {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: 1px solid rgba(29, 78, 216, 0.22);
        background: rgba(219, 234, 254, 0.58);
        border-radius: 999px;
        padding: 6px 10px;
        text-decoration: none;
        color: #0b1b3a;
        font-weight: 800;
        font-size: 0.82rem;
      }

      .pill.secondary {
        border-color: rgba(8, 145, 178, 0.22);
        background: rgba(207, 250, 254, 0.45);
      }

      .pill.neutral {
        border-color: rgba(15, 23, 42, 0.14);
        background: rgba(248, 250, 252, 0.82);
      }

      .pill:focus,
      .pill:hover {
        outline: none;
        box-shadow: 0 0 0 3px rgba(29, 78, 216, 0.18);
      }

      .hero {
        margin-top: 12px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        flex-wrap: wrap;
        position: relative;
        z-index: 1;
      }

      .eyebrow {
        margin: 0;
        font-size: 0.72rem;
        letter-spacing: 0.13em;
        text-transform: uppercase;
        color: var(--accent);
        font-weight: 800;
      }

      h1 {
        margin: 6px 0 4px;
        font-size: 1.9rem;
        line-height: 1.05;
      }

      .sub {
        margin: 0;
        color: var(--ink-2);
        max-width: 92ch;
      }

      .mono {
        font-family: var(--mono);
      }

      .status {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: flex-end;
      }

      .chip {
        border: 1px solid rgba(15, 23, 42, 0.14);
        background: var(--chip);
        border-radius: 999px;
        padding: 6px 10px;
        font-size: 0.78rem;
        color: var(--ink-2);
        display: inline-flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
      }

      .dot {
        width: 9px;
        height: 9px;
        border-radius: 999px;
        background: rgba(100, 116, 139, 0.55);
        flex: 0 0 auto;
      }

      .dot.ok {
        background: rgba(5, 150, 105, 0.9);
      }

      .dot.warn {
        background: rgba(217, 119, 6, 0.9);
      }

      .dot.bad {
        background: rgba(220, 38, 38, 0.9);
      }

      .banner {
        margin-top: 10px;
        border: 1px dashed rgba(15, 23, 42, 0.22);
        border-radius: 14px;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.55);
        color: var(--muted);
        display: none;
        position: relative;
        z-index: 1;
      }

      .layout {
        min-height: 0;
        display: grid;
        gap: 12px;
        grid-template-columns: 320px 420px minmax(0, 1fr);
      }

      @media (max-width: 1180px) {
        .layout {
          grid-template-columns: 1fr;
          grid-template-rows: auto auto minmax(0, 1fr);
        }
      }

      .panel {
        min-height: 0;
        display: grid;
        grid-template-rows: auto auto minmax(0, 1fr);
      }

      .panel .head {
        padding: 14px 14px 8px;
      }

      .panel h2 {
        margin: 0;
        font-size: 1.02rem;
      }

      .panel .hint {
        margin: 4px 0 0;
        color: var(--muted);
        font-size: 0.84rem;
      }

      .controls {
        padding: 0 14px 12px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }

      input[type="text"],
      select {
        border: 1px solid rgba(15, 23, 42, 0.16);
        border-radius: 12px;
        padding: 9px 10px;
        font: inherit;
        background: rgba(255, 255, 255, 0.92);
        min-width: 0;
      }

      input[type="text"] {
        flex: 1 1 200px;
      }

      .btn {
        border: 1px solid rgba(15, 23, 42, 0.14);
        border-radius: 12px;
        padding: 9px 11px;
        font-weight: 800;
        background: rgba(248, 250, 252, 0.88);
        color: var(--ink);
        cursor: pointer;
      }

      .btn:hover,
      .btn:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.16);
      }

      .list {
        min-height: 0;
        overflow: auto;
        padding: 0 10px 12px;
      }

      .row {
        border: 1px solid rgba(15, 23, 42, 0.1);
        background: rgba(255, 255, 255, 0.7);
        border-radius: 14px;
        padding: 12px;
        margin: 10px 4px;
        display: grid;
        gap: 8px;
        cursor: pointer;
        transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
        transform: translateY(0);
        opacity: 1;
      }

      .row:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.10);
        border-color: rgba(29, 78, 216, 0.18);
      }

      .row.active {
        border-color: rgba(29, 78, 216, 0.35);
        background: rgba(219, 234, 254, 0.32);
      }

      .rowTitle {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        justify-content: space-between;
      }

      .rowTitle strong {
        font-size: 0.95rem;
      }

      .tags {
        display: inline-flex;
        gap: 6px;
        flex-wrap: wrap;
        align-items: center;
      }

      .tag {
        border: 1px solid rgba(15, 23, 42, 0.14);
        background: rgba(248, 250, 252, 0.86);
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 0.74rem;
        color: var(--muted);
        white-space: nowrap;
      }

      .tagbtn {
        cursor: pointer;
        font: inherit;
      }

      .tagbtn:hover,
      .tagbtn:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(29, 78, 216, 0.14);
      }

      .tagbtn.active {
        border-color: rgba(29, 78, 216, 0.32);
        background: rgba(219, 234, 254, 0.52);
        color: #0b1b3a;
        font-weight: 800;
      }

      .tag.hot {
        border-color: rgba(217, 119, 6, 0.25);
        background: rgba(254, 243, 199, 0.75);
        color: #92400e;
        font-weight: 800;
      }

      .tag.good {
        border-color: rgba(5, 150, 105, 0.25);
        background: rgba(236, 253, 245, 0.95);
        color: #065f46;
        font-weight: 900;
      }

      .tag.bad {
        border-color: rgba(220, 38, 38, 0.22);
        background: rgba(254, 242, 242, 0.95);
        color: #7f1d1d;
        font-weight: 900;
      }

      .rowMeta {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
        color: var(--muted);
        font-size: 0.78rem;
      }

      .smallLink {
        color: var(--accent);
        text-decoration: none;
        font-weight: 800;
      }

      .smallLink:hover {
        text-decoration: underline;
      }

      .compare {
        padding: 0 14px 14px;
        overflow: auto;
      }

      .empty {
        padding: 14px;
        color: var(--muted);
        border: 1px dashed rgba(15, 23, 42, 0.18);
        background: rgba(255, 255, 255, 0.55);
        border-radius: 14px;
      }

      .summaryGrid {
        display: grid;
        grid-template-columns: repeat(5, minmax(0, 1fr));
        gap: 10px;
        margin-bottom: 12px;
      }

      @media (max-width: 760px) {
        .summaryGrid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      .kpi {
        border: 1px solid rgba(15, 23, 42, 0.12);
        border-radius: 14px;
        background: rgba(248, 250, 252, 0.82);
        padding: 10px;
      }

      .kpi .k {
        font-size: 0.74rem;
        color: var(--muted);
        font-weight: 800;
        letter-spacing: 0.06em;
        text-transform: uppercase;
      }

      .kpi .v {
        margin-top: 4px;
        font-size: 1.05rem;
        font-weight: 900;
        color: var(--ink);
      }

      .partyCard {
        border: 1px solid rgba(15, 23, 42, 0.12);
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.72);
        padding: 12px;
        display: grid;
        gap: 10px;
        margin: 10px 0;
      }

      .partyCard.focused {
        border-color: rgba(8, 145, 178, 0.32);
        background: rgba(207, 250, 254, 0.22);
      }

      .partyHead {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .partyName {
        font-weight: 900;
      }

      .stanceChip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border-radius: 999px;
        padding: 6px 10px;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: rgba(248, 250, 252, 0.86);
        font-size: 0.78rem;
        font-weight: 900;
        color: var(--ink-2);
        white-space: nowrap;
      }

      button.stanceChip {
        cursor: pointer;
      }

      button.stanceChip:hover,
      button.stanceChip:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(29, 78, 216, 0.14);
      }

      .stanceChip.mini {
        padding: 4px 8px;
        font-size: 0.74rem;
      }

      .stanceChip.support {
        border-color: rgba(5, 150, 105, 0.25);
        background: rgba(236, 253, 245, 0.95);
        color: #065f46;
      }

      .stanceChip.oppose {
        border-color: rgba(220, 38, 38, 0.22);
        background: rgba(254, 242, 242, 0.95);
        color: #7f1d1d;
      }

      .stanceChip.mixed {
        border-color: rgba(217, 119, 6, 0.22);
        background: rgba(255, 251, 235, 0.95);
        color: #92400e;
      }

      .stanceChip.unclear,
      .stanceChip.no_signal {
        border-color: rgba(100, 116, 139, 0.2);
        background: rgba(248, 250, 252, 0.86);
        color: var(--muted);
      }

      .barWrap {
        display: grid;
        gap: 6px;
      }

      .barLabel {
        display: flex;
        justify-content: space-between;
        color: var(--muted);
        font-size: 0.78rem;
      }

      .bar {
        height: 10px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.08);
        overflow: hidden;
      }

      .bar > div {
        height: 100%;
        border-radius: 999px;
        background: linear-gradient(90deg, rgba(29, 78, 216, 0.75), rgba(8, 145, 178, 0.75));
        width: 0;
        transition: width 0.35s ease;
      }

      .partyMeta {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        color: var(--muted);
        font-size: 0.78rem;
      }

      .foot {
        padding: 14px;
        color: var(--muted);
        font-size: 0.9rem;
      }

      .foot strong {
        color: var(--ink-2);
      }

      .fadeIn {
        animation: fadeInUp 0.35s ease both;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(6px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header class="top card fadeIn">
        <div class="nav">
          <a class="pill" href="../">Exploradores</a>
          <a class="pill secondary" href="../explorer-temas/">Temas</a>
          <a class="pill neutral" href="../explorer/">Explorer SQL</a>
          <a class="pill neutral" href="../explorer-sources/">Fuentes</a>
        </div>

        <div class="hero">
          <div>
            <p class="eyebrow">Ciudadania</p>
            <h1>Que hicieron sobre lo que te importa</h1>
            <p class="sub">
              Elige una preocupacion. Veras items concretos (hoy: iniciativas/votaciones) y un resumen por partido.
              Cada tarjeta enlaza a evidencia para auditar.
              <strong>No hay ranking magico</strong>.
            </p>
          </div>
          <div class="status" id="statusChips">
            <span class="chip"><span class="dot warn"></span><span class="mono">cargando datos…</span></span>
          </div>
        </div>

        <div class="banner" id="banner"></div>
      </header>

      <main class="layout fadeIn" style="animation-delay: 0.08s">
        <section class="panel card">
          <div class="head">
            <h2>1) Preocupacion</h2>
            <p class="hint">Etiquetas deterministas (keywords). Sirven para navegar, no para “clasificar verdad”.</p>
          </div>
          <div class="controls" style="align-items: flex-start">
            <div style="flex: 1 1 240px; min-width: 0">
              <div class="hint" style="margin: 0 0 6px">Mis preocupaciones (dashboard)</div>
              <div class="tags" id="selectedConcernTags"></div>
            </div>
            <button class="btn" id="btnResetSelected" type="button">Reset</button>
          </div>
          <div class="controls">
            <input id="concernSearch" type="text" placeholder="Filtra preocupaciones…" />
            <button class="btn" id="btnClear" type="button">Limpiar</button>
          </div>
          <div class="list" id="concernList"></div>
        </section>

        <section class="panel card">
          <div class="head">
            <h2>2) Items</h2>
            <p class="hint">High-stakes primero. Si un item no tiene suficiente cobertura, se marca “incierto”.</p>
          </div>
          <div class="controls">
            <input id="topicSearch" type="text" placeholder="Busca en el titulo…" />
            <select id="topicLimit" aria-label="Limite de items">
              <option value="20">20</option>
              <option value="40">40</option>
              <option value="60" selected>60</option>
            </select>
            <button class="btn" id="btnPartyFocusClear" type="button" style="display: none">
              Salir foco partido
            </button>
            <span class="chip" id="partyFocusChip" style="display: none">
              <span class="dot ok"></span><span>foco</span><span class="mono" id="partyFocusName"></span>
            </span>
          </div>
          <div class="list" id="topicList"></div>
        </section>

        <section class="panel card">
          <div class="head">
            <h2>3) Comparar por partido</h2>
            <p class="hint">
              Posicion: resumen derivado de posiciones (metodo segun snapshot). Programa: promesas (si existe) por la preocupacion actual. Si no eliges un item, veras un resumen por partido.
            </p>
          </div>
          <div class="controls">
            <select id="viewMode" aria-label="Vista">
              <option value="detail" selected>Vista: detalle</option>
              <option value="dashboard">Vista: mi dashboard</option>
              <option value="alignment">Vista: alineamiento</option>
              <option value="coherence">Vista: coherencia</option>
            </select>
            <select id="methodSelect" aria-label="Metodo">
              <option value="combined" selected>Metodo: combinado (prioriza votos)</option>
              <option value="votes">Metodo: hechos (votos)</option>
              <option value="declared">Metodo: dichos (intervenciones)</option>
            </select>
            <select id="stanceFilter" aria-label="Filtro por stance">
              <option value="all" selected>Todos</option>
              <option value="support">A favor</option>
              <option value="oppose">En contra</option>
              <option value="mixed">Mixto</option>
              <option value="unclear">Incierto</option>
              <option value="no_signal">Sin senal</option>
            </select>
            <select id="partySort" aria-label="Orden de partidos">
              <option value="name" selected>Orden: nombre</option>
              <option value="coverage">Orden: cobertura</option>
              <option value="confidence">Orden: confianza</option>
            </select>
          </div>
          <div class="compare" id="compare"></div>
        </section>
      </main>

      <footer class="foot card fadeIn" style="animation-delay: 0.14s">
        <strong>Como leer esto:</strong> “A favor / En contra / Mixto” viene de agregar posiciones de diputados del partido.
        Si la cobertura es baja, mostramos <strong>Incierto</strong>. Si no hay datos, mostramos <strong>Sin senal</strong>.
        En <strong>combinado</strong> priorizamos <strong>votos</strong>; si no hay votos, usamos <strong>dichos</strong>.
        “Programa” viene de textos (promesas) y es mas incierto por defecto. Usa los links de auditoria para ver filas y evidencia.
      </footer>
    </div>

    <script>
      "use strict";

      const qs = (sel) => document.querySelector(sel);
      const esc = (s) =>
        String(s || "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");

      function stripDiacritics(s) {
        // Compatible with most browsers (avoid \p{Diacritic}).
        return String(s || "")
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");
      }

      function norm(s) {
        return stripDiacritics(String(s || "").toLowerCase()).trim();
      }

      function fmtInt(n) {
        const x = Number(n || 0);
        if (!Number.isFinite(x)) return "0";
        return x.toLocaleString("es-ES");
      }

      function fmtPct01(x) {
        const v = Number(x || 0);
        if (!Number.isFinite(v)) return "0%";
        return `${Math.round(v * 100)}%`;
      }

      function stanceLabel(s) {
        const k = String(s || "");
        if (k === "support") return "A favor";
        if (k === "oppose") return "En contra";
        if (k === "mixed") return "Mixto";
        if (k === "unclear") return "Incierto";
        if (k === "no_signal") return "Sin senal";
        return "Incierto";
      }

      function dotClassForStance(s) {
        const k = String(s || "");
        if (k === "support") return "ok";
        if (k === "oppose") return "bad";
        if (k === "mixed") return "warn";
        if (k === "unclear") return "warn";
        if (k === "no_signal") return "";
        return "";
      }

      function computedMethodLabel() {
        const m = String((state.citizen?.meta || {}).computed_method || "");
        if (m === "votes") return "Hechos (votos)";
        if (m === "combined") return "Combinado (prioriza votos)";
        if (m === "declared") return "Dichos (intervenciones)";
        return "Posicion";
      }

      function isComparableStance(s) {
        const k = String(s || "");
        return k === "support" || k === "oppose";
      }

      function isClearStance(s) {
        const k = String(s || "");
        return k === "support" || k === "oppose" || k === "mixed";
      }

      function buildTopicByIdMap(citizen) {
        const m = new Map();
        for (const t of (citizen || {}).topics || []) {
          m.set(Number(t.topic_id || 0), t);
        }
        return m;
      }

      function buildPosByKeyMap(citizen) {
        const m = new Map();
        for (const r of (citizen || {}).party_topic_positions || []) {
          const key = `${Number(r.topic_id || 0)}:${Number(r.party_id || 0)}`;
          m.set(key, r);
        }
        return m;
      }

      function stanceFromPosMap(posMap, topicId, partyId) {
        const key = `${Number(topicId || 0)}:${Number(partyId || 0)}`;
        const row = posMap && posMap.get ? posMap.get(key) : null;
        return row ? String(row.stance || "no_signal") : "no_signal";
      }

      async function fetchJson(path) {
        const res = await fetch(path, { cache: "no-store" });
        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          throw new Error(`HTTP ${res.status} al cargar ${path}: ${txt.slice(0, 120)}`);
        }
        return await res.json();
      }

      const LS_SELECTED_CONCERNS = "vclc_citizen_selected_concerns_v3";
      const LS_METHOD = "vclc_citizen_method_v3";
      const LS_VIEW = "vclc_citizen_view_v3";
      const LS_PREFS = "vclc_citizen_prefs_v1";

      function lsGet(key) {
        try {
          return String(localStorage.getItem(String(key)) || "");
        } catch {
          return "";
        }
      }

      function lsSet(key, value) {
        try {
          localStorage.setItem(String(key), String(value));
        } catch {
          // ignore
        }
      }

      function normalizePrefValue(v) {
        const k = String(v || "").trim();
        if (k === "support" || k === "oppose") return k;
        return "";
      }

      function prefsToStorageValue(prefsMap) {
        const items = {};
        const keys = Array.from((prefsMap && prefsMap.keys ? prefsMap.keys() : [])).map((x) => Number(x || 0));
        keys.sort((a, b) => a - b);
        for (const tid of keys) {
          const pref = normalizePrefValue(prefsMap.get(tid));
          if (!pref) continue;
          items[String(tid)] = pref;
        }
        return JSON.stringify({ version: "v1", updated_at: new Date().toISOString(), items });
      }

      function prefsFromStorageValue(raw) {
        const txt = String(raw || "").trim();
        if (!txt) return new Map();
        try {
          const obj = JSON.parse(txt);
          const items = obj && obj.items && typeof obj.items === "object" ? obj.items : {};
          const out = new Map();
          for (const [k, v] of Object.entries(items)) {
            const tid = Number(k || 0);
            if (!Number.isFinite(tid) || tid <= 0) continue;
            const pref = normalizePrefValue(v);
            if (!pref) continue;
            out.set(tid, pref);
          }
          return out;
        } catch {
          return new Map();
        }
      }

      function encodePrefsPayload(prefsMap) {
        // Compact v1: topic_id=<s|o> pairs joined by commas.
        const keys = Array.from((prefsMap && prefsMap.keys ? prefsMap.keys() : [])).map((x) => Number(x || 0));
        keys.sort((a, b) => a - b);
        const parts = [];
        for (const tid of keys) {
          const pref = normalizePrefValue(prefsMap.get(tid));
          if (!pref) continue;
          parts.push(`${tid}=${pref === "support" ? "s" : "o"}`);
        }
        return parts.join(",");
      }

      function decodePrefsPayload(payload) {
        const txt = String(payload || "").trim();
        const out = new Map();
        if (!txt) return out;
        for (const part of txt.split(",")) {
          const p = String(part || "").trim();
          if (!p) continue;
          const [k, v] = p.split("=");
          const tid = Number(String(k || "").trim() || 0);
          if (!Number.isFinite(tid) || tid <= 0) continue;
          const vv = String(v || "").trim().toLowerCase();
          const pref = vv === "s" ? "support" : vv === "o" ? "oppose" : "";
          if (!pref) continue;
          out.set(tid, pref);
        }
        return out;
      }

      function readPrefsFromHash() {
        const h = String(location.hash || "");
        if (!h || h.length < 2) return { prefs: null, error: "" };
        // Expect: #prefs=v1:<payload>
        if (!h.startsWith("#prefs=")) return { prefs: null, error: "" };
        const raw = h.slice("#prefs=".length);
        const decoded = decodeURIComponent(raw);
        if (!decoded.startsWith("v1:")) return { prefs: null, error: "prefs hash version no soportada" };
        const payload = decoded.slice(3);
        return { prefs: decodePrefsPayload(payload), error: "" };
      }

      function buildShareUrlWithPrefs(prefsMap) {
        const base = new URL(String(location.href || ""), String(location.origin || undefined));
        const p = new URLSearchParams(base.search || "");
        // Ensure alignment view is explicit in shared links.
        p.set("view", "alignment");
        base.search = `?${p.toString()}`;
        base.hash = `#prefs=${encodeURIComponent("v1:" + encodePrefsPayload(prefsMap))}`;
        return base.toString();
      }

      function persistPrefs() {
        try {
          lsSet(LS_PREFS, prefsToStorageValue(state.prefs));
        } catch {
          // ignore
        }
      }

      function setPrefForTopic(topicId, pref) {
        const tid = Number(topicId || 0);
        if (!Number.isFinite(tid) || tid <= 0) return;
        const v = normalizePrefValue(pref);
        if (!v) return;
        const cur = String(state.prefs.get(tid) || "");
        if (cur === v) state.prefs.delete(tid);
        else state.prefs.set(tid, v);
        persistPrefs();
        renderTopicList();
        renderCompare();
      }

      function clearPrefForTopic(topicId) {
        const tid = Number(topicId || 0);
        if (!Number.isFinite(tid) || tid <= 0) return;
        if (!state.prefs.has(tid)) return;
        state.prefs.delete(tid);
        persistPrefs();
        renderTopicList();
        renderCompare();
      }

      function clearAllPrefs() {
        state.prefs = new Map();
        persistPrefs();
        renderTopicList();
        renderCompare();
      }

      function uniqKeepOrder(ids) {
        const out = [];
        const seen = new Set();
        for (const x of ids || []) {
          const k = String(x || "").trim();
          if (!k || seen.has(k)) continue;
          seen.add(k);
          out.push(k);
        }
        return out;
      }

      function parseCsvIds(s) {
        const txt = String(s || "").trim();
        if (!txt) return [];
        return uniqKeepOrder(
          txt
            .split(",")
            .map((x) => String(x || "").trim())
            .filter((x) => x)
        );
      }

      function formatCsvIds(ids) {
        return uniqKeepOrder(ids).join(",");
      }

      const state = {
        citizen: null,
        concernsCfg: null,
        concerns: [],
        topicById: new Map(),
        partyById: new Map(),
        posByKey: new Map(),
        progByKey: new Map(),
        topicTags: new Map(),
        countsByConcern: new Map(),
        selectedConcernIds: [],
        activeConcernId: "",
        activeTopicId: 0,
        activePartyId: 0,
        viewMode: "detail", // detail | dashboard | alignment | coherence
        method: "", // combined | votes | declared (URL/localStorage preference)
        programasMeta: null,
        prefs: new Map(), // topic_id -> support|oppose
        prefsLoadedFrom: "", // hash | localStorage | empty
        prefsLoadError: "",
        coherence: {
          votes: null,
          declared: null,
          combined: null,
          votesTopicById: new Map(),
          declaredTopicById: new Map(),
          combinedTopicById: new Map(),
          votesPosByKey: new Map(),
          declaredPosByKey: new Map(),
          combinedPosByKey: new Map(),
          loading: false,
          loadError: "",
          promise: null,
        },
      };

      function readUrlState() {
        const p = new URLSearchParams(location.search || "");
        const concernsIds = parseCsvIds(String(p.get("concerns_ids") || ""));
        const concern = String(p.get("concern") || "").trim();
        const topicId = Number(p.get("topic_id") || 0);
        const partyId = Number(p.get("party_id") || 0);
        const method = String(p.get("method") || "").trim();
        const view = String(p.get("view") || "").trim();

        if (concernsIds.length) state.selectedConcernIds = concernsIds;
        if (concern) state.activeConcernId = concern;
        if (Number.isFinite(topicId) && topicId > 0) state.activeTopicId = topicId;
        if (Number.isFinite(partyId) && partyId > 0) state.activePartyId = partyId;
        if (method) state.method = method;
        if (view === "dashboard" || view === "detail" || view === "alignment" || view === "coherence") state.viewMode = view;
      }

      function writeUrlState(push) {
        const p = new URLSearchParams(location.search || "");
        if (state.activeConcernId) p.set("concern", state.activeConcernId);
        else p.delete("concern");
        if (state.activeTopicId) p.set("topic_id", String(state.activeTopicId));
        else p.delete("topic_id");
        const cids = uniqKeepOrder(state.selectedConcernIds || []).slice(0, 6);
        if (cids.length > 1) p.set("concerns_ids", formatCsvIds(cids));
        else p.delete("concerns_ids");
        if (state.activePartyId) p.set("party_id", String(Number(state.activePartyId)));
        else p.delete("party_id");
        if (state.viewMode && state.viewMode !== "detail") p.set("view", String(state.viewMode));
        else p.delete("view");
        const method = String(state.method || "").trim();
        if (method && method !== "combined") p.set("method", method);
        else p.delete("method");
        const next = `?${p.toString()}`;
        if (push) history.pushState({}, "", next);
        else history.replaceState({}, "", next);

        // Convenience persistence (URL remains the primary share mechanism).
        lsSet(LS_SELECTED_CONCERNS, formatCsvIds(cids));
        if (method) lsSet(LS_METHOD, method);
        lsSet(LS_VIEW, String(state.viewMode || "detail"));
      }

      function setBanner(html) {
        const el = qs("#banner");
        if (!el) return;
        if (!html) {
          el.style.display = "none";
          el.innerHTML = "";
          return;
        }
        el.style.display = "block";
        el.innerHTML = html;
      }

      function computeTags() {
        state.topicTags = new Map();
        state.countsByConcern = new Map();

        const concernDefs = state.concerns.map((c) => {
          const kws = Array.isArray(c.keywords) ? c.keywords : [];
          return {
            id: String(c.id || ""),
            label: String(c.label || ""),
            keywords: kws.map((k) => norm(k)).filter((k) => k),
          };
        });

        for (const t of state.citizen.topics || []) {
          const tid = Number(t.topic_id || 0);
          let tags = [];

          // Prefer snapshot-provided tags (v2 optional field) for reproducibility.
          if (Array.isArray(t.concern_ids) && t.concern_ids.length) {
            tags = t.concern_ids.map((x) => String(x || "")).filter((x) => x);
            tags = Array.from(new Set(tags)).sort();
          } else {
            const labelN = norm(t.label || "");
            for (const c of concernDefs) {
              if (!c.id) continue;
              if (c.keywords.some((k) => k && labelN.includes(k))) {
                tags.push(c.id);
              }
            }
          }

          state.topicTags.set(tid, tags);
          for (const cid of tags) {
            state.countsByConcern.set(cid, (state.countsByConcern.get(cid) || 0) + 1);
          }
        }
      }

      function renderStatus() {
        const el = qs("#statusChips");
        if (!el || !state.citizen) return;
        const meta = state.citizen.meta || {};
        const asOf = String(meta.as_of_date || "");
        const method = String(meta.computed_method || "");
        const setId = String(meta.topic_set_id || "");
        const version = String(meta.computed_version || "");
        const prog = meta.programas || null;

        el.innerHTML =
          `<span class="chip"><span class="dot ok"></span><span>as_of</span><span class="mono">${esc(asOf)}</span></span>` +
          `<span class="chip"><span class="dot ok"></span><span>metodo</span><span class="mono">${esc(method)}</span></span>` +
          `<span class="chip"><span class="dot ok"></span><span>topic_set</span><span class="mono">${esc(setId)}</span></span>` +
          `<span class="chip"><span class="dot ok"></span><span>version</span><span class="mono">${esc(version)}</span></span>` +
          (prog && prog.topic_set_id
            ? `<span class="chip"><span class="dot ${Number(prog.signal_total || 0) > 0 ? "ok" : "warn"}"></span><span>programa</span><span class="mono">${esc(
                String(prog.election_cycle || "?")
              )}</span></span>`
            : "");
      }

      function concernLabelById(cid) {
        const token = String(cid || "").trim();
        if (!token) return "";
        const cobj = (state.concerns || []).find((c) => String(c.id || "") === token) || null;
        return cobj ? String(cobj.label || cobj.id || token) : token;
      }

      function normalizeSelectedConcernIds(ids) {
        const raw = uniqKeepOrder(ids || []).slice(0, 6);
        const known = new Set((state.concerns || []).map((c) => String(c.id || "")).filter((x) => x));
        if (!known.size) return raw;
        return raw.filter((cid) => known.has(String(cid)));
      }

      function ensureConcernState() {
        // After loading concerns + tags, normalize selected+active state and apply localStorage defaults
        // only when URL didn't provide them.
        const p = new URLSearchParams(location.search || "");

        if (!p.has("concerns_ids") && !p.has("concern")) {
          const fromLs = normalizeSelectedConcernIds(parseCsvIds(lsGet(LS_SELECTED_CONCERNS)));
          if (fromLs.length) state.selectedConcernIds = fromLs;
        }
        state.selectedConcernIds = normalizeSelectedConcernIds(state.selectedConcernIds);

        if (!p.has("method")) {
          const m = String(lsGet(LS_METHOD) || "").trim();
          if (m) state.method = m;
        }
        if (!state.method) state.method = "combined";
        if (state.method !== "combined" && state.method !== "votes" && state.method !== "declared") state.method = "combined";

        if (!p.has("view")) {
          const v = String(lsGet(LS_VIEW) || "").trim();
          if (v === "dashboard" || v === "detail" || v === "alignment" || v === "coherence") state.viewMode = v;
        }
        if (state.viewMode !== "dashboard" && state.viewMode !== "detail" && state.viewMode !== "alignment" && state.viewMode !== "coherence")
          state.viewMode = "detail";

        const known = new Set((state.concerns || []).map((c) => String(c.id || "")).filter((x) => x));
        if (known.size && state.activeConcernId && !known.has(String(state.activeConcernId))) {
          state.activeConcernId = "";
        }

        if (state.activeConcernId) {
          if (!state.selectedConcernIds.includes(String(state.activeConcernId))) {
            state.selectedConcernIds = normalizeSelectedConcernIds([String(state.activeConcernId)].concat(state.selectedConcernIds));
          }
        }

        if (!state.selectedConcernIds.length) {
          // Deterministic default: most-tagged concern.
          let best = "";
          let bestCount = -1;
          for (const c of state.concerns || []) {
            const cid = String(c.id || "");
            if (!cid) continue;
            const cnt = Number(state.countsByConcern.get(cid) || 0);
            if (cnt > bestCount) {
              best = cid;
              bestCount = cnt;
            }
          }
          if (best) state.selectedConcernIds = [best];
        }
        if (!state.activeConcernId) {
          state.activeConcernId = state.selectedConcernIds[0] || "";
        }

        const viewSel = qs("#viewMode");
        if (viewSel) viewSel.value = String(state.viewMode || "detail");
        const methodSel = qs("#methodSelect");
        if (methodSel) {
          const avail = new Set(((state.citizen || {}).meta || {}).methods_available || []);
          for (const opt of methodSel.querySelectorAll("option")) {
            const v = String(opt.value || "");
            opt.disabled = avail.size ? !avail.has(v) : false;
          }
          if (avail.size && !avail.has(String(state.method || ""))) {
            state.method = avail.has("combined") ? "combined" : String(Array.from(avail)[0] || "combined");
          }
          methodSel.value = String(state.method || "combined");
          methodSel.disabled = p.has("citizen") || state.viewMode === "coherence";
        }

        const sortSel = qs("#partySort");
        if (sortSel) {
          const covOpt = sortSel.querySelector('option[value="coverage"]');
          const confOpt = sortSel.querySelector('option[value="confidence"]');
          if (state.viewMode === "alignment") {
            if (covOpt) covOpt.textContent = "Orden: cobertura (comparables)";
            if (confOpt) confOpt.textContent = "Orden: match neto";
          } else {
            if (covOpt) covOpt.textContent = "Orden: cobertura";
            if (confOpt) confOpt.textContent = "Orden: confianza";
          }
        }
      }

      async function ensureCoherenceSnapshotsLoaded() {
        const coh = state.coherence;
        if (coh.loadError) throw new Error(String(coh.loadError || "coherence load error"));
        if (coh.votes && coh.declared && coh.combined) return;
        if (coh.promise) return await coh.promise;

        coh.loading = true;
        coh.loadError = "";

        coh.promise = (async () => {
          const baseMethod = String((state.citizen?.meta || {}).computed_method || "").trim();

          // Reuse the already-loaded base dataset when possible to avoid extra fetches.
          if (!coh.votes && baseMethod === "votes") {
            coh.votes = state.citizen;
            coh.votesTopicById = state.topicById;
            coh.votesPosByKey = state.posByKey;
          }
          if (!coh.declared && baseMethod === "declared") {
            coh.declared = state.citizen;
            coh.declaredTopicById = state.topicById;
            coh.declaredPosByKey = state.posByKey;
          }
          if (!coh.combined && baseMethod === "combined") {
            coh.combined = state.citizen;
            coh.combinedTopicById = state.topicById;
            coh.combinedPosByKey = state.posByKey;
          }

          if (!coh.votes) {
            coh.votes = await fetchJson("./data/citizen_votes.json");
            coh.votesTopicById = buildTopicByIdMap(coh.votes);
            coh.votesPosByKey = buildPosByKeyMap(coh.votes);
          }
          if (!coh.declared) {
            coh.declared = await fetchJson("./data/citizen_declared.json");
            coh.declaredTopicById = buildTopicByIdMap(coh.declared);
            coh.declaredPosByKey = buildPosByKeyMap(coh.declared);
          }
          if (!coh.combined) {
            coh.combined = await fetchJson("./data/citizen.json");
            coh.combinedTopicById = buildTopicByIdMap(coh.combined);
            coh.combinedPosByKey = buildPosByKeyMap(coh.combined);
          }

          const topicsCounts = [coh.votes, coh.declared, coh.combined].map((x) => (x && x.topics ? x.topics.length : 0));
          const partiesCounts = [coh.votes, coh.declared, coh.combined].map((x) => (x && x.parties ? x.parties.length : 0));
          const sameTopics = topicsCounts.every((n) => n === topicsCounts[0]);
          const sameParties = partiesCounts.every((n) => n === partiesCounts[0]);
          if (!sameTopics || !sameParties) {
            throw new Error(
              `Dataset mismatch (topics=${topicsCounts.join(",")} parties=${partiesCounts.join(",")}). Rebuild GH Pages artifacts.`
            );
          }
        })()
          .catch((err) => {
            coh.loadError = String(err?.message || err || "coherence load failed");
            throw err;
          })
          .finally(() => {
            coh.loading = false;
            coh.promise = null;
          });

        return await coh.promise;
      }

      function renderSelectedConcernTags() {
        const el = qs("#selectedConcernTags");
        if (!el) return;
        const ids = normalizeSelectedConcernIds(state.selectedConcernIds || []);
        state.selectedConcernIds = ids;

        if (!ids.length) {
          el.innerHTML = `<span class="tag">ninguna</span>`;
          return;
        }

        el.innerHTML = ids
          .map((cid) => {
            const label = concernLabelById(cid) || cid;
            const active = state.activeConcernId && String(state.activeConcernId) === String(cid);
            return (
              `<button class="tag tagbtn ${active ? "active" : ""}" type="button" data-sel-cid="${esc(cid)}">` +
              `${esc(label)} <span class="mono">x</span>` +
              `</button>`
            );
          })
          .join("");

        for (const btn of el.querySelectorAll("[data-sel-cid]")) {
          btn.addEventListener("click", () => {
            const cid = String(btn.getAttribute("data-sel-cid") || "");
            removeSelectedConcern(cid, true);
          });
        }
      }

      function removeSelectedConcern(cid, push) {
        const token = String(cid || "").trim();
        if (!token) return;
        const cur = normalizeSelectedConcernIds(state.selectedConcernIds || []);
        const next = cur.filter((x) => String(x) !== token);
        if (!next.length) return; // keep at least one
        state.selectedConcernIds = next;
        if (String(state.activeConcernId || "") === token) {
          state.activeConcernId = next[0] || "";
          state.activeTopicId = 0;
        }
        writeUrlState(Boolean(push));
        renderSelectedConcernTags();
        renderConcernList();
        renderTopicList();
        renderCompare();
      }

      function renderConcernList() {
        const list = qs("#concernList");
        if (!list) return;

        const needle = norm(qs("#concernSearch")?.value || "");

        const rows = (state.concerns || [])
          .map((c) => {
            const cid = String(c.id || "");
            const label = String(c.label || cid);
            const count = Number(state.countsByConcern.get(cid) || 0);
            const labelN = norm(label);
            if (needle && !labelN.includes(needle) && !norm(cid).includes(needle)) return null;
            return { cid, label, count };
          })
          .filter(Boolean)
          .sort((a, b) => {
            if (b.count !== a.count) return b.count - a.count;
            return a.label.localeCompare(b.label);
          });

        if (!rows.length) {
          list.innerHTML = `<div class="empty">No hay coincidencias para el filtro.</div>`;
          return;
        }

        list.innerHTML = rows
          .map((r) => {
            const active = state.activeConcernId && r.cid === state.activeConcernId;
            const selected = (state.selectedConcernIds || []).includes(r.cid);
            return (
              `<div class="row ${active ? "active" : ""}" data-cid="${esc(r.cid)}" role="button" tabindex="0">` +
              `<div class="rowTitle"><strong>${esc(r.label)}</strong><span class="tags">` +
              `<span class="tag">${fmtInt(r.count)} items</span>` +
              (selected ? `<span class="tag">dashboard</span>` : ``) +
              `</span></div>` +
              `<div class="rowMeta">` +
              `<span class="tag">id=${esc(r.cid)}</span>` +
              `<span class="tag">navegacion</span>` +
              `</div>` +
              `</div>`
            );
          })
          .join("");

        for (const el of list.querySelectorAll("[data-cid]")) {
          el.addEventListener("click", () => {
            selectConcern(String(el.getAttribute("data-cid") || ""), true);
          });
          el.addEventListener("keydown", (ev) => {
            if (ev.key === "Enter" || ev.key === " ") {
              ev.preventDefault();
              selectConcern(String(el.getAttribute("data-cid") || ""), true);
            }
          });
        }
      }

      function topicsForConcernAll(cid) {
        const token = String(cid || "").trim();
        if (!token) return [];
        const out = [];
        for (const t of state.citizen.topics || []) {
          const tid = Number(t.topic_id || 0);
          const tags = state.topicTags.get(tid) || [];
          if (!tags.includes(token)) continue;
          out.push(t);
        }
        out.sort((a, b) => {
          const ah = a.is_high_stakes ? 1 : 0;
          const bh = b.is_high_stakes ? 1 : 0;
          if (bh !== ah) return bh - ah;
          const ar = a.stakes_rank == null ? 999999 : Number(a.stakes_rank);
          const br = b.stakes_rank == null ? 999999 : Number(b.stakes_rank);
          if (ar !== br) return ar - br;
          return Number(a.topic_id) - Number(b.topic_id);
        });
        return out;
      }

      function topicsForConcernIdsAll(cids) {
        const ids = uniqKeepOrder(cids || []).map((x) => String(x || "").trim()).filter((x) => x);
        if (!ids.length) return [];
        const want = new Set(ids);

        const out = [];
        for (const t of state.citizen.topics || []) {
          const tid = Number(t.topic_id || 0);
          const tags = state.topicTags.get(tid) || [];
          if (!tags.some((x) => want.has(String(x)))) continue;
          out.push(t);
        }
        out.sort((a, b) => {
          const ah = a.is_high_stakes ? 1 : 0;
          const bh = b.is_high_stakes ? 1 : 0;
          if (bh !== ah) return bh - ah;
          const ar = a.stakes_rank == null ? 999999 : Number(a.stakes_rank);
          const br = b.stakes_rank == null ? 999999 : Number(b.stakes_rank);
          if (ar !== br) return ar - br;
          return Number(a.topic_id) - Number(b.topic_id);
        });
        return out;
      }

      function topicsForActiveConcern() {
        const cid = String(state.activeConcernId || "");
        const needle = norm(qs("#topicSearch")?.value || "");
        const limit = Number(qs("#topicLimit")?.value || 60);

        let out = topicsForConcernAll(cid);
        if (needle) {
          out = out.filter((t) => {
            const tid = Number(t.topic_id || 0);
            const label = String(t.label || "");
            return norm(label).includes(needle) || norm(String(tid)).includes(needle);
          });
        }
        return out.slice(0, Math.max(1, Math.min(200, Number.isFinite(limit) ? limit : 60)));
      }

      function renderTopicList() {
        const list = qs("#topicList");
        if (!list) return;
        renderPartyFocusControls();
        const alignmentMode = state.viewMode === "alignment";
        if (!state.activeConcernId) {
          list.innerHTML = `<div class="empty">Elige una preocupacion para ver items.</div>`;
          return;
        }

        const topics = topicsForActiveConcern();
        if (!topics.length) {
          list.innerHTML = `<div class="empty">No hay items que coincidan con esta preocupacion (o con el filtro).</div>`;
          return;
        }

        list.innerHTML = topics
          .map((t) => {
            const tid = Number(t.topic_id || 0);
            const active = state.activeTopicId && tid === state.activeTopicId;
            const tags = [];
            if (t.is_high_stakes) tags.push(`<span class="tag hot">high-stakes</span>`);
            if (t.stakes_rank != null) tags.push(`<span class="tag">rank #${esc(String(t.stakes_rank))}</span>`);
            tags.push(`<span class="tag">topic_id=${esc(String(tid))}</span>`);

            if (alignmentMode) {
              const pref = normalizePrefValue(state.prefs.get(tid));
              if (pref) {
                tags.push(
                  `<span class="stanceChip mini ${esc(pref)}"><span class="dot ${esc(dotClassForStance(pref))}"></span>tu:${esc(
                    stanceLabel(pref)
                  )}</span>`
                );
              }
            }

            if (state.activePartyId) {
              const pid = Number(state.activePartyId);
              const coh = state.coherence;
              const coherenceReady = Boolean(
                state.viewMode === "coherence" &&
                  coh &&
                  coh.votesPosByKey &&
                  coh.declaredPosByKey &&
                  coh.votesPosByKey.size &&
                  coh.declaredPosByKey.size
              );

              if (coherenceReady) {
                const sv = stanceFromPosMap(coh.votesPosByKey, tid, pid);
                const sd = stanceFromPosMap(coh.declaredPosByKey, tid, pid);
                const mismatch = isComparableStance(sv) && isComparableStance(sd) && sv !== sd;
                if (mismatch) tags.push(`<span class="tag hot">mismatch</span>`);
                tags.push(
                  `<span class="stanceChip mini ${esc(sv)}"><span class="dot ${esc(dotClassForStance(sv))}"></span>v:${esc(
                    stanceLabel(sv)
                  )}</span>`
                );
                tags.push(
                  `<span class="stanceChip mini ${esc(sd)}"><span class="dot ${esc(dotClassForStance(sd))}"></span>d:${esc(
                    stanceLabel(sd)
                  )}</span>`
                );
              } else {
                const key = `${tid}:${pid}`;
                const r = state.posByKey.get(key) || null;
                const s = r ? String(r.stance || "no_signal") : "no_signal";
                if (alignmentMode) {
                  const pref = normalizePrefValue(state.prefs.get(tid));
                  if (pref) {
                    if (isComparableStance(s)) {
                      tags.push(`<span class="tag ${esc(s === pref ? "good" : "bad")}">${esc(s === pref ? "match" : "mismatch")}</span>`);
                    } else {
                      tags.push(`<span class="tag">unknown</span>`);
                    }
                  }
                }
                tags.push(
                  `<span class="stanceChip mini ${esc(s)}"><span class="dot ${esc(dotClassForStance(s))}"></span>${esc(
                    stanceLabel(s)
                  )}</span>`
                );
              }
            }

            return (
              `<div class="row ${active ? "active" : ""}" data-tid="${esc(String(tid))}" role="button" tabindex="0">` +
              `<div class="rowTitle"><strong>${esc(String(t.label || ""))}</strong><span class="tags">${tags.join(
                ""
              )}</span></div>` +
              `<div class="rowMeta">` +
              `<a class="smallLink" href="${esc(String((t.links || {}).explorer_temas || ""))}" target="_blank" rel="noopener noreferrer">Ver en Temas</a>` +
              `<span>·</span>` +
              `<a class="smallLink" href="${esc(String((t.links || {}).explorer_positions || ""))}" target="_blank" rel="noopener noreferrer">Posiciones (SQL)</a>` +
              `</div>` +
              `</div>`
            );
          })
          .join("");

        for (const el of list.querySelectorAll("[data-tid]")) {
          el.addEventListener("click", () => {
            selectTopic(Number(el.getAttribute("data-tid") || 0), true);
          });
          el.addEventListener("keydown", (ev) => {
            if (ev.key === "Enter" || ev.key === " ") {
              ev.preventDefault();
              selectTopic(Number(el.getAttribute("data-tid") || 0), true);
            }
          });
        }
      }

      function positionsForTopic(topicId) {
        const out = [];
        for (const party of state.citizen.parties || []) {
          const pid = Number(party.party_id || 0);
          const key = `${Number(topicId)}:${pid}`;
          const row = state.posByKey.get(key) || null;
          if (row) out.push(row);
        }
        return out;
      }

      function stanceCounts(rows) {
        const c = {
          support: 0,
          oppose: 0,
          mixed: 0,
          unclear: 0,
          no_signal: 0,
        };
        for (const r of rows) {
          const s = String(r.stance || "unclear");
          if (c[s] == null) continue;
          c[s] += 1;
        }
        return c;
      }

      function summaryStanceFromCounts(counts, itemsTotal) {
        const n = Number(itemsTotal || 0);
        if (n <= 0) return "no_signal";

        const support = Number(counts.support || 0);
        const oppose = Number(counts.oppose || 0);
        const mixed = Number(counts.mixed || 0);
        const unclear = Number(counts.unclear || 0);

        const clear = support + oppose + mixed;
        if (clear <= 0) {
          return unclear > 0 ? "unclear" : "no_signal";
        }

        const conflict = support > 0 && oppose > 0;
        if (conflict) return "mixed";
        return support >= oppose ? "support" : "oppose";
      }

      function partySummariesForTopics(topics) {
        const itemsTotal = (topics || []).length;
        const out = [];
        for (const party of state.citizen.parties || []) {
          const pid = Number(party.party_id || 0);
          const counts = { support: 0, oppose: 0, mixed: 0, unclear: 0, no_signal: 0 };
          let confSum = 0;
          let confN = 0;
          let auditTopic = (topics || [])[0] || null;
          let auditTopicIsFallback = Boolean(auditTopic);

          for (const t of topics || []) {
            const tid = Number(t.topic_id || 0);
            const key = `${tid}:${pid}`;
            const row = state.posByKey.get(key) || null;
            const stance = row ? String(row.stance || "no_signal") : "no_signal";
            if (counts[stance] != null) counts[stance] += 1;

            if (row && stance !== "no_signal") {
              confSum += Number(row.confidence || 0);
              confN += 1;
            }

            if (row && (stance === "support" || stance === "oppose" || stance === "mixed")) {
              // Pick the first clear-stance topic deterministically for audit.
              if (auditTopicIsFallback) {
                auditTopic = t;
                auditTopicIsFallback = false;
              }
            }
          }

          const summaryStance = summaryStanceFromCounts(counts, itemsTotal);
          const clearTotal = Number(counts.support) + Number(counts.oppose) + Number(counts.mixed);
          const coverageItemsRatio = itemsTotal > 0 ? clearTotal / itemsTotal : 0;
          const confidenceAvg = confN > 0 ? confSum / confN : 0;

          out.push({
            party_id: pid,
            stance: summaryStance,
            counts,
            items_total: itemsTotal,
            clear_total: clearTotal,
            coverage_items_ratio: coverageItemsRatio,
            confidence_avg: confidenceAvg,
            audit_topic: auditTopic,
          });
        }

        return { topics: topics || [], items_total: itemsTotal, rows: out };
      }

      function concernPartySummaries() {
        return partySummariesForTopics(topicsForConcernAll(String(state.activeConcernId || "")));
      }

      function dashboardPartySummaries() {
        const cids = normalizeSelectedConcernIds(state.selectedConcernIds || []);
        const topics = topicsForConcernIdsAll(cids);
        return { concern_ids: cids, ...partySummariesForTopics(topics) };
      }

      function coverageStatsForTopics(topics, posByKey) {
        const counts = { support: 0, oppose: 0, mixed: 0, unclear: 0, no_signal: 0 };
        const parties = state.citizen && Array.isArray(state.citizen.parties) ? state.citizen.parties : [];
        const items = Array.isArray(topics) ? topics : [];
        for (const t of items) {
          const tid = Number(t.topic_id || 0);
          for (const party of parties) {
            const pid = Number(party.party_id || 0);
            const s = stanceFromPosMap(posByKey, tid, pid);
            if (counts[s] != null) counts[s] += 1;
          }
        }
        const cellsTotal = items.length * parties.length;
        const clearTotal = Number(counts.support) + Number(counts.oppose) + Number(counts.mixed);
        const anySignal = cellsTotal - Number(counts.no_signal);
        return {
          cells_total: cellsTotal,
          items_total: items.length,
          parties_total: parties.length,
          counts,
          any_signal: anySignal,
          any_signal_pct: cellsTotal > 0 ? anySignal / cellsTotal : 0,
          clear_total: clearTotal,
          clear_pct: cellsTotal > 0 ? clearTotal / cellsTotal : 0,
        };
      }

      function coherenceTotalsForTopics(topics, votesPosByKey, declaredPosByKey) {
        const parties = state.citizen && Array.isArray(state.citizen.parties) ? state.citizen.parties : [];
        const items = Array.isArray(topics) ? topics : [];
        let cellsTotal = 0;
        let comparable = 0;
        let match = 0;
        let mismatch = 0;
        let notComparable = 0;

        for (const t of items) {
          const tid = Number(t.topic_id || 0);
          for (const party of parties) {
            const pid = Number(party.party_id || 0);
            cellsTotal += 1;
            const sv = stanceFromPosMap(votesPosByKey, tid, pid);
            const sd = stanceFromPosMap(declaredPosByKey, tid, pid);
            if (isComparableStance(sv) && isComparableStance(sd)) {
              comparable += 1;
              if (sv === sd) match += 1;
              else mismatch += 1;
            } else {
              notComparable += 1;
            }
          }
        }

        return {
          cells_total: cellsTotal,
          items_total: items.length,
          parties_total: parties.length,
          comparable,
          comparable_pct: cellsTotal > 0 ? comparable / cellsTotal : 0,
          match,
          mismatch,
          mismatch_pct_of_comparable: comparable > 0 ? mismatch / comparable : 0,
          not_comparable: notComparable,
        };
      }

      function coherenceSummaryForParty(topics, pid, votesPosByKey, declaredPosByKey) {
        const items = Array.isArray(topics) ? topics : [];
        let comparable = 0;
        let match = 0;
        let mismatch = 0;
        let notComparable = 0;
        let auditMismatchTopic = null;
        let auditMatchTopic = null;

        for (const t of items) {
          const tid = Number(t.topic_id || 0);
          const sv = stanceFromPosMap(votesPosByKey, tid, pid);
          const sd = stanceFromPosMap(declaredPosByKey, tid, pid);
          if (isComparableStance(sv) && isComparableStance(sd)) {
            comparable += 1;
            if (sv === sd) {
              match += 1;
              if (!auditMatchTopic) auditMatchTopic = t;
            } else {
              mismatch += 1;
              if (!auditMismatchTopic) auditMismatchTopic = t;
            }
          } else {
            notComparable += 1;
          }
        }

        return {
          party_id: Number(pid || 0),
          items_total: items.length,
          comparable,
          comparable_ratio: items.length > 0 ? comparable / items.length : 0,
          match,
          mismatch,
          mismatch_ratio: comparable > 0 ? mismatch / comparable : 0,
          not_comparable: notComparable,
          audit_mismatch_topic: auditMismatchTopic,
          audit_match_topic: auditMatchTopic,
        };
      }

      function programasSummaryForParty(pid, concernIds) {
        const ids = normalizeSelectedConcernIds(concernIds || []);
        const counts = { support: 0, oppose: 0, mixed: 0, unclear: 0, no_signal: 0 };
        let confSum = 0;
        let confN = 0;
        let auditLink = "";

        for (const cid of ids) {
          const key = `${String(cid || "")}:${Number(pid || 0)}`;
          const row = state.progByKey.get(key) || null;
          const stance = row ? String(row.stance || "no_signal") : "no_signal";
          if (counts[stance] != null) counts[stance] += 1;
          if (row && stance !== "no_signal") {
            confSum += Number(row.confidence || 0);
            confN += 1;
          }
          if (!auditLink && row && row.links && String(row.links.explorer_evidence || "")) {
            auditLink = String(row.links.explorer_evidence || "");
          }
        }

        const itemsTotal = ids.length;
        const summaryStance = summaryStanceFromCounts(counts, itemsTotal);
        const confidenceAvg = confN > 0 ? confSum / confN : 0;
        return { stance: summaryStance, counts, items_total: itemsTotal, confidence_avg: confidenceAvg, audit_link: auditLink };
      }

      function partyName(pid) {
        const p = state.partyById.get(Number(pid)) || null;
        if (!p) return `party_id=${pid}`;
        const a = String(p.acronym || "").trim();
        const n = String(p.name || "").trim();
        return a ? `${a} · ${n}` : n;
      }

      function clearPartyFocus() {
        state.activePartyId = 0;
        writeUrlState(true);
        renderTopicList();
        renderCompare();
      }

      function setPartyFocus(pid) {
        const next = Number(pid || 0);
        if (!Number.isFinite(next) || next <= 0) return;
        state.activePartyId = next;
        // Keep topic unselected in focus mode to emphasize drill-down via items list.
        state.activeTopicId = 0;
        // Party focus is shareable (encoded in URL).
        writeUrlState(true);
        renderTopicList();
        renderCompare();
      }

      function renderPartyFocusControls() {
        const btn = qs("#btnPartyFocusClear");
        const chip = qs("#partyFocusChip");
        const name = qs("#partyFocusName");
        if (!btn || !chip || !name) return;

        if (state.activePartyId) {
          btn.style.display = "inline-flex";
          chip.style.display = "inline-flex";
          name.textContent = partyName(state.activePartyId);
        } else {
          btn.style.display = "none";
          chip.style.display = "none";
          name.textContent = "";
        }
      }

      function renderCoherenceCompare(el, selectedConcernIds, { sortMode } = {}) {
        const cids = normalizeSelectedConcernIds(selectedConcernIds || []);
        if (!cids.length) {
          el.innerHTML = `<div class="empty"><strong>Coherencia</strong>: selecciona al menos 1 preocupacion.</div>`;
          return;
        }

        const coh = state.coherence;
        if (!coh.votes || !coh.declared || !coh.combined) {
          if (!coh.loading && !coh.promise && !coh.loadError) {
            ensureCoherenceSnapshotsLoaded()
              .then(() => {
                // Coherence mode affects topic-list chips when party focus is active.
                renderTopicList();
                renderCompare();
              })
              .catch(() => {
                renderCompare();
              });
          }

          if (coh.loadError) {
            el.innerHTML =
              `<div class="empty">` +
              `<strong>Coherencia</strong>: no se pudieron cargar datasets de votos+dichos.<br />` +
              `<span class="mono">${esc(String(coh.loadError || ""))}</span>` +
              `</div>`;
            return;
          }

          el.innerHTML =
            `<div class="empty">` +
            `<strong>Coherencia</strong>: cargando datos de votos + dichos (lazy)…` +
            `</div>`;
          return;
        }

        const topicsUnion = topicsForConcernIdsAll(cids);
        if (!topicsUnion.length) {
          el.innerHTML = `<div class="empty">No hay items etiquetados para las preocupaciones seleccionadas.</div>`;
          return;
        }

        const overallCoh = coherenceTotalsForTopics(topicsUnion, coh.votesPosByKey, coh.declaredPosByKey);
        const mismatchPct = Number(overallCoh.mismatch_pct_of_comparable || 0);

        const concernTags = cids
          .map((cid) => `<span class="tag">${esc(concernLabelById(cid) || cid)}</span>`)
          .join("");

        const coverageLines = cids
          .map((cid) => {
            const topics = topicsForConcernAll(cid);
            const votes = coverageStatsForTopics(topics, coh.votesPosByKey);
            const declared = coverageStatsForTopics(topics, coh.declaredPosByKey);
            const combined = coverageStatsForTopics(topics, coh.combinedPosByKey);
            const cohTotals = coherenceTotalsForTopics(topics, coh.votesPosByKey, coh.declaredPosByKey);
            return (
              `<div class="rowMeta">` +
              `<span class="tag"><strong>${esc(concernLabelById(cid) || cid)}</strong></span>` +
              `<span class="tag">items=${esc(fmtInt(votes.items_total))}</span>` +
              `<span class="tag">votos any=${esc(fmtPct01(votes.any_signal_pct))} clear=${esc(fmtPct01(votes.clear_pct))}</span>` +
              `<span class="tag">dichos any=${esc(fmtPct01(declared.any_signal_pct))} clear=${esc(fmtPct01(declared.clear_pct))}</span>` +
              `<span class="tag">combinado any=${esc(fmtPct01(combined.any_signal_pct))} clear=${esc(fmtPct01(combined.clear_pct))}</span>` +
              `<span class="tag">comparables=${esc(fmtInt(cohTotals.comparable))}</span>` +
              `<span class="tag">mismatch=${esc(fmtInt(cohTotals.mismatch))}</span>` +
              `</div>`
            );
          })
          .join("");

        let rows = (state.citizen.parties || []).map((party) => {
          const pid = Number(party.party_id || 0);
          return coherenceSummaryForParty(topicsUnion, pid, coh.votesPosByKey, coh.declaredPosByKey);
        });

        // Sort: reuse partySort selector semantics in coherence mode.
        rows.sort((a, b) => {
          if (sortMode === "coverage") {
            const ac = Number(a.comparable_ratio || 0);
            const bc = Number(b.comparable_ratio || 0);
            if (bc !== ac) return bc - ac;
          }
          if (sortMode === "confidence") {
            const am = Number(a.mismatch || 0);
            const bm = Number(b.mismatch || 0);
            if (bm !== am) return bm - am;
          }
          const an = partyName(a.party_id);
          const bn = partyName(b.party_id);
          return an.localeCompare(bn);
        });

        el.innerHTML =
          `<div class="empty" style="margin-bottom: 12px">` +
          `<div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between">` +
          `<div><strong>Coherencia</strong> (votos vs dichos)</div>` +
          `<div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">` +
          `<span class="tag">items=${esc(fmtInt(topicsUnion.length))}</span>` +
          `<span class="tag">comparables=${esc(fmtInt(overallCoh.comparable))}</span>` +
          `<span class="tag">mismatch=${esc(fmtInt(overallCoh.mismatch))} (${esc(fmtPct01(mismatchPct))} de comparables)</span>` +
          (state.activePartyId ? `<span class="tag">foco=${esc(partyName(state.activePartyId))}</span>` : "") +
          (state.activePartyId ? `<button class="btn" data-clear-party-focus="1" type="button">Salir foco</button>` : "") +
          `</div>` +
          `</div>` +
          `<div class="rowMeta" style="margin-top:8px">` +
          `<span class="tag">Comparable solo si ambos son A favor / En contra</span>` +
          `<span class="tag">mixed/unclear/no_signal = no comparable</span>` +
          `</div>` +
          `<div class="rowMeta" style="margin-top:8px">` +
          `<span class="tag">Seleccionadas:</span>` +
          `<span class="tags">${concernTags || ""}</span>` +
          `</div>` +
          (coverageLines ? `<div style="margin-top:10px; display:flex; flex-direction:column; gap:8px">${coverageLines}</div>` : "") +
          `</div>` +
          (rows.length
            ? rows
                .map((r) => {
                  const pid = Number(r.party_id || 0);
                  const itemsTotal = Number(r.items_total || 0);
                  const comparable = Number(r.comparable || 0);
                  const match = Number(r.match || 0);
                  const mismatch = Number(r.mismatch || 0);
                  const notComp = Number(r.not_comparable || 0);
                  const comparableRatio = Number(r.comparable_ratio || 0);
                  const mismatchRatio = Number(r.mismatch_ratio || 0);

                  const focused = state.activePartyId && Number(state.activePartyId) === pid;

                  const auditTopic = r.audit_mismatch_topic || r.audit_match_topic || null;
                  const auditIsMismatch = Boolean(r.audit_mismatch_topic);
                  const auditTid = auditTopic ? Number(auditTopic.topic_id || 0) : 0;

                  const vt = auditTid ? coh.votesTopicById.get(auditTid) : null;
                  const dt = auditTid ? coh.declaredTopicById.get(auditTid) : null;
                  const temasLink = vt && vt.links ? String(vt.links.explorer_temas || "") : "";
                  const votosLink = vt && vt.links ? String(vt.links.explorer_positions || "") : "";
                  const dichosLink = dt && dt.links ? String(dt.links.explorer_positions || "") : "";

                  const sv = auditTid ? stanceFromPosMap(coh.votesPosByKey, auditTid, pid) : "no_signal";
                  const sd = auditTid ? stanceFromPosMap(coh.declaredPosByKey, auditTid, pid) : "no_signal";

                  return (
                    `<div class="partyCard ${focused ? "focused" : ""}">` +
                    `<div class="partyHead">` +
                    `<div class="partyName">${esc(partyName(pid))}</div>` +
                    `<div class="tags">` +
                    `<span class="tag">${esc(auditIsMismatch ? "mismatch" : auditTopic ? "match" : "sin comparables")}</span>` +
                    `</div>` +
                    `</div>` +
                    `<div class="barWrap">` +
                    `<div class="barLabel"><span>Comparables</span><span class="mono">${esc(fmtInt(comparable))}/${esc(
                      fmtInt(itemsTotal)
                    )} (${esc(fmtPct01(comparableRatio))})</span></div>` +
                    `<div class="bar"><div style="width:${Math.round(comparableRatio * 100)}%"></div></div>` +
                    `</div>` +
                    `<div class="barWrap">` +
                    `<div class="barLabel"><span>Mismatch (de comparables)</span><span class="mono">${esc(fmtInt(mismatch))}/${esc(
                      fmtInt(comparable)
                    )} (${esc(fmtPct01(mismatchRatio))})</span></div>` +
                    `<div class="bar"><div style="width:${Math.round(mismatchRatio * 100)}%"></div></div>` +
                    `</div>` +
                    `<div class="partyMeta">` +
                    `<span class="tag">match=${esc(fmtInt(match))}</span>` +
                    `<span class="tag">mismatch=${esc(fmtInt(mismatch))}</span>` +
                    `<span class="tag">no_comparable=${esc(fmtInt(notComp))}</span>` +
                    `</div>` +
                    `<div class="partyMeta">` +
                    `<button class="btn" type="button" data-focus-party="${esc(String(pid))}">Foco partido</button>` +
                    (temasLink
                      ? `<a class="smallLink" href="${esc(String(temasLink))}" target="_blank" rel="noopener noreferrer">Auditar tema</a>`
                      : `<span class="tag">sin audit link</span>`) +
                    `</div>` +
                    (auditTopic
                      ? `<div class="partyMeta">` +
                        `<span class="tag">Ejemplo:</span>` +
                        `<span class="tag">${esc(String(auditTopic.label || `topic_id=${auditTid}`))}</span>` +
                        `<span class="stanceChip mini ${esc(sv)}"><span class="dot ${esc(dotClassForStance(sv))}"></span>votos: ${esc(
                          stanceLabel(sv)
                        )}</span>` +
                        `<span class="stanceChip mini ${esc(sd)}"><span class="dot ${esc(dotClassForStance(sd))}"></span>dichos: ${esc(
                          stanceLabel(sd)
                        )}</span>` +
                        (votosLink
                          ? `<a class="smallLink" href="${esc(String(votosLink))}" target="_blank" rel="noopener noreferrer">Votos (SQL)</a>`
                          : ``) +
                        (dichosLink
                          ? `<a class="smallLink" href="${esc(String(dichosLink))}" target="_blank" rel="noopener noreferrer">Dichos (SQL)</a>`
                          : ``) +
                        `</div>`
                      : ``) +
                    `</div>`
                  );
                })
                .join("")
            : `<div class="empty">No hay partidos para mostrar.</div>`);

        for (const btn of el.querySelectorAll("[data-focus-party]")) {
          btn.addEventListener("click", () => {
            const pid = Number(btn.getAttribute("data-focus-party") || 0);
            setPartyFocus(pid);
          });
        }
        for (const btn of el.querySelectorAll("[data-clear-party-focus]")) {
          btn.addEventListener("click", () => {
            clearPartyFocus();
          });
        }
      }

      function renderAlignmentCompare(el, { sortMode } = {}) {
        const tid = Number(state.activeTopicId || 0);
        const alignmentSort = String(sortMode || "coverage");

        const prefsItems = [];
        const keys = Array.from(state.prefs.keys()).map((x) => Number(x || 0));
        keys.sort((a, b) => a - b);
        for (const k of keys) {
          const pref = normalizePrefValue(state.prefs.get(k));
          const t = state.topicById.get(Number(k)) || null;
          if (!pref || !t) continue;
          prefsItems.push({ topic_id: Number(k), pref, topic: t });
        }

        const supportN = prefsItems.filter((x) => x.pref === "support").length;
        const opposeN = prefsItems.filter((x) => x.pref === "oppose").length;

        let selectedTopicHtml = "";
        if (tid && state.topicById.get(tid)) {
          const t = state.topicById.get(tid);
          const pref = normalizePrefValue(state.prefs.get(tid));
          const temasLink = t && t.links ? String(t.links.explorer_temas || "") : "";
          const posLink = t && t.links ? String(t.links.explorer_positions || "") : "";

          selectedTopicHtml =
            `<div class="empty" style="margin-bottom: 12px">` +
            `<div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-start; justify-content:space-between">` +
            `<div style="min-width:0"><strong>Tema seleccionado</strong><div style="margin-top:6px">${esc(String(t.label || ""))}</div></div>` +
            `<div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end">` +
            (temasLink ? `<a class="pill neutral" href="${esc(temasLink)}" target="_blank" rel="noopener noreferrer">Auditar en Temas</a>` : "") +
            (posLink ? `<a class="pill neutral" href="${esc(posLink)}" target="_blank" rel="noopener noreferrer">Posiciones (SQL)</a>` : "") +
            `</div>` +
            `</div>` +
            `<div class="rowMeta" style="margin-top:10px">` +
            `<span class="tag">Tu preferencia:</span>` +
            `<button class="stanceChip mini support" type="button" data-pref-set="support" data-tid="${esc(String(tid))}">Yo: a favor</button>` +
            `<button class="stanceChip mini oppose" type="button" data-pref-set="oppose" data-tid="${esc(String(tid))}">Yo: en contra</button>` +
            `<button class="btn" type="button" data-pref-clear="1" data-tid="${esc(String(tid))}">Quitar</button>` +
            (pref
              ? `<span class="stanceChip mini ${esc(pref)}"><span class="dot ${esc(dotClassForStance(pref))}"></span>${esc(
                  stanceLabel(pref)
                )}</span>`
              : `<span class="tag">sin preferencia</span>`) +
            `</div>` +
            `</div>`;
        }

        const prefsHeader =
          `<div class="empty" style="margin-bottom: 12px">` +
          `<div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between">` +
          `<div><strong>Alineamiento</strong></div>` +
          `<div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end">` +
          `<span class="tag">${esc(computedMethodLabel())}</span>` +
          `<span class="tag">prefs=${esc(fmtInt(prefsItems.length))}</span>` +
          `<span class="tag">a_favor=${esc(fmtInt(supportN))}</span>` +
          `<span class="tag">en_contra=${esc(fmtInt(opposeN))}</span>` +
          (state.activePartyId ? `<span class="tag">foco=${esc(partyName(state.activePartyId))}</span>` : "") +
          (state.activePartyId ? `<button class="btn" data-clear-party-focus="1" type="button">Salir foco</button>` : "") +
          `</div>` +
          `</div>` +
          `<div class="rowMeta" style="margin-top:8px">` +
          `<span class="tag">Honestidad</span>` +
          `<span>match/mismatch solo cuando el partido tiene senal clara (a_favor/en_contra). Todo lo demas es <strong>unknown</strong>.</span>` +
          `</div>` +
          `<div class="rowMeta" style="margin-top:8px">` +
          `<span class="tag">Privacidad</span>` +
          `<span>tus preferencias se guardan solo en tu navegador. El link compartible (si lo generas) usa el fragmento <span class="mono">#...</span>.</span>` +
          `</div>` +
          `<div class="rowMeta" style="margin-top:10px">` +
          `<button class="btn" type="button" data-prefs-clear-all="1" ${prefsItems.length ? "" : "disabled"}>Borrar preferencias</button>` +
          `<button class="btn" type="button" data-prefs-share="1" ${prefsItems.length ? "" : "disabled"}>Generar link</button>` +
          `<button class="btn" type="button" data-prefs-download="1" ${prefsItems.length ? "" : "disabled"}>Descargar JSON</button>` +
          `<label class="btn" style="display:inline-flex; align-items:center; gap:8px; cursor:pointer">` +
          `Importar JSON<input id="prefsUpload" type="file" accept=\"application/json\" style="display:none" />` +
          `</label>` +
          `</div>` +
          `<div class="rowMeta" id="prefsShareWrap" style="margin-top:10px; display:none">` +
          `<input id="prefsShareLink" type="text" value="" readonly style="flex:1 1 320px" />` +
          `<button class="btn" type="button" data-prefs-copy="1">Copiar</button>` +
          `</div>` +
          `</div>`;

        if (!prefsItems.length) {
          el.innerHTML =
            selectedTopicHtml +
            prefsHeader +
            `<div class="empty">` +
            `<strong>Empieza aqui</strong>: selecciona un item en la columna 2 y marca <span class="mono">Yo: a favor</span> o <span class="mono">Yo: en contra</span>.` +
            `<div style="margin-top:8px">Veras un resumen por partido con <span class="mono">match/mismatch/unknown</span> y cobertura.</div>` +
            `</div>`;
        } else {
          const rows = [];
          for (const party of state.citizen.parties || []) {
            const pid = Number(party.party_id || 0);
            let match = 0;
            let mismatch = 0;
            let unknown = 0;
            let auditMatchTopic = null;
            let auditMismatchTopic = null;

            for (const it of prefsItems) {
              const stance = stanceFromPosMap(state.posByKey, it.topic_id, pid);
              if (isComparableStance(stance)) {
                if (stance === it.pref) {
                  match += 1;
                  if (!auditMatchTopic) auditMatchTopic = it.topic;
                } else {
                  mismatch += 1;
                  if (!auditMismatchTopic) auditMismatchTopic = it.topic;
                }
              } else {
                unknown += 1;
              }
            }

            const comparable = match + mismatch;
            const coverage = prefsItems.length > 0 ? comparable / prefsItems.length : 0;
            const net = match - mismatch;
            rows.push({
              party_id: pid,
              match,
              mismatch,
              unknown,
              comparable,
              coverage,
              net,
              audit_match_topic: auditMatchTopic,
              audit_mismatch_topic: auditMismatchTopic,
            });
          }

          rows.sort((a, b) => {
            if (alignmentSort === "coverage") {
              if (b.coverage !== a.coverage) return b.coverage - a.coverage;
              if (b.net !== a.net) return b.net - a.net;
            } else if (alignmentSort === "confidence") {
              // Reuse control slot: in alignment mode, "confidence" means net match.
              if (b.net !== a.net) return b.net - a.net;
              if (b.coverage !== a.coverage) return b.coverage - a.coverage;
            }
            return partyName(a.party_id).localeCompare(partyName(b.party_id));
          });

          el.innerHTML =
            selectedTopicHtml +
            prefsHeader +
            (rows.length
              ? rows
                  .map((r) => {
                    const pid = Number(r.party_id || 0);
                    const focused = state.activePartyId && Number(state.activePartyId) === pid;
                    const auditMismatch = r.audit_mismatch_topic || null;
                    const auditMatch = r.audit_match_topic || null;
                    const mismatchLink = auditMismatch && auditMismatch.links ? String(auditMismatch.links.explorer_temas || "") : "";
                    const matchLink = auditMatch && auditMatch.links ? String(auditMatch.links.explorer_temas || "") : "";
                    const cov = Number(r.coverage || 0);

                    return (
                      `<div class="partyCard ${focused ? "focused" : ""}">` +
                      `<div class="partyHead">` +
                      `<div class="partyName">${esc(partyName(pid))}</div>` +
                      `<div class="tags">` +
                      `<span class="tag">match=${esc(fmtInt(r.match))}</span>` +
                      `<span class="tag">mismatch=${esc(fmtInt(r.mismatch))}</span>` +
                      `<span class="tag">unknown=${esc(fmtInt(r.unknown))}</span>` +
                      `<span class="tag">net=${esc(fmtInt(r.net))}</span>` +
                      `</div>` +
                      `</div>` +
                      `<div class="barWrap">` +
                      `<div class="barLabel"><span>Cobertura (comparables)</span><span class="mono">${esc(fmtInt(r.comparable))}/${esc(
                        fmtInt(prefsItems.length)
                      )} (${esc(fmtPct01(cov))})</span></div>` +
                      `<div class="bar"><div style="width:${Math.round(cov * 100)}%"></div></div>` +
                      `</div>` +
                      `<div class="partyMeta">` +
                      `<button class="btn" type="button" data-focus-party="${esc(String(pid))}">Foco</button>` +
                      (mismatchLink
                        ? `<a class="smallLink" href="${esc(mismatchLink)}" target="_blank" rel="noopener noreferrer">Auditar mismatch</a>`
                        : `<span class="tag">sin mismatch</span>`) +
                      (matchLink
                        ? `<a class="smallLink" href="${esc(matchLink)}" target="_blank" rel="noopener noreferrer">Auditar match</a>`
                        : `<span class="tag">sin match</span>`) +
                      `</div>` +
                      `</div>`
                    );
                  })
                  .join("")
              : `<div class="empty">No hay partidos para mostrar.</div>`);

          if (state.activePartyId) {
            const pid = Number(state.activePartyId);
            const detailRows = prefsItems
              .map((it) => {
                const stance = stanceFromPosMap(state.posByKey, it.topic_id, pid);
                const comparable = isComparableStance(stance);
                const res = comparable ? (stance === it.pref ? "match" : "mismatch") : "unknown";
                const resClass = res === "match" ? "good" : res === "mismatch" ? "bad" : "";
                const temasLink = it.topic && it.topic.links ? String(it.topic.links.explorer_temas || "") : "";
                const posLink = it.topic && it.topic.links ? String(it.topic.links.explorer_positions || "") : "";

                return (
                  `<div class="partyCard">` +
                  `<div class="partyHead">` +
                  `<div class="partyName">${esc(String(it.topic.label || ""))}</div>` +
                  `<span class="tag ${esc(resClass)}">${esc(res)}</span>` +
                  `</div>` +
                  `<div class="partyMeta">` +
                  `<span class="stanceChip mini ${esc(it.pref)}"><span class="dot ${esc(dotClassForStance(it.pref))}"></span>tu:${esc(
                    stanceLabel(it.pref)
                  )}</span>` +
                  `<span class="stanceChip mini ${esc(stance)}"><span class="dot ${esc(dotClassForStance(stance))}"></span>${esc(
                    stanceLabel(stance)
                  )}</span>` +
                  (temasLink ? `<a class="smallLink" href="${esc(temasLink)}" target="_blank" rel="noopener noreferrer">Temas</a>` : "") +
                  (posLink ? `<a class="smallLink" href="${esc(posLink)}" target="_blank" rel="noopener noreferrer">SQL</a>` : "") +
                  `</div>` +
                  `</div>`
                );
              })
              .join("");

            el.innerHTML +=
              `<div class="empty" style="margin-top: 12px">` +
              `<strong>Foco partido</strong>: ${esc(partyName(pid))}` +
              `<div style="margin-top:8px">Detalle por tema (tu preferencia vs posicion del partido).</div>` +
              `</div>` +
              detailRows;
          }
        }

        for (const btn of el.querySelectorAll("[data-focus-party]")) {
          btn.addEventListener("click", () => {
            const pid = Number(btn.getAttribute("data-focus-party") || 0);
            setPartyFocus(pid);
          });
        }
        for (const btn of el.querySelectorAll("[data-clear-party-focus]")) {
          btn.addEventListener("click", () => {
            clearPartyFocus();
          });
        }

        for (const btn of el.querySelectorAll("[data-pref-set]")) {
          btn.addEventListener("click", () => {
            const pref = String(btn.getAttribute("data-pref-set") || "");
            const t = Number(btn.getAttribute("data-tid") || 0);
            setPrefForTopic(t, pref);
          });
        }
        for (const btn of el.querySelectorAll("[data-pref-clear]")) {
          btn.addEventListener("click", () => {
            const t = Number(btn.getAttribute("data-tid") || 0);
            clearPrefForTopic(t);
          });
        }
        for (const btn of el.querySelectorAll("[data-prefs-clear-all]")) {
          btn.addEventListener("click", () => {
            clearAllPrefs();
          });
        }
        for (const btn of el.querySelectorAll("[data-prefs-share]")) {
          btn.addEventListener("click", () => {
            const wrap = qs("#prefsShareWrap");
            const inp = qs("#prefsShareLink");
            if (!wrap || !inp) return;
            inp.value = buildShareUrlWithPrefs(state.prefs);
            wrap.style.display = "flex";
            inp.focus();
            inp.select();
          });
        }
        for (const btn of el.querySelectorAll("[data-prefs-copy]")) {
          btn.addEventListener("click", async () => {
            const inp = qs("#prefsShareLink");
            if (!inp) return;
            const txt = String(inp.value || "");
            if (!txt) return;
            try {
              await navigator.clipboard.writeText(txt);
            } catch {
              inp.focus();
              inp.select();
            }
          });
        }
        for (const btn of el.querySelectorAll("[data-prefs-download]")) {
          btn.addEventListener("click", () => {
            const keys = Array.from(state.prefs.keys()).map((x) => Number(x || 0));
            keys.sort((a, b) => a - b);
            const items = [];
            for (const k of keys) {
              const pref = normalizePrefValue(state.prefs.get(k));
              if (!pref) continue;
              const t = state.topicById.get(k) || null;
              items.push({ topic_id: k, pref, label: t ? String(t.label || "") : "" });
            }
            const blob = new Blob([JSON.stringify({ version: "prefs_v1", items }, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "vclc_prefs_v1.json";
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 2500);
          });
        }
        const upload = qs("#prefsUpload");
        if (upload) {
          upload.addEventListener("change", async () => {
            const file = upload.files && upload.files[0] ? upload.files[0] : null;
            upload.value = "";
            if (!file) return;
            try {
              const txt = await file.text();
              const obj = JSON.parse(txt);
              const items = Array.isArray(obj.items) ? obj.items : [];
              const next = new Map();
              for (const it of items) {
                const tid = Number(it.topic_id || 0);
                const pref = normalizePrefValue(it.pref);
                if (!Number.isFinite(tid) || tid <= 0) continue;
                if (!pref) continue;
                if (!state.topicById.has(tid)) continue;
                next.set(tid, pref);
              }
              state.prefs = next;
              persistPrefs();
              renderTopicList();
              renderCompare();
            } catch (err) {
              setBanner(`<div><strong>Error al importar prefs</strong>: <span class="mono">${esc(String(err))}</span></div>`);
            }
          });
        }
      }

      function renderCompare() {
        const el = qs("#compare");
        if (!el) return;
        const tid = Number(state.activeTopicId || 0);
        const filter = String(qs("#stanceFilter")?.value || "all");
        const sortMode = String(qs("#partySort")?.value || "name");
        const alignmentMode = state.viewMode === "alignment";
        const coherenceMode = state.viewMode === "coherence";
        const stanceSel = qs("#stanceFilter");
        if (stanceSel) {
          stanceSel.disabled = coherenceMode || alignmentMode;
          if (coherenceMode || alignmentMode) stanceSel.value = "all";
        }

        if (!state.activeConcernId) {
          el.innerHTML = `<div class="empty">Elige una preocupacion para empezar.</div>`;
          return;
        }

        if (alignmentMode) {
          renderAlignmentCompare(el, { sortMode });
          return;
        }

        if (!tid) {
          const selected = normalizeSelectedConcernIds(state.selectedConcernIds || []);
          if (coherenceMode) {
            renderCoherenceCompare(el, selected, { sortMode });
            return;
          }
          const isDashboard = state.viewMode === "dashboard";
          if (isDashboard) {
            if (selected.length < 2) {
              el.innerHTML =
                `<div class="empty">` +
                `<strong>Mi dashboard</strong>: selecciona al menos <strong>2</strong> preocupaciones en la columna 1 (se guardan arriba) para ver un resumen multi-concern.` +
                `</div>`;
              return;
            }

            const sum = dashboardPartySummaries();
            if (!sum.items_total) {
              el.innerHTML = `<div class="empty">No hay items para las preocupaciones seleccionadas.</div>`;
              return;
            }

            let rows = (sum.rows || []).slice();
            if (filter && filter !== "all") {
              rows = rows.filter((r) => String(r.stance || "") === filter);
            }

            rows.sort((a, b) => {
              if (sortMode === "coverage") {
                const ac = Number(a.coverage_items_ratio || 0);
                const bc = Number(b.coverage_items_ratio || 0);
                if (bc !== ac) return bc - ac;
              }
              if (sortMode === "confidence") {
                const acf = Number(a.confidence_avg || 0);
                const bcf = Number(b.confidence_avg || 0);
                if (bcf !== acf) return bcf - acf;
              }
              const an = partyName(a.party_id);
              const bn = partyName(b.party_id);
              return an.localeCompare(bn);
            });

            const concernTags = (sum.concern_ids || [])
              .map((cid) => `<span class="tag">${esc(concernLabelById(cid) || cid)}</span>`)
              .join("");

            el.innerHTML =
              `<div class="empty" style="margin-bottom: 12px">` +
              `<div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between">` +
              `<div><strong>Mi dashboard</strong></div>` +
              `<div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">` +
              `<span class="tag">${esc(computedMethodLabel())}</span>` +
              `<span class="tag">${esc(fmtInt(sum.items_total))} items (union)</span>` +
              `<span class="tag">${esc(fmtInt((sum.concern_ids || []).length))} preocupaciones</span>` +
              (state.activePartyId ? `<span class="tag">foco=${esc(partyName(state.activePartyId))}</span>` : "") +
              (state.activePartyId
                ? `<button class="btn" data-clear-party-focus="1" type="button">Salir foco</button>`
                : "") +
              `</div>` +
              `</div>` +
              `<div class="rowMeta" style="margin-top:8px">` +
              `<span class="tag">Seleccionadas:</span>` +
              `<span class="tags">${concernTags || ""}</span>` +
              `</div>` +
              `</div>` +
              (rows.length
                ? rows
                    .map((r) => {
                      const pid = Number(r.party_id || 0);
                      const stance = String(r.stance || "no_signal");
                      const counts = r.counts || {};
                      const itemsTotal = Number(r.items_total || 0);
                      const clearTotal = Number(r.clear_total || 0);
                      const cov = Number(r.coverage_items_ratio || 0);
                      const conf = Number(r.confidence_avg || 0);

                      const audit = r.audit_topic || null;
                      const auditLink = audit && audit.links ? String(audit.links.explorer_temas || "") : "";

                      const progSum = programasSummaryForParty(pid, sum.concern_ids || []);
                      const progStance = String((progSum || {}).stance || "no_signal");
                      const progConf = Number((progSum || {}).confidence_avg || 0);
                      const progLink = String((progSum || {}).audit_link || "");
                      const progCounts = (progSum || {}).counts || {};

                      const focused = state.activePartyId && Number(state.activePartyId) === pid;

                      return (
                        `<div class="partyCard ${focused ? "focused" : ""}">` +
                        `<div class="partyHead">` +
                        `<div class="partyName">${esc(partyName(pid))}</div>` +
                        `<div class="stanceChip ${esc(stance)}"><span class="dot ${esc(dotClassForStance(stance))}"></span>${esc(
                          stanceLabel(stance)
                        )}</div>` +
                        `</div>` +
                        `<div class="barWrap">` +
                        `<div class="barLabel"><span>Cobertura (items)</span><span class="mono">${esc(clearTotal)}/${esc(
                          itemsTotal
                        )} (${esc(fmtPct01(cov))})</span></div>` +
                        `<div class="bar"><div style="width:${Math.round(cov * 100)}%"></div></div>` +
                        `</div>` +
                        `<div class="barWrap">` +
                        `<div class="barLabel"><span>Confianza promedio</span><span class="mono">${esc(fmtPct01(conf))}</span></div>` +
                        `<div class="bar"><div style="width:${Math.round(conf * 100)}%"></div></div>` +
                        `</div>` +
                        `<div class="partyMeta">` +
                        `<span class="tag">items=${esc(fmtInt(itemsTotal))}</span>` +
                        `<span class="tag">a_favor=${esc(fmtInt(Number(counts.support || 0)))}</span>` +
                        `<span class="tag">en_contra=${esc(fmtInt(Number(counts.oppose || 0)))}</span>` +
                        `<span class="tag">mixto=${esc(fmtInt(Number(counts.mixed || 0)))}</span>` +
                        `<span class="tag">incierto=${esc(fmtInt(Number(counts.unclear || 0)))}</span>` +
                        `<span class="tag">sin_senal=${esc(fmtInt(Number(counts.no_signal || 0)))}</span>` +
                        `</div>` +
                        `<div class="partyMeta">` +
                        `<button class="btn" type="button" data-focus-party="${esc(String(pid))}">Ver top items</button>` +
                        (auditLink
                          ? `<a class="smallLink" href="${esc(String(auditLink))}" target="_blank" rel="noopener noreferrer">Auditar item</a>`
                          : `<span class="tag">sin audit link</span>`) +
                        `</div>` +
                        `<div class="partyMeta">` +
                        `<span class="tag">Programa</span>` +
                        `<span class="stanceChip mini ${esc(progStance)}">` +
                        `<span class="dot ${esc(dotClassForStance(progStance))}"></span>${esc(stanceLabel(progStance))}` +
                        `</span>` +
                        `<span class="tag">conf=${esc(fmtPct01(progConf))}</span>` +
                        `<span class="tag">ok=${esc(fmtInt(Number(progCounts.support || 0) + Number(progCounts.oppose || 0) + Number(progCounts.mixed || 0)))}/${esc(
                          fmtInt(Number((sum.concern_ids || []).length))
                        )}</span>` +
                        (progLink
                          ? `<a class="smallLink" href="${esc(String(progLink))}" target="_blank" rel="noopener noreferrer">Evidencia (programa)</a>`
                          : `<span class="tag">sin evidencia</span>`) +
                        `</div>` +
                        `</div>`
                      );
                    })
                    .join("")
                : `<div class="empty">No hay partidos que coincidan con el filtro actual.</div>`);

            for (const btn of el.querySelectorAll("[data-focus-party]")) {
              btn.addEventListener("click", () => {
                const pid = Number(btn.getAttribute("data-focus-party") || 0);
                setPartyFocus(pid);
              });
            }
            for (const btn of el.querySelectorAll("[data-clear-party-focus]")) {
              btn.addEventListener("click", () => {
                clearPartyFocus();
              });
            }
            return;
          }

          const cid = String(state.activeConcernId || "");
          const cobj = (state.concerns || []).find((c) => String(c.id || "") === cid) || null;
          const concernLabel = cobj ? String(cobj.label || cid) : cid;

          const sum = concernPartySummaries();
          if (!sum.items_total) {
            el.innerHTML = `<div class="empty">No hay items para esta preocupacion.</div>`;
            return;
          }

          let rows = (sum.rows || []).slice();
          if (filter && filter !== "all") {
            rows = rows.filter((r) => String(r.stance || "") === filter);
          }

          rows.sort((a, b) => {
            if (sortMode === "coverage") {
              const ac = Number(a.coverage_items_ratio || 0);
              const bc = Number(b.coverage_items_ratio || 0);
              if (bc !== ac) return bc - ac;
            }
            if (sortMode === "confidence") {
              const acf = Number(a.confidence_avg || 0);
              const bcf = Number(b.confidence_avg || 0);
              if (bcf !== acf) return bcf - acf;
            }
            const an = partyName(a.party_id);
            const bn = partyName(b.party_id);
            return an.localeCompare(bn);
          });

          el.innerHTML =
            `<div class="empty" style="margin-bottom: 12px">` +
            `<div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between">` +
            `<div><strong>${esc(concernLabel)}</strong></div>` +
            `<div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">` +
            `<span class="tag">${esc(computedMethodLabel())}</span>` +
            `<span class="tag">${esc(fmtInt(sum.items_total))} items (total)</span>` +
            (state.activePartyId ? `<span class="tag">foco=${esc(partyName(state.activePartyId))}</span>` : "") +
            (state.activePartyId
              ? `<button class="btn" data-clear-party-focus="1" type="button">Salir foco</button>`
              : "") +
            `</div>` +
            `</div>` +
            `<div class="rowMeta" style="margin-top:8px">` +
            `<span class="tag">Resumen global: todos los items etiquetados</span>` +
            `<span class="tag">Columna 2 sirve para navegar/buscar items</span>` +
            `<span class="tag">Cobertura(items) = (a_favor+en_contra+mixto)/items</span>` +
            `</div>` +
            `</div>` +
            (rows.length
              ? rows
                  .map((r) => {
                    const pid = Number(r.party_id || 0);
                    const stance = String(r.stance || "no_signal");
                    const counts = r.counts || {};
                    const itemsTotal = Number(r.items_total || 0);
                    const clearTotal = Number(r.clear_total || 0);
                    const cov = Number(r.coverage_items_ratio || 0);
                    const conf = Number(r.confidence_avg || 0);

                    const audit = r.audit_topic || null;
                    const auditLink = audit && audit.links ? String(audit.links.explorer_temas || "") : "";

                    const progKey = `${String(state.activeConcernId || "")}:${pid}`;
                    const prog = state.progByKey.get(progKey) || null;
                    const progStance = prog ? String(prog.stance || "no_signal") : "no_signal";
                    const progConf = prog ? Number(prog.confidence || 0) : 0;
                    const progLink = prog && prog.links ? String(prog.links.explorer_evidence || "") : "";

                    const focused = state.activePartyId && Number(state.activePartyId) === pid;

                    return (
                      `<div class="partyCard ${focused ? "focused" : ""}">` +
                      `<div class="partyHead">` +
                      `<div class="partyName">${esc(partyName(pid))}</div>` +
                      `<div class="stanceChip ${esc(stance)}"><span class="dot ${esc(dotClassForStance(stance))}"></span>${esc(
                        stanceLabel(stance)
                      )}</div>` +
                      `</div>` +
                      `<div class="barWrap">` +
                      `<div class="barLabel"><span>Cobertura (items)</span><span class="mono">${esc(clearTotal)}/${esc(
                        itemsTotal
                      )} (${esc(fmtPct01(cov))})</span></div>` +
                      `<div class="bar"><div style="width:${Math.round(cov * 100)}%"></div></div>` +
                      `</div>` +
                      `<div class="barWrap">` +
                      `<div class="barLabel"><span>Confianza promedio</span><span class="mono">${esc(fmtPct01(conf))}</span></div>` +
                      `<div class="bar"><div style="width:${Math.round(conf * 100)}%"></div></div>` +
                      `</div>` +
                      `<div class="partyMeta">` +
                      `<span class="tag">items=${esc(fmtInt(itemsTotal))}</span>` +
                      `<span class="tag">a_favor=${esc(fmtInt(Number(counts.support || 0)))}</span>` +
                      `<span class="tag">en_contra=${esc(fmtInt(Number(counts.oppose || 0)))}</span>` +
                      `<span class="tag">mixto=${esc(fmtInt(Number(counts.mixed || 0)))}</span>` +
                      `<span class="tag">incierto=${esc(fmtInt(Number(counts.unclear || 0)))}</span>` +
                      `<span class="tag">sin_senal=${esc(fmtInt(Number(counts.no_signal || 0)))}</span>` +
                      `</div>` +
                      `<div class="partyMeta">` +
                      `<button class="btn" type="button" data-focus-party="${esc(String(pid))}">Ver top items</button>` +
                      (auditLink
                        ? `<a class="smallLink" href="${esc(String(auditLink))}" target="_blank" rel="noopener noreferrer">Auditar top item</a>`
                        : `<span class="tag">sin audit link</span>`) +
                      `</div>` +
                      `<div class="partyMeta">` +
                      `<span class="tag">Programa</span>` +
                      `<span class="stanceChip mini ${esc(progStance)}">` +
                      `<span class="dot ${esc(dotClassForStance(progStance))}"></span>${esc(stanceLabel(progStance))}` +
                      `</span>` +
                      `<span class="tag">conf=${esc(fmtPct01(progConf))}</span>` +
                      (progLink
                        ? `<a class="smallLink" href="${esc(String(progLink))}" target="_blank" rel="noopener noreferrer">Evidencia (programa)</a>`
                        : `<span class="tag">sin evidencia</span>`) +
                      `</div>` +
                      `</div>`
                    );
                  })
                  .join("")
              : `<div class="empty">No hay partidos que coincidan con el filtro actual.</div>`);

          for (const btn of el.querySelectorAll("[data-focus-party]")) {
            btn.addEventListener("click", () => {
              const pid = Number(btn.getAttribute("data-focus-party") || 0);
              setPartyFocus(pid);
            });
          }
          for (const btn of el.querySelectorAll("[data-clear-party-focus]")) {
            btn.addEventListener("click", () => {
              clearPartyFocus();
            });
          }
          return;
        }

        const topic = state.topicById.get(tid) || null;
        const rows = positionsForTopic(tid);
        const counts = stanceCounts(rows);

        let filtered = rows.slice();
        if (filter && filter !== "all") {
          filtered = filtered.filter((r) => String(r.stance || "") === filter);
        }

        filtered.sort((a, b) => {
          if (sortMode === "coverage") {
            const ac = Number((a.coverage || {}).members_with_signal || 0) / Math.max(1, Number((a.coverage || {}).members_total || 0));
            const bc = Number((b.coverage || {}).members_with_signal || 0) / Math.max(1, Number((b.coverage || {}).members_total || 0));
            if (bc !== ac) return bc - ac;
          }
          if (sortMode === "confidence") {
            const acf = Number(a.confidence || 0);
            const bcf = Number(b.confidence || 0);
            if (bcf !== acf) return bcf - acf;
          }
          const an = partyName(a.party_id);
          const bn = partyName(b.party_id);
          return an.localeCompare(bn);
        });

        const topicLinks = topic && topic.links ? topic.links : {};

        el.innerHTML =
          `<div class="summaryGrid">` +
          `<div class="kpi"><div class="k">A favor</div><div class="v">${fmtInt(counts.support)}</div></div>` +
          `<div class="kpi"><div class="k">En contra</div><div class="v">${fmtInt(counts.oppose)}</div></div>` +
          `<div class="kpi"><div class="k">Mixto</div><div class="v">${fmtInt(counts.mixed)}</div></div>` +
          `<div class="kpi"><div class="k">Incierto</div><div class="v">${fmtInt(counts.unclear)}</div></div>` +
          `<div class="kpi"><div class="k">Sin senal</div><div class="v">${fmtInt(counts.no_signal)}</div></div>` +
          `</div>` +
          `<div class="empty" style="margin-bottom: 12px">` +
          `<div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between">` +
          `<div><strong>${esc(String(topic ? topic.label : `topic_id=${tid}`))}</strong></div>` +
          `<div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">` +
          (topicLinks.explorer_temas
            ? `<a class="smallLink" href="${esc(String(topicLinks.explorer_temas))}" target="_blank" rel="noopener noreferrer">Abrir en Temas</a>`
            : "") +
          (topicLinks.explorer_evidence
            ? `<a class="smallLink" href="${esc(String(topicLinks.explorer_evidence))}" target="_blank" rel="noopener noreferrer">Evidencia (SQL)</a>`
            : "") +
          `</div>` +
          `</div>` +
          `<div class="rowMeta" style="margin-top:8px">` +
          `<span class="tag">Regla: si cobertura < 20%, mostramos Incierto</span>` +
          `<span class="tag">Cobertura = diputados con senal / total del partido</span>` +
          `</div>` +
          `</div>` +
          (filtered.length
            ? filtered
                .map((r) => {
                  const pid = Number(r.party_id || 0);
                  const stance = String(r.stance || "unclear");
                  const cov = r.coverage || {};
                  const membersTotal = Number(cov.members_total || 0);
                  const membersSignal = Number(cov.members_with_signal || 0);
                  const coverageRatio = membersTotal > 0 ? membersSignal / membersTotal : 0;
                  const conf = Number(r.confidence || 0);
                  const evCount = Number(cov.evidence_count_total || 0);
                  const lastEv = String(cov.last_evidence_date || "");

                  const linkPos = (r.links || {}).explorer_positions || "";
                  const linkTemas = (r.links || {}).explorer_temas || "";

                  const progKey = `${String(state.activeConcernId || "")}:${pid}`;
                  const prog = state.progByKey.get(progKey) || null;
                  const progStance = prog ? String(prog.stance || "no_signal") : "no_signal";
                  const progConf = prog ? Number(prog.confidence || 0) : 0;
                  const progLink = prog && prog.links ? String(prog.links.explorer_evidence || "") : "";

                  return (
                    `<div class="partyCard">` +
                    `<div class="partyHead">` +
                    `<div class="partyName">${esc(partyName(pid))}</div>` +
                    `<div class="stanceChip ${esc(stance)}"><span class="dot ${esc(dotClassForStance(stance))}"></span>${esc(
                      stanceLabel(stance)
                    )}</div>` +
                    `</div>` +
                    `<div class="barWrap">` +
                    `<div class="barLabel"><span>Cobertura</span><span class="mono">${esc(membersSignal)}/${esc(
                      membersTotal
                    )} (${esc(fmtPct01(coverageRatio))})</span></div>` +
                    `<div class="bar"><div style="width:${Math.round(coverageRatio * 100)}%"></div></div>` +
                    `</div>` +
                    `<div class="barWrap">` +
                    `<div class="barLabel"><span>Confianza (conservadora)</span><span class="mono">${esc(fmtPct01(conf))}</span></div>` +
                    `<div class="bar"><div style="width:${Math.round(conf * 100)}%"></div></div>` +
                    `</div>` +
                    `<div class="partyMeta">` +
                    `<span class="tag">evidence_count=${esc(fmtInt(evCount))}</span>` +
                    (lastEv ? `<span class="tag">ultima=${esc(lastEv)}</span>` : `<span class="tag">ultima=?</span>`) +
                    (linkPos ? `<a class="smallLink" href="${esc(String(linkPos))}" target="_blank" rel="noopener noreferrer">Ver posiciones</a>` : "") +
                    (linkTemas ? `<a class="smallLink" href="${esc(String(linkTemas))}" target="_blank" rel="noopener noreferrer">Ver en Temas</a>` : "") +
                    `</div>` +
                    `<div class="partyMeta">` +
                    `<span class="tag">Programa</span>` +
                    `<span class="stanceChip mini ${esc(progStance)}">` +
                    `<span class="dot ${esc(dotClassForStance(progStance))}"></span>${esc(stanceLabel(progStance))}` +
                    `</span>` +
                    `<span class="tag">conf=${esc(fmtPct01(progConf))}</span>` +
                    (progLink
                      ? `<a class="smallLink" href="${esc(String(progLink))}" target="_blank" rel="noopener noreferrer">Evidencia (programa)</a>`
                      : `<span class="tag">sin evidencia</span>`) +
                    `</div>` +
                    `</div>`
                  );
                })
                .join("")
            : `<div class="empty">No hay partidos que coincidan con el filtro actual.</div>`);
      }

      function selectConcern(cid, push) {
        const next = String(cid || "").trim();
        if (!next) return;
        state.activeConcernId = next;
        // Keep party focus when switching concerns (user-first).

        // Ensure selected concerns includes the active one.
        const cur = normalizeSelectedConcernIds([next].concat(state.selectedConcernIds || []));
        state.selectedConcernIds = cur;

        // Reset topic unless it still belongs (based on concern tags, not window filters).
        if (state.activeTopicId) {
          const tags = state.topicTags.get(Number(state.activeTopicId)) || [];
          if (!tags.includes(next)) state.activeTopicId = 0;
        }
        if (state.activeTopicId && state.activeConcernId) {
          // extra guard: activeTopicId must exist.
          if (!state.topicById.get(Number(state.activeTopicId))) {
            state.activeTopicId = 0;
          }
        }
        if (state.activeTopicId && !Number.isFinite(Number(state.activeTopicId))) {
          state.activeTopicId = 0;
        }

        writeUrlState(Boolean(push));
        renderSelectedConcernTags();
        renderConcernList();
        renderTopicList();
        renderCompare();
      }

      function selectTopic(tid, push) {
        const next = Number(tid || 0);
        if (!Number.isFinite(next) || next <= 0) return;
        state.activeTopicId = next;
        writeUrlState(Boolean(push));
        renderTopicList();
        renderCompare();
      }

      async function load() {
        readUrlState();

        // Preferences: local-first by default. Opt-in share uses URL fragment (#prefs=...).
        state.prefsLoadError = "";
        state.prefsLoadedFrom = "empty";
        const fromHash = readPrefsFromHash();
        if (fromHash && fromHash.error) {
          state.prefsLoadError = String(fromHash.error || "prefs hash error");
        }
        if (fromHash && fromHash.prefs) {
          state.prefs = fromHash.prefs;
          state.prefsLoadedFrom = "hash";
          persistPrefs(); // store locally for convenience
        } else {
          state.prefs = prefsFromStorageValue(lsGet(LS_PREFS));
          state.prefsLoadedFrom = state.prefs.size ? "localStorage" : "empty";
        }

        const p = new URLSearchParams(location.search || "");
        const citizenOverride = String(p.get("citizen") || "").trim();
        const wantsMethod = String(p.get("method") || "").trim();
        const concernsPath = String(p.get("concerns") || "./data/concerns_v1.json");

        let citizenPath = citizenOverride;
        if (!citizenPath) {
          // Resolve preferred method before loading data so method toggle can select a dataset file.
          let m = String(state.method || "").trim() || wantsMethod;
          if (!m) m = String(lsGet(LS_METHOD) || "").trim();
          if (!m) m = "combined";
          if (m !== "combined" && m !== "votes" && m !== "declared") m = "combined";
          state.method = m;

          if (m === "votes") citizenPath = "./data/citizen_votes.json";
          else if (m === "declared") citizenPath = "./data/citizen_declared.json";
          else citizenPath = "./data/citizen.json";
        }

        try {
          const citizenP = fetchJson(citizenPath).catch(async (err) => {
            // If the user asked for a method variant but the file isn't present, fall back to default.
            if (!citizenOverride && citizenPath !== "./data/citizen.json") {
              setBanner(
                `<div><strong>Aviso:</strong> no se pudo cargar <span class="mono">${esc(
                  citizenPath
                )}</span>. Se usa <span class="mono">citizen.json</span> por defecto. Error: <span class="mono">${esc(String(err))}</span></div>`
              );
              state.method = "combined";
              return await fetchJson("./data/citizen.json");
            }
            throw err;
          });

          const [citizen, concernsCfg] = await Promise.all([citizenP, fetchJson(concernsPath)]);
          state.citizen = citizen;
          state.concernsCfg = concernsCfg;
          state.concerns = Array.isArray(concernsCfg.concerns) ? concernsCfg.concerns : [];

          state.topicById = new Map();
          for (const t of citizen.topics || []) {
            state.topicById.set(Number(t.topic_id || 0), t);
          }

          // Drop preferences for topics not present in the current snapshot.
          let prefsDropped = 0;
          for (const k of Array.from(state.prefs.keys())) {
            if (!state.topicById.has(Number(k))) {
              state.prefs.delete(Number(k));
              prefsDropped += 1;
            }
          }
          if (prefsDropped) persistPrefs();

          state.partyById = new Map();
          for (const party of citizen.parties || []) {
            state.partyById.set(Number(party.party_id || 0), party);
          }

          state.posByKey = new Map();
          for (const r of citizen.party_topic_positions || []) {
            const key = `${Number(r.topic_id || 0)}:${Number(r.party_id || 0)}`;
            state.posByKey.set(key, r);
          }

          state.progByKey = new Map();
          for (const r of citizen.party_concern_programas || []) {
            const key = `${String(r.concern_id || "")}:${Number(r.party_id || 0)}`;
            state.progByKey.set(key, r);
          }
          state.programasMeta = (citizen.meta || {}).programas || null;

          computeTags();
          ensureConcernState();
          renderSelectedConcernTags();
          renderStatus();

          // Validate initial topic.
          if (state.activeTopicId) {
            const tags = state.topicTags.get(Number(state.activeTopicId)) || [];
            if (!tags.includes(String(state.activeConcernId))) state.activeTopicId = 0;
          }

          writeUrlState(false);

          renderConcernList();
          renderTopicList();
          renderCompare();

          let banner =
            `<div><strong>Nota:</strong> esto es una vista ciudadana. “Programa” es una capa adicional (promesas) derivada de textos y puede requerir revision. Para auditoria completa, abre <a class="smallLink" href="../explorer-temas/">Temas</a> y <a class="smallLink" href="../explorer/">Explorer SQL</a>.</div>`;
          if (state.prefsLoadedFrom === "hash") {
            banner += `<div style="margin-top:8px"><strong>Preferencias:</strong> cargadas desde un enlace compartido y guardadas localmente en tu navegador.</div>`;
          }
          if (state.prefsLoadError) {
            banner += `<div style="margin-top:8px"><strong>Aviso prefs:</strong> <span class="mono">${esc(
              String(state.prefsLoadError)
            )}</span></div>`;
          }
          if (prefsDropped) {
            banner += `<div style="margin-top:8px"><strong>Aviso prefs:</strong> se descartaron <span class="mono">${esc(
              String(prefsDropped)
            )}</span> preferencias porque esos temas no existen en este snapshot.</div>`;
          }
          setBanner(banner);
        } catch (err) {
          setBanner(`<div><strong>Error al cargar datos</strong>: <span class="mono">${esc(String(err))}</span></div>`);
          qs("#statusChips").innerHTML = `<span class="chip"><span class="dot bad"></span><span class="mono">fallo carga</span></span>`;
          qs("#concernList").innerHTML = `<div class="empty">No se pudieron cargar datos.</div>`;
          qs("#topicList").innerHTML = `<div class="empty">No se pudieron cargar datos.</div>`;
          qs("#compare").innerHTML = `<div class="empty">No se pudieron cargar datos.</div>`;
        }
      }

      function wire() {
        qs("#btnClear")?.addEventListener("click", () => {
          qs("#concernSearch").value = "";
          qs("#topicSearch").value = "";
          state.activeTopicId = 0;
          state.activePartyId = 0;
          writeUrlState(true);
          renderSelectedConcernTags();
          renderConcernList();
          renderTopicList();
          renderCompare();
        });

        qs("#btnResetSelected")?.addEventListener("click", () => {
          const keep = String(state.activeConcernId || "").trim();
          state.selectedConcernIds = keep ? [keep] : [];
          state.viewMode = "detail";
          state.activeTopicId = 0;
          const viewSel = qs("#viewMode");
          if (viewSel) viewSel.value = "detail";
          writeUrlState(true);
          renderSelectedConcernTags();
          renderConcernList();
          renderTopicList();
          renderCompare();
        });

        qs("#btnPartyFocusClear")?.addEventListener("click", () => {
          clearPartyFocus();
        });

        qs("#viewMode")?.addEventListener("change", () => {
          const v = String(qs("#viewMode")?.value || "detail");
          state.viewMode = v === "dashboard" || v === "alignment" || v === "coherence" ? v : "detail";
          writeUrlState(true);
          ensureConcernState(); // keep method toggle disable/enable consistent with view mode
          renderTopicList(); // view affects topic chips (alignment/coherence)
          renderCompare();
        });

        qs("#methodSelect")?.addEventListener("change", () => {
          const sel = qs("#methodSelect");
          if (!sel || sel.disabled) return;
          const next = String(sel.value || "").trim();
          if (!next) return;

          // Ensure method toggle isn't blocked by a custom dataset override.
          const p = new URLSearchParams(location.search || "");
          if (p.has("citizen")) {
            p.delete("citizen");
            history.replaceState({}, "", `?${p.toString()}`);
          }

          state.method = next;
          writeUrlState(true);
          // Reload so we fetch the method-specific dataset file.
          location.reload();
        });

        qs("#concernSearch")?.addEventListener("input", () => {
          renderConcernList();
        });

        qs("#topicSearch")?.addEventListener("input", () => {
          renderTopicList();
        });

        qs("#topicLimit")?.addEventListener("change", () => {
          renderTopicList();
        });

        qs("#stanceFilter")?.addEventListener("change", () => {
          renderCompare();
        });

        qs("#partySort")?.addEventListener("change", () => {
          renderCompare();
        });

        window.addEventListener("popstate", () => {
          state.activeConcernId = "";
          state.activeTopicId = 0;
          state.activePartyId = 0;
          state.selectedConcernIds = [];
          state.viewMode = "detail";
          state.method = "";
          readUrlState();
          ensureConcernState();
          renderSelectedConcernTags();
          renderConcernList();
          renderTopicList();
          renderCompare();
        });
      }

      wire();
      load();
    </script>
  </body>
</html>
