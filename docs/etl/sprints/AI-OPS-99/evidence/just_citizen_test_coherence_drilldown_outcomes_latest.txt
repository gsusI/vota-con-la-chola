python3 -m unittest tests/test_report_citizen_coherence_drilldown_outcomes.py tests/test_report_citizen_coherence_drilldown_outcomes_heartbeat.py tests/test_report_citizen_coherence_drilldown_outcomes_heartbeat_window.py
...{
  "generated_at": "2026-02-23T14:44:01+00:00",
  "status": "degraded",
  "paths": {
    "events_jsonl": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmpc_xolggs/events.jsonl"
  },
  "telemetry": {
    "events_total": 0,
    "recognized_events_total": 0,
    "ignored_events_total": 0,
    "parse_errors": 0,
    "sessions_total": 0,
    "click_sessions_total": 0,
    "replay_success_sessions_total": 0,
    "replay_failure_sessions_total": 0
  },
  "metrics": {
    "drilldown_click_events_total": 0,
    "replay_attempt_events_total": 0,
    "replay_success_events_total": 0,
    "replay_failure_events_total": 0,
    "contract_complete_click_events_total": 0,
    "replay_success_rate": null,
    "replay_failure_rate": null,
    "contract_complete_click_rate": null
  },
  "thresholds": {
    "min_drilldown_click_events": 8,
    "min_replay_attempt_events": 8,
    "min_replay_success_rate": 0.85,
    "min_contract_complete_click_rate": 0.9,
    "max_replay_failure_rate": 0.15
  },
  "checks": {
    "telemetry_available": false,
    "drilldown_click_events_meet_minimum": false,
    "replay_attempt_events_meet_minimum": false,
    "replay_success_rate_meets_minimum": null,
    "contract_complete_click_rate_meets_minimum": null,
    "replay_failure_rate_within_threshold": null,
    "contract_complete": false
  },
  "degraded_reasons": [
    "drilldown_click_events_below_minimum",
    "replay_attempt_events_below_minimum",
    "telemetry_missing"
  ],
  "failure_reasons": [],
  "by_bucket": []
}
{
  "generated_at": "2026-02-23T14:44:01+00:00",
  "status": "ok",
  "paths": {
    "events_jsonl": "/Users/jesus/Library/CloudStorage/GoogleDrive-gsus123456@gmail.com/My Drive/CdC/Obsidian Vault/vota-con-la-chola/tests/fixtures/citizen_coherence_drilldown_events_sample.jsonl"
  },
  "telemetry": {
    "events_total": 22,
    "recognized_events_total": 20,
    "ignored_events_total": 1,
    "parse_errors": 1,
    "sessions_total": 5,
    "click_sessions_total": 5,
    "replay_success_sessions_total": 5,
    "replay_failure_sessions_total": 1
  },
  "metrics": {
    "drilldown_click_events_total": 10,
    "replay_attempt_events_total": 10,
    "replay_success_events_total": 9,
    "replay_failure_events_total": 1,
    "contract_complete_click_events_total": 9,
    "replay_success_rate": 0.9,
    "replay_failure_rate": 0.1,
    "contract_complete_click_rate": 0.9
  },
  "thresholds": {
    "min_drilldown_click_events": 8,
    "min_replay_attempt_events": 8,
    "min_replay_success_rate": 0.85,
    "min_contract_complete_click_rate": 0.9,
    "max_replay_failure_rate": 0.15
  },
  "checks": {
    "telemetry_available": true,
    "drilldown_click_events_meet_minimum": true,
    "replay_attempt_events_meet_minimum": true,
    "replay_success_rate_meets_minimum": true,
    "contract_complete_click_rate_meets_minimum": true,
    "replay_failure_rate_within_threshold": true,
    "contract_complete": true
  },
  "degraded_reasons": [],
  "failure_reasons": [],
  "by_bucket": [
    {
      "bucket": "coherent",
      "click_events_total": 5
    },
    {
      "bucket": "incoherent",
      "click_events_total": 5
    }
  ]
}
{
  "generated_at": "2026-02-23T14:44:01+00:00",
  "status": "failed",
  "paths": {
    "events_jsonl": "/Users/jesus/Library/CloudStorage/GoogleDrive-gsus123456@gmail.com/My Drive/CdC/Obsidian Vault/vota-con-la-chola/tests/fixtures/citizen_coherence_drilldown_events_sample.jsonl"
  },
  "telemetry": {
    "events_total": 22,
    "recognized_events_total": 20,
    "ignored_events_total": 1,
    "parse_errors": 1,
    "sessions_total": 5,
    "click_sessions_total": 5,
    "replay_success_sessions_total": 5,
    "replay_failure_sessions_total": 1
  },
  "metrics": {
    "drilldown_click_events_total": 10,
    "replay_attempt_events_total": 10,
    "replay_success_events_total": 9,
    "replay_failure_events_total": 1,
    "contract_complete_click_events_total": 9,
    "replay_success_rate": 0.9,
    "replay_failure_rate": 0.1,
    "contract_complete_click_rate": 0.9
  },
  "thresholds": {
    "min_drilldown_click_events": 8,
    "min_replay_attempt_events": 8,
    "min_replay_success_rate": 0.85,
    "min_contract_complete_click_rate": 0.95,
    "max_replay_failure_rate": 0.15
  },
  "checks": {
    "telemetry_available": true,
    "drilldown_click_events_meet_minimum": true,
    "replay_attempt_events_meet_minimum": true,
    "replay_success_rate_meets_minimum": true,
    "contract_complete_click_rate_meets_minimum": false,
    "replay_failure_rate_within_threshold": true,
    "contract_complete": false
  },
  "degraded_reasons": [],
  "failure_reasons": [
    "contract_complete_click_rate_below_threshold"
  ],
  "by_bucket": [
    {
      "bucket": "coherent",
      "click_events_total": 5
    },
    {
      "bucket": "incoherent",
      "click_events_total": 5
    }
  ]
}
{
  "generated_at": "2026-02-23T14:44:01+00:00",
  "strict": true,
  "input_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmp6jf_0anj/digest_ok.json",
  "heartbeat_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmp6jf_0anj/heartbeat.jsonl",
  "history_size_before": 0,
  "history_size_after": 1,
  "history_malformed_lines_before": 0,
  "appended": true,
  "duplicate_detected": false,
  "validation_errors": [],
  "strict_fail_reasons": [],
  "heartbeat": {
    "run_at": "2026-02-23T17:00:00+00:00",
    "heartbeat_id": "2026-02-23T17:00:00+00:00|ok|2026-02-23T17:00:00+00:00|10|10|9|1|9|0.900000|0.100000|0.900000|0.850000|0.900000|0.150000|1||",
    "digest_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmp6jf_0anj/digest_ok.json",
    "digest_generated_at": "2026-02-23T17:00:00+00:00",
    "status": "ok",
    "drilldown_click_events_total": 10,
    "replay_attempt_events_total": 10,
    "replay_success_events_total": 9,
    "replay_failure_events_total": 1,
    "contract_complete_click_events_total": 9,
    "replay_success_rate": 0.9,
    "replay_failure_rate": 0.1,
    "contract_complete_click_rate": 0.9,
    "min_drilldown_click_events": 8,
    "min_replay_attempt_events": 8,
    "min_replay_success_rate": 0.85,
    "min_contract_complete_click_rate": 0.9,
    "max_replay_failure_rate": 0.15,
    "replay_success_rate_meets_minimum": true,
    "contract_complete_click_rate_meets_minimum": true,
    "replay_failure_rate_within_threshold": true,
    "telemetry_available": true,
    "contract_complete": true,
    "degraded_reasons": [],
    "failure_reasons": [],
    "strict_fail_count": 0,
    "strict_fail_reasons": []
  },
  "status": "ok"
}
{
  "generated_at": "2026-02-23T14:44:01+00:00",
  "strict": true,
  "input_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmp6jf_0anj/digest_ok.json",
  "heartbeat_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmp6jf_0anj/heartbeat.jsonl",
  "history_size_before": 1,
  "history_size_after": 1,
  "history_malformed_lines_before": 0,
  "appended": false,
  "duplicate_detected": true,
  "validation_errors": [],
  "strict_fail_reasons": [],
  "heartbeat": {
    "run_at": "2026-02-23T17:00:00+00:00",
    "heartbeat_id": "2026-02-23T17:00:00+00:00|ok|2026-02-23T17:00:00+00:00|10|10|9|1|9|0.900000|0.100000|0.900000|0.850000|0.900000|0.150000|1||",
    "digest_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmp6jf_0anj/digest_ok.json",
    "digest_generated_at": "2026-02-23T17:00:00+00:00",
    "status": "ok",
    "drilldown_click_events_total": 10,
    "replay_attempt_events_total": 10,
    "replay_success_events_total": 9,
    "replay_failure_events_total": 1,
    "contract_complete_click_events_total": 9,
    "replay_success_rate": 0.9,
    "replay_failure_rate": 0.1,
    "contract_complete_click_rate": 0.9,
    "min_drilldown_click_events": 8,
    "min_replay_attempt_events": 8,
    "min_replay_success_rate": 0.85,
    "min_contract_complete_click_rate": 0.9,
    "max_replay_failure_rate": 0.15,
    "replay_success_rate_meets_minimum": true,
    "contract_complete_click_rate_meets_minimum": true,
    "replay_failure_rate_within_threshold": true,
    "telemetry_available": true,
    "contract_complete": true,
    "degraded_reasons": [],
    "failure_reasons": [],
    "strict_fail_count": 0,
    "strict_fail_reasons": []
  },
  "status": "ok"
}....
{
  "generated_at": "2026-02-23T14:44:01+00:00",
  "strict": true,
  "input_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmp0c1vdk09/digest_degraded.json",
  "heartbeat_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmp0c1vdk09/heartbeat.jsonl",
  "history_size_before": 0,
  "history_size_after": 1,
  "history_malformed_lines_before": 0,
  "appended": true,
  "duplicate_detected": false,
  "validation_errors": [],
  "strict_fail_reasons": [],
  "heartbeat": {
    "run_at": "2026-02-23T17:00:00+00:00",
    "heartbeat_id": "2026-02-23T17:00:00+00:00|degraded|2026-02-23T17:00:00+00:00|10|10|9|1|7|0.900000|0.100000|0.700000|0.850000|0.900000|0.150000|0||contract_complete_click_rate_below_minimum",
    "digest_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmp0c1vdk09/digest_degraded.json",
    "digest_generated_at": "2026-02-23T17:00:00+00:00",
    "status": "degraded",
    "drilldown_click_events_total": 10,
    "replay_attempt_events_total": 10,
    "replay_success_events_total": 9,
    "replay_failure_events_total": 1,
    "contract_complete_click_events_total": 7,
    "replay_success_rate": 0.9,
    "replay_failure_rate": 0.1,
    "contract_complete_click_rate": 0.7,
    "min_drilldown_click_events": 8,
    "min_replay_attempt_events": 8,
    "min_replay_success_rate": 0.85,
    "min_contract_complete_click_rate": 0.9,
    "max_replay_failure_rate": 0.15,
    "replay_success_rate_meets_minimum": true,
    "contract_complete_click_rate_meets_minimum": false,
    "replay_failure_rate_within_threshold": true,
    "telemetry_available": true,
    "contract_complete": false,
    "degraded_reasons": [
      "contract_complete_click_rate_below_minimum"
    ],
    "failure_reasons": [],
    "strict_fail_count": 0,
    "strict_fail_reasons": []
  },
  "status": "degraded"
}
{
  "generated_at": "2026-02-23T14:44:01+00:00",
  "strict": true,
  "input_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmpcv7ee4dx/digest_failed.json",
  "heartbeat_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmpcv7ee4dx/heartbeat.jsonl",
  "history_size_before": 0,
  "history_size_after": 1,
  "history_malformed_lines_before": 0,
  "appended": true,
  "duplicate_detected": false,
  "validation_errors": [],
  "strict_fail_reasons": [
    "heartbeat_status_failed",
    "replay_success_rate_below_threshold",
    "replay_failure_rate_above_threshold"
  ],
  "heartbeat": {
    "run_at": "2026-02-23T17:00:00+00:00",
    "heartbeat_id": "2026-02-23T17:00:00+00:00|failed|2026-02-23T17:00:00+00:00|10|10|7|3|9|0.700000|0.300000|0.900000|0.850000|0.900000|0.150000|0|replay_success_rate_below_threshold,replay_failure_rate_above_threshold|",
    "digest_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmpcv7ee4dx/digest_failed.json",
    "digest_generated_at": "2026-02-23T17:00:00+00:00",
    "status": "failed",
    "drilldown_click_events_total": 10,
    "replay_attempt_events_total": 10,
    "replay_success_events_total": 7,
    "replay_failure_events_total": 3,
    "contract_complete_click_events_total": 9,
    "replay_success_rate": 0.7,
    "replay_failure_rate": 0.3,
    "contract_complete_click_rate": 0.9,
    "min_drilldown_click_events": 8,
    "min_replay_attempt_events": 8,
    "min_replay_success_rate": 0.85,
    "min_contract_complete_click_rate": 0.9,
    "max_replay_failure_rate": 0.15,
    "replay_success_rate_meets_minimum": false,
    "contract_complete_click_rate_meets_minimum": true,
    "replay_failure_rate_within_threshold": false,
    "telemetry_available": true,
    "contract_complete": false,
    "degraded_reasons": [],
    "failure_reasons": [
      "replay_success_rate_below_threshold",
      "replay_failure_rate_above_threshold"
    ],
    "strict_fail_count": 2,
    "strict_fail_reasons": [
      "replay_success_rate_below_threshold",
      "replay_failure_rate_above_threshold"
    ]
  },
  "status": "failed"
}
{
  "generated_at": "2026-02-23T14:44:01+00:00",
  "strict": true,
  "heartbeat_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmpkoxd8qci/heartbeat.jsonl",
  "window_last": 2,
  "thresholds": {
    "max_failed": 0,
    "max_failed_rate_pct": 0.0,
    "max_degraded": 0,
    "max_degraded_rate_pct": 0.0,
    "max_contract_incomplete": 0,
    "max_contract_incomplete_rate_pct": 0.0,
    "max_replay_success_rate_violations": 0,
    "max_replay_success_rate_violation_rate_pct": 0.0,
    "max_contract_click_rate_violations": 0,
    "max_contract_click_rate_violation_rate_pct": 0.0,
    "max_replay_failure_rate_violations": 0,
    "max_replay_failure_rate_violation_rate_pct": 0.0
  },
  "entries_total": 2,
  "entries_in_window": 2,
  "malformed_entries_in_window": 0,
  "status_counts": {
    "ok": 1,
    "degraded": 1,
    "failed": 0
  },
  "failed_in_window": 0,
  "failed_rate_pct": 0.0,
  "degraded_in_window": 1,
  "degraded_rate_pct": 50.0,
  "contract_incomplete_in_window": 1,
  "contract_incomplete_rate_pct": 50.0,
  "replay_success_rate_violations_in_window": 1,
  "replay_success_rate_violation_rate_pct": 50.0,
  "contract_click_rate_violations_in_window": 1,
  "contract_click_rate_violation_rate_pct": 50.0,
  "replay_failure_rate_violations_in_window": 1,
  "replay_failure_rate_violation_rate_pct": 50.0,
  "first_failed_run_at": "",
  "last_failed_run_at": "",
  "first_degraded_run_at": "2026-02-23T17:02:00+00:00",
  "last_degraded_run_at": "2026-02-23T17:02:00+00:00",
  "first_contract_incomplete_run_at": "2026-02-23T17:02:00+00:00",
  "last_contract_incomplete_run_at": "2026-02-23T17:02:00+00:00",
  "latest": {
    "run_at": "2026-02-23T17:02:00+00:00",
    "heartbeat_id": "2026-02-23T17:02:00+00:00|degraded|2",
    "status": "degraded",
    "line_no": 2,
    "malformed_line": false,
    "digest_generated_at": "2026-02-23T17:02:00+00:00",
    "replay_success_rate": 0.9,
    "replay_failure_rate": 0.1,
    "contract_complete_click_rate": 0.9,
    "contract_complete": false,
    "replay_success_rate_meets_minimum": false,
    "contract_complete_click_rate_meets_minimum": false,
    "replay_failure_rate_within_threshold": false
  },
  "failed_streak_latest": 0,
  "degraded_streak_latest": 1,
  "checks": {
    "window_nonempty_ok": true,
    "malformed_entries_ok": true,
    "max_failed_ok": true,
    "max_failed_rate_ok": true,
    "max_degraded_ok": false,
    "max_degraded_rate_ok": false,
    "max_contract_incomplete_ok": false,
    "max_contract_incomplete_rate_ok": false,
    "max_replay_success_rate_violations_ok": false,
    "max_replay_success_rate_violation_rate_ok": false,
    "max_contract_click_rate_violations_ok": false,
    "max_contract_click_rate_violation_rate_ok": false,
    "max_replay_failure_rate_violations_ok": false,
    "max_replay_failure_rate_violation_rate_ok": false,
    "latest_not_failed_ok": true,
    "latest_contract_complete_ok": false,
    "latest_thresholds_ok": false
  },
  "strict_fail_reasons": [
    "max_degraded_exceeded",
    "max_degraded_rate_exceeded",
    "max_contract_incomplete_exceeded",
    "max_contract_incomplete_rate_exceeded",
    "max_replay_success_rate_violations_exceeded",
    "max_replay_success_rate_violation_rate_exceeded",
    "max_contract_click_rate_violations_exceeded",
    "max_contract_click_rate_violation_rate_exceeded",
    "max_replay_failure_rate_violations_exceeded",
    "max_replay_failure_rate_violation_rate_exceeded",
    "latest_contract_incomplete",
    "latest_threshold_violation"
  ],
  "status": "failed"
}
{
  "generated_at": "2026-02-23T14:44:01+00:00",
  "strict": true,
  "heartbeat_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmpsmmshbvz/heartbeat.jsonl",
  "window_last": 3,
  "thresholds": {
    "max_failed": 0,
    "max_failed_rate_pct": 0.0,
    "max_degraded": 0,
    "max_degraded_rate_pct": 0.0,
    "max_contract_incomplete": 0,
    "max_contract_incomplete_rate_pct": 0.0,
    "max_replay_success_rate_violations": 0,
    "max_replay_success_rate_violation_rate_pct": 0.0,
    "max_contract_click_rate_violations": 0,
    "max_contract_click_rate_violation_rate_pct": 0.0,
    "max_replay_failure_rate_violations": 0,
    "max_replay_failure_rate_violation_rate_pct": 0.0
  },
  "entries_total": 3,
  "entries_in_window": 3,
  "malformed_entries_in_window": 0,
  "status_counts": {
    "ok": 3,
    "degraded": 0,
    "failed": 0
  },
  "failed_in_window": 0,
  "failed_rate_pct": 0.0,
  "degraded_in_window": 0,
  "degraded_rate_pct": 0.0,
  "contract_incomplete_in_window": 0,
  "contract_incomplete_rate_pct": 0.0,
  "replay_success_rate_violations_in_window": 0,
  "replay_success_rate_violation_rate_pct": 0.0,
  "contract_click_rate_violations_in_window": 0,
  "contract_click_rate_violation_rate_pct": 0.0,
  "replay_failure_rate_violations_in_window": 0,
  "replay_failure_rate_violation_rate_pct": 0.0,
  "first_failed_run_at": "",
  "last_failed_run_at": "",
  "first_degraded_run_at": "",
  "last_degraded_run_at": "",
  "first_contract_incomplete_run_at": "",
  "last_contract_incomplete_run_at": "",
  "latest": {
    "run_at": "2026-02-23T17:03:00+00:00",
    "heartbeat_id": "2026-02-23T17:03:00+00:00|ok|3",
    "status": "ok",
    "line_no": 3,
    "malformed_line": false,
    "digest_generated_at": "2026-02-23T17:03:00+00:00",
    "replay_success_rate": 0.9,
    "replay_failure_rate": 0.1,
    "contract_complete_click_rate": 0.9,
    "contract_complete": true,
    "replay_success_rate_meets_minimum": true,
    "contract_complete_click_rate_meets_minimum": true,
    "replay_failure_rate_within_threshold": true
  },
  "failed_streak_latest": 0,
  "degraded_streak_latest": 0,
  "checks": {
    "window_nonempty_ok": true,
    "malformed_entries_ok": true,
    "max_failed_ok": true,
    "max_failed_rate_ok": true,
    "max_degraded_ok": true,
    "max_degraded_rate_ok": true,
    "max_contract_incomplete_ok": true,
    "max_contract_incomplete_rate_ok": true,
    "max_replay_success_rate_violations_ok": true,
    "max_replay_success_rate_violation_rate_ok": true,
    "max_contract_click_rate_violations_ok": true,
    "max_contract_click_rate_violation_rate_ok": true,
    "max_replay_failure_rate_violations_ok": true,
    "max_replay_failure_rate_violation_rate_ok": true,
    "latest_not_failed_ok": true,
    "latest_contract_complete_ok": true,
    "latest_thresholds_ok": true
  },
  "strict_fail_reasons": [],
  "status": "ok"
}..
----------------------------------------------------------------------
Ran 9 tests in 0.012s

OK

{"error": "window_last must be >= 1"}
