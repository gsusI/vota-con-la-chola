python3 -m unittest tests/test_report_citizen_release_trace_digest_heartbeat.py tests/test_report_citizen_release_trace_digest_heartbeat_window.py tests/test_report_citizen_release_trace_digest_heartbeat_compaction.py tests/test_report_citizen_release_trace_digest_heartbeat_compaction_window.py
....{
  "generated_at": "2026-02-23T15:17:32+00:00",
  "strict": true,
  "input_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmp2rpqtk6t/release_trace_digest_ok.json",
  "heartbeat_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmp2rpqtk6t/heartbeat.jsonl",
  "history_size_before": 0,
  "history_size_after": 1,
  "history_malformed_lines_before": 0,
  "appended": true,
  "duplicate_detected": false,
  "validation_errors": [],
  "strict_fail_reasons": [],
  "heartbeat": {
    "run_at": "2026-02-23T14:00:00+00:00",
    "heartbeat_id": "2026-02-23T14:00:00+00:00|ok|2026-02-23T13:55:00+00:00|5.000000|360.000000|1|1|0|0|",
    "digest_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmp2rpqtk6t/release_trace_digest_ok.json",
    "digest_generated_at": "2026-02-23T14:00:00+00:00",
    "release_generated_at": "2026-02-23T13:55:00+00:00",
    "status": "ok",
    "release_age_minutes": 5.0,
    "max_age_minutes": 360.0,
    "freshness_within_sla": true,
    "stale_detected": false,
    "release_ready": true,
    "release_total_fail": 0,
    "release_failed_ids_total": 0,
    "parity_ok_assets": 9,
    "parity_total_assets": 9,
    "contract_complete": true,
    "degraded_reasons": [],
    "failure_reasons": [],
    "strict_fail_count": 0,
    "strict_fail_reasons": []
  },
  "status": "ok"
}
{
  "generated_at": "2026-02-23T15:17:32+00:00",
  "strict": true,
  "input_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmp2rpqtk6t/release_trace_digest_ok.json",
  "heartbeat_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmp2rpqtk6t/heartbeat.jsonl",
  "history_size_before": 1,
  "history_size_after": 1,
  "history_malformed_lines_before": 0,
  "appended": false,
  "duplicate_detected": true,
  "validation_errors": [],
  "strict_fail_reasons": [],
  "heartbeat": {
    "run_at": "2026-02-23T14:00:00+00:00",
    "heartbeat_id": "2026-02-23T14:00:00+00:00|ok|2026-02-23T13:55:00+00:00|5.000000|360.000000|1|1|0|0|",
    "digest_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmp2rpqtk6t/release_trace_digest_ok.json",
    "digest_generated_at": "2026-02-23T14:00:00+00:00",
    "release_generated_at": "2026-02-23T13:55:00+00:00",
    "status": "ok",
    "release_age_minutes": 5.0,
    "max_age_minutes": 360.0,
    "freshness_within_sla": true,
    "stale_detected": false,
    "release_ready": true,
    "release_total_fail": 0,
    "release_failed_ids_total": 0,
    "parity_ok_assets": 9,
    "parity_total_assets": 9,
    "contract_complete": true,
    "degraded_reasons": [],
    "failure_reasons": [],
    "strict_fail_count": 0,
    "strict_fail_reasons": []
  },
  "status": "ok"
}
{
  "generated_at": "2026-02-23T15:17:32+00:00",
  "strict": true,
  "input_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmpozz6_c0u/release_trace_digest_stale.json",
  "heartbeat_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmpozz6_c0u/heartbeat.jsonl",
  "history_size_before": 0,
  "history_size_after": 1,
  "history_malformed_lines_before": 0,
  "appended": true,
  "duplicate_detected": false,
  "validation_errors": [],
  "strict_fail_reasons": [],
  "heartbeat": {
    "run_at": "2026-02-23T14:00:00+00:00",
    "heartbeat_id": "2026-02-23T14:00:00+00:00|degraded|2026-02-23T13:55:00+00:00|900.000000|360.000000|0|1|0|1|",
    "digest_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmpozz6_c0u/release_trace_digest_stale.json",
    "digest_generated_at": "2026-02-23T14:00:00+00:00",
    "release_generated_at": "2026-02-23T13:55:00+00:00",
    "status": "degraded",
    "release_age_minutes": 900.0,
    "max_age_minutes": 360.0,
    "freshness_within_sla": false,
    "stale_detected": true,
    "release_ready": true,
    "release_total_fail": 0,
    "release_failed_ids_total": 0,
    "parity_ok_assets": 9,
    "parity_total_assets": 9,
    "contract_complete": false,
    "degraded_reasons": [
      "release_trace_stale"
    ],
    "failure_reasons": [],
    "strict_fail_count": 0,
    "strict_fail_reasons": []
  },
  "status": "degraded"
}
{
  "generated_at": "2026-02-23T15:17:32+00:00",
  "strict": true,
  "input_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmpjz3rz1oq/release_trace_digest_failed.json",
  "heartbeat_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmpjz3rz1oq/heartbeat.jsonl",
  "history_size_before": 0,
  "history_size_after": 1,
  "history_malformed_lines_before": 0,
  "appended": true,
  "duplicate_detected": false,
  "validation_errors": [],
  "strict_fail_reasons": [
    "heartbeat_status_failed",
    "release_not_ready",
    "release_failures_present"
  ],
  "heartbeat": {
    "run_at": "2026-02-23T14:00:00+00:00",
    "heartbeat_id": "2026-02-23T14:00:00+00:00|failed|2026-02-23T13:55:00+00:00|5.000000|360.000000|1|0|1|0|release_not_ready,release_failures_present",
    "digest_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmpjz3rz1oq/release_trace_digest_failed.json",
    "digest_generated_at": "2026-02-23T14:00:00+00:00",
    "release_generated_at": "2026-02-23T13:55:00+00:00",
    "status": "failed",
    "release_age_minutes": 5.0,
    "max_age_minutes": 360.0,
    "freshness_within_sla": true,
    "stale_detected": false,
    "release_ready": false,
    "release_total_fail": 1,
    "release_failed_ids_total": 1,
    "parity_ok_assets": 8,
    "parity_total_assets": 9,
    "contract_complete": false,
    "degraded_reasons": [],
    "failure_reasons": [
      "release_not_ready",
      "release_failures_present"
    ],
    "strict_fail_count": 2,
    "strict_fail_reasons": [
      "release_not_ready",
      "release_failures_present"
    ]
  },
  "status": "failed"
}
{
  "generated_at": "2026-02-23T15:17:32+00:00",
  "strict": true,
  "heartbeat_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmph667xfms/heartbeat.jsonl",
  "window_last": 2,
  "thresholds": {
    "max_failed": 0,
    "max_failed_rate_pct": 0.0,
    "max_degraded": 0,
    "max_degraded_rate_pct": 0.0,
    "max_stale": 0,
    "max_stale_rate_pct": 0.0
  },
  "entries_total": 2,
  "entries_in_window": 2,
  "malformed_entries_in_window": 0,
  "status_counts": {
    "ok": 1,
    "degraded": 1,
    "failed": 0
  },
  "failed_in_window": 0,
  "failed_rate_pct": 0.0,
  "degraded_in_window": 1,
  "degraded_rate_pct": 50.0,
  "stale_in_window": 1,
  "stale_rate_pct": 50.0,
  "first_failed_run_at": "",
  "last_failed_run_at": "",
  "first_degraded_run_at": "2026-02-23T14:02:00+00:00",
  "last_degraded_run_at": "2026-02-23T14:02:00+00:00",
  "first_stale_run_at": "2026-02-23T14:02:00+00:00",
  "last_stale_run_at": "2026-02-23T14:02:00+00:00",
  "latest": {
    "run_at": "2026-02-23T14:02:00+00:00",
    "heartbeat_id": "2026-02-23T14:02:00+00:00|degraded|2",
    "status": "degraded",
    "line_no": 2,
    "malformed_line": false,
    "release_generated_at": "2026-02-23T13:55:00+00:00",
    "release_age_minutes": 900.0,
    "max_age_minutes": 360.0,
    "freshness_within_sla": false,
    "stale_detected": true,
    "release_ready": true,
    "release_total_fail": 0
  },
  "failed_streak_latest": 0,
  "degraded_streak_latest": 1,
  "checks": {
    "window_nonempty_ok": true,
    "malformed_entries_ok": true,
    "max_failed_ok": true,
    "max_failed_rate_ok": true,
    "max_degraded_ok": false,
    "max_degraded_rate_ok": false,
    "max_stale_ok": false,
    "max_stale_rate_ok": false,
    "latest_not_failed_ok": true,
    "latest_freshness_within_sla_ok": false
  },
  "strict_fail_reasons": [
    "max_degraded_exceeded",
    "max_degraded_rate_exceeded",
    "max_stale_exceeded",
    "max_stale_rate_exceeded",
    "latest_release_trace_stale"
  ],
  "status": "failed"
}
{
  "generated_at": "2026-02-23T15:17:32+00:00",
  "strict": true,
  "heartbeat_path": "/var/folders/mq/m2lss7dj6gjg_kzf2_zpls500000gn/T/tmp4nu_hj68/heartbeat.jsonl",
  "window_last": 3,
  "thresholds": {
    "max_failed": 0,
    "max_failed_rate_pct": 0.0,
    "max_degraded": 0,
    "max_degraded_rate_pct": 0.0,
    "max_stale": 0,
    "max_stale_rate_pct": 0.0
  },
  "entries_total": 3,
  "entries_in_window": 3,
  "malformed_entries_in_window": 0,
  "status_counts": {
    "ok": 3,
    "degraded": 0,
    "failed": 0
  },
  "failed_in_window": 0,
  "failed_rate_pct": 0.0,
  "degraded_in_window": 0,
  "degraded_rate_pct": 0.0,
  "stale_in_window": 0,
  "stale_rate_pct": 0.0,
  "first_failed_run_at": "",
  "last_failed_run_at": "",
  "first_degraded_run_at": "",
  "last_degraded_run_at": "",
  "first_stale_run_at": "",
  "last_stale_run_at": "",
  "latest": {
    "run_at": "2026-02-23T14:03:00+00:00",
    "heartbeat_id": "2026-02-23T14:03:00+00:00|ok|3",
    "status": "ok",
    "line_no": 3,
    "malformed_line": false,
    "release_generated_at": "2026-02-23T13:55:00+00:00",
    "release_age_minutes": 30.0,
    "max_age_minutes": 360.0,
    "freshness_within_sla": true,
    "stale_detected": false,
    "release_ready": true,
    "release_total_fail": 0
  },
  "failed_streak_latest": 0,
  "degraded_streak_latest": 0,
  "checks": {
    "window_nonempty_ok": true,
    "malformed_entries_ok": true,
    "max_failed_ok": true,
    "max_failed_rate_ok": true,
    "max_degraded_ok": true,
    "max_degraded_rate_ok": true,
    "max_stale_ok": true,
    "max_stale_rate_ok": true,
    "latest_not_failed_ok": true,
    "latest_freshness_within_sla_ok": true
  },
  "strict_fail_reasons": [],
  "status": "ok"
}.......
----------------------------------------------------------------------
Ran 11 tests in 0.018s

OK

{"error": "window_last must be >= 1"}
